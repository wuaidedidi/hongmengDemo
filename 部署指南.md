# 后端服务器部署指南

## 概述

本指南将帮助您将Daily App后端服务部署到服务器（IP: 8.148.20.194），并配置前端应用以支持本地和服务器两套环境。

## 前期准备

### 服务器要求
- 操作系统: Linux (CentOS/Ubuntu/Debian)
- Java: 17或更高版本
- 内存: 至少512MB可用内存
- 磁盘: 至少1GB可用空间
- 网络: 开放8080端口

### 本地环境要求
- Java 17+
- Maven 3.6+
- PowerShell (Windows)

## 部署步骤

### 1. 构建应用

在项目根目录执行以下命令：

```powershell
# 仅构建JAR包
.\deploy_server.ps1 -BuildOnly
```

或者手动构建：

```powershell
cd serverDemo
mvn clean package -Dspring.profiles.active=prod -DskipTests
```

### 2. 准备部署包

运行部署脚本创建完整的部署包：

```powershell
.\deploy_server.ps1 -BuildOnly
```

这将在 `serverDemo/deploy_package` 目录下创建以下文件：
- `app.jar` - 应用程序
- `start.sh` - 启动脚本
- `dailyapp.service` - systemd服务文件
- `部署说明.md` - 详细部署说明

### 3. 上传到服务器

将部署包上传到服务器：

```bash
# 创建部署目录
ssh root@8.148.20.194 'mkdir -p /opt/dailyapp'

# 上传文件
scp -r serverDemo/deploy_package/* root@8.148.20.194:/opt/dailyapp/
```

### 4. 服务器配置

登录服务器进行配置：

```bash
ssh root@8.148.20.194

# 设置权限
cd /opt/dailyapp
chmod +x start.sh
chmod 644 dailyapp.service

# 安装systemd服务（推荐）
cp dailyapp.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable dailyapp
```

### 5. 启动服务

#### 方式1: 使用systemd（推荐）

```bash
# 启动服务
systemctl start dailyapp

# 检查状态
systemctl status dailyapp

# 查看日志
journalctl -u dailyapp -f
```

#### 方式2: 使用启动脚本

```bash
cd /opt/dailyapp

# 启动
./start.sh start

# 检查状态
./start.sh status

# 查看日志
tail -f app.log
```

### 6. 防火墙配置

确保服务器防火墙允许8080端口：

#### CentOS/RHEL:
```bash
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
```

#### Ubuntu/Debian:
```bash
ufw allow 8080
```

### 7. 验证部署

运行测试脚本验证部署：

```powershell
# 在本地运行
.\test_server_api.ps1
```

或手动测试：

```bash
# 测试API连接
curl http://8.148.20.194:8080/api/auth/register -X POST -H "Content-Type: application/json" -d '{"username":"test","password":"123456"}'
```

## 前端配置

### 环境切换功能

前端应用已支持环境切换功能：

1. **打开应用**
2. **进入个人页面** → **环境设置**
3. **选择服务器环境**
4. **重启应用**使配置生效

### 环境配置说明

- **本地环境**: `http://10.0.2.2:8080/api` (用于开发调试)
- **服务器环境**: `http://8.148.20.194:8080/api` (用于生产使用)

### 手动配置（开发者）

如需修改环境配置，编辑文件：
`entry/src/main/ets/config/Environment.ets`

```typescript
export const ENVIRONMENTS: { [key: string]: EnvironmentConfig } = {
  local: {
    name: 'local',
    baseUrl: 'http://10.0.2.2:8080/api',
    description: '本地开发环境'
  },
  server: {
    name: 'server',
    baseUrl: 'http://8.148.20.194:8080/api',  // 修改为您的服务器IP
    description: '服务器环境'
  }
};
```

## 服务管理

### 常用命令

```bash
# 启动服务
systemctl start dailyapp
# 或
./start.sh start

# 停止服务
systemctl stop dailyapp
# 或
./start.sh stop

# 重启服务
systemctl restart dailyapp
# 或
./start.sh restart

# 查看状态
systemctl status dailyapp
# 或
./start.sh status

# 查看日志
journalctl -u dailyapp -f
# 或
tail -f /opt/dailyapp/app.log
```

### 日志位置

- **应用日志**: `/opt/dailyapp/app.log`
- **系统日志**: `journalctl -u dailyapp`
- **数据库文件**: `/opt/dailyapp/data/dailydb.mv.db`

## 故障排除

### 常见问题

1. **端口被占用**
   ```bash
   # 检查端口占用
   netstat -tlnp | grep 8080
   # 或
   lsof -i :8080
   ```

2. **Java版本问题**
   ```bash
   # 检查Java版本
   java -version
   # 应该是17或更高版本
   ```

3. **权限问题**
   ```bash
   # 确保文件权限正确
   chmod +x /opt/dailyapp/start.sh
   chown -R root:root /opt/dailyapp
   ```

4. **防火墙问题**
   ```bash
   # 检查防火墙状态
   firewall-cmd --list-ports
   # 或
   ufw status
   ```

5. **内存不足**
   ```bash
   # 检查内存使用
   free -h
   # 如果内存不足，可以调整JVM参数
   ```

### 性能优化

如果服务器内存有限，可以在启动脚本中添加JVM参数：

```bash
# 编辑 start.sh，在java命令中添加参数
java -Xmx256m -Xms128m -jar app.jar --spring.profiles.active=prod
```

## 安全建议

1. **更改默认JWT密钥**
   - 编辑 `application-prod.properties`
   - 设置更强的 `jwt.secret`

2. **使用HTTPS**
   - 配置反向代理（Nginx/Apache）
   - 申请SSL证书

3. **数据库安全**
   - 设置数据库密码
   - 定期备份数据

4. **防火墙配置**
   - 只开放必要端口
   - 配置访问控制

## 备份与恢复

### 数据备份

```bash
# 备份数据库
cp /opt/dailyapp/data/dailydb.mv.db /backup/dailydb_$(date +%Y%m%d).mv.db

# 备份配置
tar -czf /backup/dailyapp_config_$(date +%Y%m%d).tar.gz /opt/dailyapp/*.properties /opt/dailyapp/*.sh
```

### 数据恢复

```bash
# 停止服务
systemctl stop dailyapp

# 恢复数据库
cp /backup/dailydb_20231201.mv.db /opt/dailyapp/data/dailydb.mv.db

# 启动服务
systemctl start dailyapp
```

## 联系支持

如果在部署过程中遇到问题，请检查：

1. 服务器日志: `/opt/dailyapp/app.log`
2. 系统日志: `journalctl -u dailyapp`
3. 网络连接: `telnet 8.148.20.194 8080`
4. 运行测试脚本: `./test_server_api.ps1`

---

**部署完成后，您的Daily App将同时支持本地开发和服务器生产环境！**