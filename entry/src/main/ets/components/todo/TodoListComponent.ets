// å¾…åŠäº‹é¡¹åˆ—è¡¨ç»„ä»¶ - ä»Index.etsä¸­æŠ½å–çš„å¾…åŠäº‹é¡¹åŠŸèƒ½

import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ApiService, TodoItemRequest } from '../../services/ApiService';
import type { TodoItem as ApiTodoItem } from '../../services/ApiService';
import { TodoItem } from '../../model/TodoItem';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../../services/ThemeService';
import { ThemeAwareGradientBackground, ThemeAwareGlassCard } from '../../utils/GlassmorphismStyles';
import { CommonButton, ButtonPresets } from '../common/CommonButton';
import { InputDialog } from '../dialogs/CommonDialog';
import { handleError, safeExecute } from '../../utils/ErrorHandler';
import { STRINGS, UI_SIZES, FONT_SIZES, DURATION_CONSTANTS } from '../../constants/AppConstants';
import { FocusTimerRouterParams } from '../../types/CommonTypes';

/**
 * å¾…åŠäº‹é¡¹åˆ—è¡¨ç»„ä»¶äº‹ä»¶å›è°ƒæ¥å£
 */
export interface TodoListCallbacks {
  onTodoAdded: (todo: TodoItem) => void;
  onTodoUpdated: (todo: TodoItem) => void;
  onTodoDeleted: (todoId: number) => void;
  onTodoCompleted: (todo: TodoItem) => void;
  onError: (error: string) => void;
}

/**
 * æ–°å¢å¾…åŠäº‹é¡¹å¯¹è¯æ¡†
 */
@CustomDialog
struct AddTodoDialog {
  @State todoName: string = '';
  @State todoType: string = '';
  @State todoDuration: number = DURATION_CONSTANTS.DEFAULT_TODO_DURATION;
  @Prop currentTheme: ThemeConfig;
  
  onConfirm: (name: string, type: string, duration: number) => void = () => {};
  controller?: CustomDialogController;

  build() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Column() {
        Text('âœ¨')
          .fontSize(32)
          .margin({ bottom: 8 })
        Text('æ·»åŠ æ–°å¾…åŠ')
          .fontSize(FONT_SIZES.TITLE_MEDIUM)
          .fontColor(this.currentTheme.textColor)
          .fontWeight(FontWeight.Bold)
      }
      .alignItems(HorizontalAlign.Center)
      .margin({ bottom: 24 })

      // è¾“å…¥åŒºåŸŸ
      Column({ space: 16 }) {
        TextInput({ placeholder: "å¾…åŠåç§°", text: this.todoName })
          .onChange(val => {
            this.todoName = val;
          })
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight + 'D0')
          .borderRadius(UI_SIZES.CARD_BORDER_RADIUS)
          .border({ 
            width: 0.5, 
            color: this.currentTheme.glassmorphism.accentSecondary + '50' 
          })
          .fontColor(this.currentTheme.textColor)
          .fontSize(FONT_SIZES.BODY_LARGE)
          .height(UI_SIZES.BUTTON_HEIGHT)

        TextInput({ placeholder: "å¾…åŠç±»å‹", text: this.todoType })
          .onChange(val => {
            this.todoType = val;
          })
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight + 'D0')
          .borderRadius(UI_SIZES.CARD_BORDER_RADIUS)
          .border({ 
            width: 0.5, 
            color: this.currentTheme.glassmorphism.accentSecondary + '50' 
          })
          .fontColor(this.currentTheme.textColor)
          .fontSize(FONT_SIZES.BODY_LARGE)
          .height(UI_SIZES.BUTTON_HEIGHT)

        Row() {
          Text('ä¸“æ³¨æ—¶é•¿:')
            .fontSize(FONT_SIZES.BODY_MEDIUM)
            .fontColor(this.currentTheme.textColor)
          
          Slider({
            value: this.todoDuration,
            min: 5,
            max: 120,
            step: 5
          })
            .width(120)
            .trackColor(this.currentTheme.glassmorphism.surfaceLight)
            .selectedColor(this.currentTheme.glassmorphism.accentPrimary)
            .onChange((value: number) => {
              this.todoDuration = value;
            })
          
          Text(`${this.todoDuration}åˆ†é’Ÿ`)
            .fontSize(FONT_SIZES.BODY_MEDIUM)
            .fontColor(this.currentTheme.textColor)
        }
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
      }

      // æŒ‰é’®åŒºåŸŸ
      Row() {
        CommonButton({
          config: {
            text: STRINGS.CANCEL,
            type: 'secondary',
            onClick: () => {
              this.controller?.close();
            }
          }
        })
        .layoutWeight(1)
        .margin({ right: 8 })

        CommonButton({
          config: {
            text: STRINGS.CONFIRM,
            type: 'primary',
            onClick: () => {
              this.onConfirm(this.todoName, this.todoType, this.todoDuration);
              this.controller?.close();
            }
          }
        })
        .layoutWeight(1)
        .margin({ left: 8 })
      }
      .margin({ top: 24 })
    }
    .padding(UI_SIZES.DIALOG_PADDING)
    .backgroundColor(this.currentTheme.glassmorphism.surfaceMedium)
    .borderRadius(UI_SIZES.DIALOG_BORDER_RADIUS)
    .width(UI_SIZES.DIALOG_WIDTH)
    .shadow({
      radius: 16,
      color: this.currentTheme.glassmorphism.shadowDeep,
      offsetX: 0,
      offsetY: 8
    })
  }
}

/**
 * å¾…åŠäº‹é¡¹åˆ—è¡¨ç»„ä»¶
 */
@Component
export struct TodoListComponent {
  // å¤–éƒ¨ä¼ å…¥çš„å›è°ƒå‡½æ•°
  @Prop callbacks: TodoListCallbacks;
  
  // å†…éƒ¨çŠ¶æ€
  @State todos: TodoItem[] = [];
  @State isLoading: boolean = false;
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;
  @State showOperationMenu: boolean = false;
  @State selectedTodoId: number = -1;
  
  // å¯¹è¯æ¡†æ§åˆ¶å™¨
  private addTodoDialogController: CustomDialogController | null = null;
  
  // æœåŠ¡å®ä¾‹
  private apiService: ApiService = ApiService.getInstance();
  private themeService: ThemeService = ThemeService.getInstance();
  
  // ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
  private themeChangeListener = async () => {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
      console.info('å¾…åŠåˆ—è¡¨ç»„ä»¶ä¸»é¢˜å·²æ›´æ–°:', this.currentTheme.name);
    } catch (error) {
      console.error('å¾…åŠåˆ—è¡¨ç»„ä»¶ä¸»é¢˜æ›´æ–°å¤±è´¥:', error);
    }
  };

  async aboutToAppear() {
    // æ³¨å†Œä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    
    // åŠ è½½å½“å‰ä¸»é¢˜
    await safeExecute(
      async () => {
        await this.themeService.loadThemePreference();
        this.currentTheme = await this.themeService.getCurrentTheme();
        console.info('å¾…åŠåˆ—è¡¨ç»„ä»¶åŠ è½½ä¸»é¢˜æˆåŠŸ:', this.currentTheme.name);
      },
      (error) => {
        console.error('å¾…åŠåˆ—è¡¨ç»„ä»¶åŠ è½½ä¸»é¢˜å¤±è´¥:', error.message);
      },
      'TodoListComponent.aboutToAppear.loadTheme'
    );

    // åŠ è½½å¾…åŠäº‹é¡¹
    await this.loadTodos();
  }

  aboutToDisappear() {
    // æ³¨é”€ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  /**
   * åŠ è½½å¾…åŠäº‹é¡¹åˆ—è¡¨
   */
  async loadTodos(): Promise<void> {
    this.isLoading = true;
    
    await safeExecute(
      async () => {
        console.info('å¼€å§‹åŠ è½½ç®€å•å¾…åŠäº‹é¡¹åˆ—è¡¨');
        const apiTodos = await this.apiService.getTodoItems();
        console.info('åç«¯è¿”å›çš„å¾…åŠäº‹é¡¹:', JSON.stringify(apiTodos));
        
        // è½¬æ¢ä¸ºå‰ç«¯TodoItemæ ¼å¼
        this.todos = apiTodos.map(apiTodo => ({
          id: apiTodo.id,
          title: apiTodo.title,
          type: apiTodo.type || 'æœªåˆ†ç±»',
          duration: apiTodo.duration || DURATION_CONSTANTS.DEFAULT_TODO_DURATION,
          isCompleted: apiTodo.isCompleted || false,
          createTime: apiTodo.createTime,
          updateTime: apiTodo.updateTime
        }));
        
        console.info('è½¬æ¢åçš„å¾…åŠäº‹é¡¹:', JSON.stringify(this.todos));
      },
      (error) => {
        console.error('åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥:', error.message);
        this.callbacks.onError(`åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥ï¼š${error.message}`);
      },
      'TodoListComponent.loadTodos'
    );
    
    this.isLoading = false;
  }

  /**
   * æ˜¾ç¤ºæ·»åŠ å¾…åŠå¯¹è¯æ¡†
   */
  async showAddTodoDialog(): Promise<void> {
    await safeExecute(
      async () => {
        // é¢„å…ˆè·å–å½“å‰ä¸»é¢˜ï¼Œç¡®ä¿å¼¹çª—æ˜¾ç¤ºæ—¶ä¸»é¢˜å·²åŠ è½½
        const currentTheme = await this.themeService.getCurrentTheme();
        console.info('å‡†å¤‡æ‰“å¼€æ·»åŠ å¾…åŠå¼¹çª—ï¼Œå½“å‰ä¸»é¢˜:', currentTheme.name);
        
        // æ¯æ¬¡æ‰“å¼€æ—¶é‡æ–°åˆ›å»ºï¼Œç¡®ä¿è·å–æœ€æ–°ä¸»é¢˜
        this.addTodoDialogController = new CustomDialogController({
          builder: AddTodoDialog({
            currentTheme: currentTheme,
            onConfirm: (name: string, type: string, duration: number) => {
              this.addNewTodo(name, type, duration);
            }
          }),
          autoCancel: true,
          alignment: DialogAlignment.Center,
          customStyle: true,
          maskColor: Color.Transparent
        });
        
        this.addTodoDialogController.open();
      },
      (error) => {
        console.error('æ‰“å¼€æ·»åŠ å¾…åŠå¼¹çª—å¤±è´¥:', error.message);
        this.callbacks.onError(`æ‰“å¼€æ·»åŠ å¯¹è¯æ¡†å¤±è´¥ï¼š${error.message}`);
      },
      'TodoListComponent.showAddTodoDialog'
    );
  }

  /**
   * æ·»åŠ æ–°çš„å¾…åŠäº‹é¡¹
   */
  private async addNewTodo(name: string, type: string, duration: number): Promise<void> {
    if (!this.validateTodoInput(name, type, duration)) {
      return;
    }

    await safeExecute(
      async () => {
        console.info('æ·»åŠ æ–°å¾…åŠäº‹é¡¹:', { name, type, duration });
        
        const request: TodoItemRequest = {
          title: name.trim(),
          type: type.trim(),
          duration: duration,
          isCompleted: false
        };
        
        const createdTodo = await this.apiService.createTodoItem(request);
        console.info('åˆ›å»ºçš„å¾…åŠäº‹é¡¹:', JSON.stringify(createdTodo));
        
        // è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼å¹¶æ·»åŠ åˆ°åˆ—è¡¨
        const newTodo: TodoItem = {
          id: createdTodo.id,
          title: createdTodo.title,
          type: createdTodo.type || 'æœªåˆ†ç±»',
          duration: createdTodo.duration || DURATION_CONSTANTS.DEFAULT_TODO_DURATION,
          isCompleted: createdTodo.isCompleted || false,
          createTime: createdTodo.createTime,
          updateTime: createdTodo.updateTime
        };
        
        this.todos.push(newTodo);
        this.callbacks.onTodoAdded(newTodo);
        
        promptAction.showToast({ message: 'å¾…åŠäº‹é¡¹æ·»åŠ æˆåŠŸ' });
      },
      (error) => {
        console.error('æ·»åŠ å¾…åŠäº‹é¡¹å¤±è´¥:', error.message);
        const errorMessage = `æ·»åŠ å¾…åŠäº‹é¡¹å¤±è´¥ï¼š${error.message}`;
        promptAction.showToast({ message: errorMessage });
        this.callbacks.onError(errorMessage);
      },
      'TodoListComponent.addNewTodo'
    );
  }

  /**
   * éªŒè¯å¾…åŠäº‹é¡¹è¾“å…¥
   */
  private validateTodoInput(name: string, type: string, duration: number): boolean {
    if (!name.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠåç§°' });
      return false;
    }
    
    if (!type.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠç±»å‹' });
      return false;
    }
    
    if (duration <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿' });
      return false;
    }
    
    return true;
  }

  /**
   * åˆ‡æ¢å¾…åŠäº‹é¡¹çŠ¶æ€
   */
  async toggleTodoStatus(todoId: number): Promise<void> {
    await safeExecute(
      async () => {
        const todo = this.todos.find(t => t.id === todoId);
        if (!todo) {
          throw new Error('å¾…åŠäº‹é¡¹ä¸å­˜åœ¨');
        }
        
        console.info('åˆ‡æ¢å¾…åŠçŠ¶æ€:', todoId, 'åŸçŠ¶æ€:', todo.isCompleted);
        
        const newStatus = !todo.isCompleted;
        await this.apiService.updateTodoItem(todoId, { isCompleted: newStatus });
        
        // æ›´æ–°æœ¬åœ°çŠ¶æ€
        todo.isCompleted = newStatus;
        this.callbacks.onTodoUpdated(todo);
        
        if (newStatus) {
          this.callbacks.onTodoCompleted(todo);
        }
        
        promptAction.showToast({ 
          message: newStatus ? 'å¾…åŠäº‹é¡¹å·²å®Œæˆ' : 'å¾…åŠäº‹é¡¹å·²é‡æ–°æ¿€æ´»' 
        });
      },
      (error) => {
        console.error('åˆ‡æ¢å¾…åŠçŠ¶æ€å¤±è´¥:', error.message);
        const errorMessage = `æ›´æ–°å¾…åŠçŠ¶æ€å¤±è´¥ï¼š${error.message}`;
        promptAction.showToast({ message: errorMessage });
        this.callbacks.onError(errorMessage);
      },
      'TodoListComponent.toggleTodoStatus'
    );
  }

  /**
   * åˆ é™¤å¾…åŠäº‹é¡¹
   */
  async deleteTodo(todoId: number): Promise<void> {
    await safeExecute(
      async () => {
        const todoIndex = this.todos.findIndex(t => t.id === todoId);
        if (todoIndex === -1) {
          throw new Error('å¾…åŠäº‹é¡¹ä¸å­˜åœ¨');
        }
        
        console.info('åˆ é™¤å¾…åŠäº‹é¡¹:', todoId);
        await this.apiService.deleteTodoItem(todoId);
        
        // ä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤
        this.todos.splice(todoIndex, 1);
        this.callbacks.onTodoDeleted(todoId);
        
        promptAction.showToast({ message: 'å¾…åŠäº‹é¡¹å·²åˆ é™¤' });
      },
      (error) => {
        console.error('åˆ é™¤å¾…åŠäº‹é¡¹å¤±è´¥:', error.message);
        const errorMessage = `åˆ é™¤å¾…åŠäº‹é¡¹å¤±è´¥ï¼š${error.message}`;
        promptAction.showToast({ message: errorMessage });
        this.callbacks.onError(errorMessage);
      },
      'TodoListComponent.deleteTodo'
    );
  }

  /**
   * å¼€å§‹ä¸“æ³¨è®¡æ—¶
   */
  private startFocusTimer(todo: TodoItem): void {
    const params: FocusTimerRouterParams = {
      title: todo.title,
      time: todo.duration * 60, // è½¬æ¢ä¸ºç§’
      todoId: todo.id
    };
    
    router.pushUrl({
      url: 'pages/FocusTimer',
      params: params
    }).catch(error => {
      console.error('è·³è½¬åˆ°ä¸“æ³¨è®¡æ—¶å™¨å¤±è´¥:', error);
      promptAction.showToast({ message: 'è·³è½¬å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
    });
  }

  build() {
    Column() {
      // å¤´éƒ¨åŒºåŸŸ
      Row() {
        Text('ğŸ“ å¾…åŠäº‹é¡¹')
          .fontSize(FONT_SIZES.TITLE_LARGE)
          .fontColor(this.currentTheme.textColor)
          .fontWeight(FontWeight.Bold)
          .textShadow({
            radius: 8,
            color: this.currentTheme.glassmorphism.accentPrimary + '50',
            offsetX: 0,
            offsetY: 0
          })
        
        Blank()
        
        // æ·»åŠ æŒ‰é’®
        CommonButton({
          config: {
            text: '+ æ·»åŠ ',
            type: 'primary',
            size: 'small',
            backgroundColor: this.currentTheme.glassmorphism.accentPrimary + '30',
            borderColor: this.currentTheme.glassmorphism.accentPrimary,
            borderWidth: 1,
            fontColor: this.currentTheme.glassmorphism.accentPrimary,
            onClick: () => this.showAddTodoDialog()
          }
        })
        .width(80)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 16 })

      // å¾…åŠäº‹é¡¹åˆ—è¡¨
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color(this.currentTheme.glassmorphism.accentPrimary)
          
          Text(STRINGS.LOADING)
            .fontSize(FONT_SIZES.BODY_MEDIUM)
            .fontColor(this.currentTheme.textColor)
            .opacity(0.6)
            .margin({ top: 16 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.todos.length === 0) {
        Column() {
          Text('ğŸ“‹')
            .fontSize(48)
            .margin({ bottom: 16 })
          
          Text(STRINGS.EMPTY_TODO_LIST)
            .fontSize(FONT_SIZES.BODY_LARGE)
            .fontColor(this.currentTheme.textColor)
            .opacity(0.6)
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.todos, (todo: TodoItem) => {
            ListItem() {
              ThemeAwareGlassCard({ level: 'light' }) {
                Row() {
                  // çŠ¶æ€æŒ‡ç¤ºå™¨
                  Text(todo.isCompleted ? 'âœ…' : 'â­•')
                    .fontSize(FONT_SIZES.TITLE_MEDIUM)
                    .margin({ right: 12 })
                    .onClick(() => {
                      this.toggleTodoStatus(todo.id);
                    })
                  
                  // å¾…åŠä¿¡æ¯
                  Column() {
                    Text(todo.title)
                      .fontSize(FONT_SIZES.BODY_LARGE)
                      .fontColor(this.currentTheme.textColor)
                      .fontWeight(FontWeight.Medium)
                      .opacity(todo.isCompleted ? 0.5 : 1.0)
                      .textDecoration({ type: todo.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None })
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                    
                    Row() {
                      Text(`ğŸ·ï¸ ${todo.type}`)
                        .fontSize(FONT_SIZES.BODY_SMALL)
                        .fontColor(this.currentTheme.textColor)
                        .opacity(0.6)
                      
                      Text(`â±ï¸ ${todo.duration}åˆ†é’Ÿ`)
                        .fontSize(FONT_SIZES.BODY_SMALL)
                        .fontColor(this.currentTheme.textColor)
                        .opacity(0.6)
                        .margin({ left: 12 })
                    }
                    .margin({ top: 4 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                  
                  // æ“ä½œæŒ‰é’®
                  Row({ space: 8 }) {
                    if (!todo.isCompleted) {
                      // å¼€å§‹ä¸“æ³¨æŒ‰é’®
                      Text('â–¶ï¸')
                        .fontSize(FONT_SIZES.BODY_LARGE)
                        .fontColor(this.currentTheme.glassmorphism.accentPrimary)
                        .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                        .borderRadius(16)
                        .width(32)
                        .height(32)
                        .textAlign(TextAlign.Center)
                        .onClick(() => {
                          this.startFocusTimer(todo);
                        })
                    }
                    
                    // åˆ é™¤æŒ‰é’®
                    Text('ğŸ—‘ï¸')
                      .fontSize(FONT_SIZES.BODY_LARGE)
                      .fontColor(this.currentTheme.glassmorphism.accentSecondary)
                      .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                      .borderRadius(16)
                      .width(32)
                      .height(32)
                      .textAlign(TextAlign.Center)
                      .onClick(() => {
                        this.deleteTodo(todo.id);
                      })
                  }
                }
                .alignItems(VerticalAlign.Center)
                .padding(16)
              }
              .margin({ left: 16, right: 16, bottom: 8 })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
  }
}

/**
 * å¾…åŠäº‹é¡¹åˆ—è¡¨ç»„ä»¶å·¥å…·ç±»
 */
export class TodoListUtils {
  /**
   * åˆ›å»ºé»˜è®¤çš„å¾…åŠäº‹é¡¹å›è°ƒ
   */
  static createDefaultCallbacks(
    onTodoAdded?: (todo: TodoItem) => void,
    onTodoUpdated?: (todo: TodoItem) => void,
    onTodoDeleted?: (todoId: number) => void,
    onTodoCompleted?: (todo: TodoItem) => void,
    onError?: (error: string) => void
  ): TodoListCallbacks {
    return {
      onTodoAdded: onTodoAdded || ((todo: TodoItem) => {
        console.info('å¾…åŠäº‹é¡¹å·²æ·»åŠ :', todo.title);
      }),
      onTodoUpdated: onTodoUpdated || ((todo: TodoItem) => {
        console.info('å¾…åŠäº‹é¡¹å·²æ›´æ–°:', todo.title);
      }),
      onTodoDeleted: onTodoDeleted || ((todoId: number) => {
        console.info('å¾…åŠäº‹é¡¹å·²åˆ é™¤:', todoId);
      }),
      onTodoCompleted: onTodoCompleted || ((todo: TodoItem) => {
        console.info('å¾…åŠäº‹é¡¹å·²å®Œæˆ:', todo.title);
      }),
      onError: onError || ((error: string) => {
        console.error('å¾…åŠäº‹é¡¹æ“ä½œå¤±è´¥:', error);
      })
    };
  }

  /**
   * è¿‡æ»¤å¾…åŠäº‹é¡¹
   */
  static filterTodos(todos: TodoItem[], filter: 'all' | 'active' | 'completed'): TodoItem[] {
    switch (filter) {
      case 'active':
        return todos.filter(todo => !todo.isCompleted);
      case 'completed':
        return todos.filter(todo => todo.isCompleted);
      default:
        return todos;
    }
  }

  /**
   * æ’åºå¾…åŠäº‹é¡¹
   */
  static sortTodos(todos: TodoItem[], sortBy: 'createTime' | 'title' | 'duration', order: 'asc' | 'desc' = 'desc'): TodoItem[] {
    return [...todos].sort((a, b) => {
      let comparison = 0;
      
      switch (sortBy) {
        case 'title':
          comparison = a.title.localeCompare(b.title);
          break;
        case 'duration':
          comparison = a.duration - b.duration;
          break;
        case 'createTime':
        default:
          comparison = new Date(a.createTime || '').getTime() - new Date(b.createTime || '').getTime();
          break;
      }
      
      return order === 'asc' ? comparison : -comparison;
    });
  }
} 