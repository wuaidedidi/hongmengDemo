import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../services/ThemeService';

interface TabItem {
  icon: string;
  text: string;
  path: string;
}

@Component
export struct TabBar {
  @Prop currentIndex: number = 0;
  @Prop isLocked?: boolean = false;  // æ·»åŠ é”æœºçŠ¶æ€å±žæ€§
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;

  private themeService: ThemeService = ThemeService.getInstance();
  private themeChangeListener = async () => {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
    } catch (error) {
      console.error('TabBarä¸»é¢˜æ›´æ–°å¤±è´¥:', error);
    }
  };

  private tabs: TabItem[] = [
    { icon: 'ðŸ“…', text: 'å¾…åŠž', path: 'pages/Index' },
    { icon: 'ðŸ“', text: 'å¾…åŠžç®¡ç†', path: 'pages/TodoPage' },
    { icon: 'ðŸ”’', text: 'é”æœº', path: 'pages/LockPage' },
    { icon: 'ðŸ“Š', text: 'ç»Ÿè®¡æ•°æ®', path: 'pages/StatisticsPage' },
    { icon: 'ðŸ‘¤', text: 'æˆ‘çš„', path: 'pages/Profile' }
  ];

  @Builder
  TabBuilder(index: number, icon: string, text: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .fontColor(this.currentIndex === index ? this.currentTheme.primaryColor : this.currentTheme.textColor)
        .opacity(this.currentIndex === index ? 1.0 : 0.6)
      Text(text)
        .fontSize(12)
        .margin({ top: 4 })
        .fontColor(this.currentIndex === index ? this.currentTheme.primaryColor : this.currentTheme.textColor)
        .opacity(this.currentIndex === index ? 1.0 : 0.6)
    }
    .width('20%')
    .height(56)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      if (this.currentIndex !== index) {
        // æ£€æŸ¥æ˜¯å¦åœ¨é”æœºçŠ¶æ€
        if (this.isLocked && this.currentIndex === 2) {
          promptAction.showToast({ 
            message: 'è¯·å…ˆè§£é™¤é”æœºçŠ¶æ€å†åˆ‡æ¢é¡µé¢',
            duration: 2000
          });
          return;
        }
        console.info(`æ­£åœ¨è·³è½¬åˆ°: ${this.tabs[index].path}`);
        router.replaceUrl({
          url: this.tabs[index].path,
          params: {}
        }).then(() => {
          console.info(`æˆåŠŸè·³è½¬åˆ°: ${this.tabs[index].path}`);
        }).catch((err: Error) => {
          console.error(`å¯¼èˆªå¤±è´¥: ${err.message}`);
          promptAction.showToast({ 
            message: `é¡µé¢è·³è½¬å¤±è´¥: ${err.message}`,
            duration: 2000
          });
        });
      }
    })
  }

  async aboutToAppear() {
    // æ³¨å†Œä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    // åŠ è½½å½“å‰ä¸»é¢˜
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
    } catch (error) {
      console.error('TabBaråŠ è½½ä¸»é¢˜å¤±è´¥:', error);
    }
  }

  aboutToDisappear() {
    // æ³¨é”€ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  build() {
    Row() {
      ForEach(this.tabs, (item: TabItem, index: number) => {
        this.TabBuilder(index, item.icon, item.text)
      })
    }
    .width('100%')
    .height(56)
    .backgroundColor(this.currentTheme.cardBackgroundColor)
    .justifyContent(FlexAlign.SpaceEvenly)
    .border({ width: { top: 0.5 }, color: this.currentTheme.borderColor })
    .shadow({ radius: 4, color: this.currentTheme.shadowColor, offsetY: -2 })
    .zIndex(1)
  }
}