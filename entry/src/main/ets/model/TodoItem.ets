/**
 * ğŸ“ å¾…åŠäº‹é¡¹æ•°æ®æ¨¡å‹ (TodoItem)
 * 
 * è¿™æ˜¯åº”ç”¨çš„æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼Œä»£è¡¨ä¸€ä¸ªå¾…åŠäº‹é¡¹
 * åŒ…å«äº†å¾…åŠäº‹é¡¹çš„æ‰€æœ‰å±æ€§å’Œç›¸å…³æ“ä½œæ–¹æ³•
 * 
 * ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - å¾…åŠäº‹é¡¹çš„åŸºæœ¬ä¿¡æ¯ç®¡ç†
 * - å®ŒæˆçŠ¶æ€åˆ‡æ¢
 * - æ•°æ®æŒä¹…åŒ–æ“ä½œ
 * - JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
 */

import { ApiService } from '../services/ApiService';

/**
 * å¾…åŠäº‹é¡¹JSONæ¥å£
 * ç”¨äºæ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
 */
interface TodoItemJson {
  id: number;        // å¾…åŠäº‹é¡¹å”¯ä¸€æ ‡è¯†
  title: string;     // å¾…åŠäº‹é¡¹æ ‡é¢˜
  type: string;      // å¾…åŠäº‹é¡¹åˆ†ç±»
  duration: number;  // é¢„è®¡å®Œæˆæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  isCompleted: boolean; // å®ŒæˆçŠ¶æ€
}

/**
 * ğŸ“‹ å¾…åŠäº‹é¡¹ç±»
 * 
 * è¿™ä¸ªç±»å°è£…äº†å¾…åŠäº‹é¡¹çš„æ‰€æœ‰å±æ€§å’Œè¡Œä¸º
 * é‡‡ç”¨é¢å‘å¯¹è±¡çš„è®¾è®¡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
 */
export class TodoItem {
  /** å¾…åŠäº‹é¡¹å”¯ä¸€æ ‡è¯†ç¬¦ */
  id: number;
  
  /** å¾…åŠäº‹é¡¹æ ‡é¢˜ */
  title: string;
  
  /** å¾…åŠäº‹é¡¹åˆ†ç±»ï¼ˆå¦‚ï¼šå·¥ä½œã€å­¦ä¹ ã€ç”Ÿæ´»ç­‰ï¼‰ */
  type: string;
  
  /** é¢„è®¡å®Œæˆæ—¶é•¿ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰ */
  duration: number;
  
  /** å®ŒæˆçŠ¶æ€æ ‡è¯† */
  isCompleted: boolean;
  
  /** APIæœåŠ¡å®ä¾‹ï¼Œç”¨äºä¸åç«¯äº¤äº’ */
  private apiService: ApiService = ApiService.getInstance();

  /**
   * æ„é€ å‡½æ•° - åˆ›å»ºå¾…åŠäº‹é¡¹å®ä¾‹
   * 
   * @param id - å¾…åŠäº‹é¡¹ID
   * @param title - å¾…åŠäº‹é¡¹æ ‡é¢˜
   * @param type - å¾…åŠäº‹é¡¹åˆ†ç±»
   * @param duration - é¢„è®¡å®Œæˆæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
   * @param isCompleted - å®ŒæˆçŠ¶æ€ï¼Œé»˜è®¤ä¸ºfalse
   */
  constructor(id: number, title: string, type: string, duration: number, isCompleted: boolean = false) {
    this.id = id;
    this.title = title;
    this.type = type;
    this.duration = duration;
    this.isCompleted = isCompleted;
  }

  /**
   * ğŸ• æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
   * 
   * å°†æ•°å­—æ—¶é•¿è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æ–‡æœ¬æ ¼å¼
   * 
   * @returns æ ¼å¼åŒ–åçš„æ—¶é•¿å­—ç¬¦ä¸²ï¼Œå¦‚ "25åˆ†é’Ÿ"
   */
  formatDuration(): string {
    return `${this.duration}åˆ†é’Ÿ`;
  }

  /**
   * âœ… åˆ‡æ¢å®ŒæˆçŠ¶æ€
   * 
   * åˆ‡æ¢å¾…åŠäº‹é¡¹çš„å®ŒæˆçŠ¶æ€ï¼Œå¹¶åŒæ­¥åˆ°åç«¯
   * 
   * ğŸ”„ æ“ä½œæµç¨‹ï¼š
   * 1. å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
   * 2. è°ƒç”¨APIåŒæ­¥åˆ°åç«¯
   * 3. å¦‚æœå¤±è´¥åˆ™å›æ»šæœ¬åœ°çŠ¶æ€
   * 
   * @throws Error å½“çŠ¶æ€æ›´æ–°å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
   */
  async toggleComplete(): Promise<void> {
    try {
      // å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
      this.isCompleted = !this.isCompleted;
      
      // TODO: ä¸åç«¯åŒæ­¥çŠ¶æ€
      // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸åç«¯åŒæ­¥çš„é€»è¾‘
      // ä¾‹å¦‚ï¼šawait this.apiService.updateTodoStatus(this.id, this.isCompleted);
      
      console.info(`âœ… å¾…åŠäº‹é¡¹çŠ¶æ€å·²æ›´æ–°: ${this.title} -> ${this.isCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}`);
    } catch (error) {
      console.error('âŒ æ›´æ–°å¾…åŠçŠ¶æ€å¤±è´¥:', error);
      
      // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€
      this.isCompleted = !this.isCompleted;
      
      // ç»Ÿä¸€é”™è¯¯å¤„ç†
      const errorToThrow = error instanceof Error ? error : new Error(String(error));
      throw errorToThrow;
    }
  }

  /**
   * ğŸ—‘ï¸ åˆ é™¤å¾…åŠäº‹é¡¹
   * 
   * åˆ é™¤å½“å‰å¾…åŠäº‹é¡¹ï¼Œå¹¶ä»åç«¯ç§»é™¤
   * 
   * @throws Error å½“åˆ é™¤å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
   */
  async delete(): Promise<void> {
    try {
      // TODO: ä¸åç«¯åŒæ­¥åˆ é™¤æ“ä½œ
      // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸åç«¯åŒæ­¥çš„åˆ é™¤é€»è¾‘
      // ä¾‹å¦‚ï¼šawait this.apiService.deleteTodo(this.id);
      
      console.info(`ğŸ—‘ï¸ å¾…åŠäº‹é¡¹å·²åˆ é™¤: ${this.title}`);
    } catch (error) {
      console.error('âŒ åˆ é™¤å¾…åŠå¤±è´¥:', error);
      
      // ç»Ÿä¸€é”™è¯¯å¤„ç†
      const errorToThrow = error instanceof Error ? error : new Error(String(error));
      throw errorToThrow;
    }
  }

  /**
   * ğŸ“¥ ä»JSONåˆ›å»ºTodoItemå®ä¾‹
   * 
   * é™æ€å·¥å‚æ–¹æ³•ï¼Œç”¨äºä»JSONæ•°æ®åˆ›å»ºTodoItemå¯¹è±¡
   * å¸¸ç”¨äºAPIå“åº”æ•°æ®çš„è½¬æ¢
   * 
   * @param json - åŒ…å«å¾…åŠäº‹é¡¹æ•°æ®çš„JSONå¯¹è±¡
   * @returns æ–°åˆ›å»ºçš„TodoItemå®ä¾‹
   */
  static fromJson(json: TodoItemJson): TodoItem {
    return new TodoItem(
      json.id,
      json.title,
      json.type,
      json.duration,
      json.isCompleted
    );
  }

  /**
   * ğŸ“¤ è½¬æ¢ä¸ºJSONæ ¼å¼
   * 
   * å°†TodoItemå®ä¾‹è½¬æ¢ä¸ºJSONå¯¹è±¡
   * å¸¸ç”¨äºAPIè¯·æ±‚æ•°æ®çš„å‡†å¤‡
   * 
   * @returns åŒ…å«å¾…åŠäº‹é¡¹æ•°æ®çš„JSONå¯¹è±¡
   */
  toJson(): TodoItemJson {
    return {
      id: this.id,
      title: this.title,
      type: this.type,
      duration: this.duration,
      isCompleted: this.isCompleted
    };
  }
} 