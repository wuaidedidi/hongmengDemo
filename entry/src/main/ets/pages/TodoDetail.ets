import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import wantConstant from '@ohos.ability.wantConstant';
import bundleManager from '@ohos.bundle.bundleManager';
import type Want from '@ohos.app.ability.Want';
import { TodoCollection, TodoItem, TodoStatus } from '../model/TodoTypes';
import { mockCollections } from '../model/MockData';
import { TabBar } from '../components/TabBar';

// FocusTimeré¡µé¢è·¯ç”±å‚æ•°å®šä¹‰ (æ ¹æ®TodoDetailçš„éœ€æ±‚è°ƒæ•´)
interface FocusTimerRouterParams {
  taskTitle?: string;
  title?: string;
  time?: number; // ç§’
  isSequence?: boolean;
  collectionId?: string;
  subTaskId?: string;
  currentSubTaskIndex?: number;
  totalSubTasksInCollection?: number;
  // todoId?: string | number; // TodoDetailä¸»è¦å¤„ç†åˆé›†ï¼Œç®€å•todoIdå¯èƒ½ä¸éœ€è¦
}

// è·¯ç”±å‚æ•°æ¥å£ (å½“ä»FocusTimerè¿”å›æ—¶)
interface RouterParams {
  action?: string; // e.g., 'focusCompleted'
  sequenceAction?: string; // e.g., 'taskCompleted', 'sequenceAborted'
  collectionId?: string | number;
  subTaskId?: string | number; // è®°å½•å®Œæˆæˆ–ä¸­æ­¢çš„å­ä»»åŠ¡ID
  completedSubTaskIndex?: string | number; // å…¼å®¹æ—§çš„å‚æ•°å
  currentSubTaskIndexCompleted?: string; // å…¼å®¹æ—§çš„å‚æ•°å
  allSubTasksInCollectionCompleted?: string; // å…¼å®¹æ—§çš„å‚æ•°å
}

// å®šä¹‰è·¯ç”±å‚æ•°æ¥å£
interface RouterError {
  message: string;
}

// å•ä¸ªå…·ä½“å¾…åŠäº‹é¡¹
class ActualTodoItem {
  id: string;
  title: string;
  durationMinutes: number;
  isCompleted: boolean = false;

  constructor(id: string, title: string, durationMinutes: number, isCompleted: boolean = false) {
    this.id = id;
    this.title = title;
    this.durationMinutes = durationMinutes;
    this.isCompleted = isCompleted;
  }
}

// é‡å‘½åæœ¬åœ°çš„ TodoCollection ç±»ä¸º LocalTodoCollection
class LocalTodoCollection {
  id: string;
  collectionTitle: string;
  subTasks: ActualTodoItem[];
  isExpanded: boolean = false;
  currentTaskIndex: number = -1;
  isSequenceActive: boolean = false;

  constructor(id: string, collectionTitle: string, subTasks: ActualTodoItem[] = [], isExpanded: boolean = false) {
    this.id = id;
    this.collectionTitle = collectionTitle;
    this.subTasks = subTasks;
    this.isExpanded = isExpanded;
    this.currentTaskIndex = -1;
    this.isSequenceActive = false;
    if (subTasks.length === 0 && id.startsWith("default")) {
      this.subTasks.push(new ActualTodoItem(Date.now().toString() + "-s1", "å­ä»»åŠ¡A", 5));
      this.subTasks.push(new ActualTodoItem(Date.now().toString() + "-s2", "å­ä»»åŠ¡B", 10));
    }
  }
}

// å®šä¹‰TodoItemç•Œé¢æ˜¾ç¤ºæ‰€éœ€çš„ç±»å‹
interface TodoItemDisplay {
  title: string;
  description: string;
  isImportant: boolean;
  isUrgent: boolean;
  status: TodoStatus;
}

@CustomDialog
struct AddTodoDialog {
  @State newTodoTitle: string = '';
  @State newTodoDuration: number = 15;
  controller: CustomDialogController;
  onConfirm: (title: string, duration: number) => void = () => {
  };

  build() {
    Column() {
      Text('æ·»åŠ å¾…åŠ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 10, bottom: 10 })
      
      TextInput({ placeholder: 'è¯·è¾“å…¥å¾…åŠæ ‡é¢˜' })
        .width('90%')
        .height(40)
        .margin({ top: 16 })
        .onChange((value: string) => {
          this.newTodoTitle = value;
        })
      
      TextInput({ placeholder: 'è¯·è¾“å…¥æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰' })
        .width('90%')
        .height(40)
        .margin({ top: 16 })
        .type(InputType.Number)
        .onChange((value: string) => {
          this.newTodoDuration = parseInt(value) || 15;
        })
      
      Row() {
        Button('å–æ¶ˆ')
          .onClick(() => {
            this.controller.close();
          })
          .margin({ right: 10 })
        
        Button('ç¡®å®š')
          .onClick(() => {
            if (this.newTodoTitle.trim() === '') {
              promptAction.showToast({ message: 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º' });
              return;
            }
            this.onConfirm(this.newTodoTitle, this.newTodoDuration);
            this.controller.close();
          })
      }
      .margin({ top: 20, bottom: 10 })
    }
    .width('80%')
    .padding(20)
  }
}

@CustomDialog
struct AddCollectionDialog {
  @Link newCollectionTitle: string; // ç»‘å®šåˆ° TodoDetail é¡µé¢çš„ @State
  onConfirm: () => void = () => {
  };
  controller?: CustomDialogController;

  build() {
    Column() {
      Text("æ·»åŠ æ–°å¾…åŠåˆé›†").fontSize(20).fontWeight(FontWeight.Bold).margin({ bottom: 20 })
      TextInput({ placeholder: "åˆé›†åç§°", text: this.newCollectionTitle })
        .onChange(val => {
          this.newCollectionTitle = val;
        })
        .margin({ bottom: 20 })
      Row({ space: 10 }) {
        Button("å–æ¶ˆ").onClick(() => {
          if (this.controller) {
            this.controller.close();
          }
        }).layoutWeight(1)
        Button("ç¡®å®š").onClick(() => {
            if (this.newCollectionTitle.trim() === '') {
            promptAction.showToast({ message: 'åˆé›†åç§°ä¸èƒ½ä¸ºç©º' });
              return;
            }
          this.onConfirm();
          if (this.controller) {
            this.controller.close();
      }
        }).layoutWeight(1).backgroundColor('#8A2BE2')
      }.width('100%')
    }
    .padding(20).width("80%").backgroundColor(Color.White).borderRadius(15)
  }
}

@CustomDialog
struct PermissionDialog {
  controller: CustomDialogController;
  onConfirm: () => void = () => {
  };

  build() {
    Column() {
      Text('æƒé™è®¾ç½®')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 10, bottom: 10 })
      
      Text('è¯·ç¡®ä¿ä»¥ä¸‹æƒé™å·²å¼€å¯ï¼š')
        .fontSize(16)
        .margin({ bottom: 16 })
      
      Text('â€¢ é€šçŸ¥æƒé™')
        .fontSize(14)
        .margin({ bottom: 8 })
      
      Text('â€¢ åå°è¿è¡Œæƒé™')
        .fontSize(14)
        .margin({ bottom: 8 })
      
      Text('â€¢ è‡ªå¯åŠ¨æƒé™')
        .fontSize(14)
      
      Row() {
        Button('å–æ¶ˆ')
          .onClick(() => {
            this.controller.close();
          })
          .margin({ right: 10 })
        
        Button('å»è®¾ç½®')
          .onClick(() => {
            this.onConfirm();
            this.controller.close();
          })
      }
      .margin({ top: 20, bottom: 10 })
    }
    .width('80%')
    .padding(20)
  }
}

@Entry
@Component
struct TodoDetail {
  @State collections: LocalTodoCollection[] = [];
  @State currentExpandedId: string | null = null;
  @State currentIndex: number = 1;
  @State bgColor: string = 'rgba(173, 216, 230, 0.15)';
  @State showCongratulationsDialog: boolean = false;
  @State todoCollections: LocalTodoCollection[] = [
    new LocalTodoCollection("default_coll1", "å­¦ä¹ é¸¿è’™å¼€å‘", [
      new ActualTodoItem("s1_1", "é˜…è¯»å®˜æ–¹æ–‡æ¡£ç¬¬ä¸€ç« ", 25),
      new ActualTodoItem("s1_2", "å®Œæˆå…¥é—¨Demo", 45),
      new ActualTodoItem("s1_3", "å­¦ä¹ UIç»„ä»¶", 60)
    ]),
    new LocalTodoCollection("default_coll2", "å®¶åº­æ¸…æ´ä»»åŠ¡", [
      new ActualTodoItem("s2_1", "æ‰“æ‰«å®¢å…", 20),
      new ActualTodoItem("s2_2", "æ¸…æ´—å¨æˆ¿", 30),
      new ActualTodoItem("s2_3", "æ•´ç†å§å®¤", 25)
    ])
  ];
  private nextCollectionIdSuffix: number = 3;
  @State newCollectionTitle: string = '';
  private addCollectionDialogController: CustomDialogController = new CustomDialogController({
    builder: AddCollectionDialog({
      newCollectionTitle: $newCollectionTitle,
      onConfirm: () => {
        this.addNewCollection();
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  aboutToAppear() {
    console.info('TodoDetail aboutToAppear. CurrentIndex: ' + this.currentIndex);
    this.currentIndex = 1;
    this.processRouteParams(); // å¤„ç†é¦–æ¬¡è¿›å…¥æ—¶å¯èƒ½å­˜åœ¨çš„è·¯ç”±å‚æ•°
  }

  onPageShow() {
    console.info("TodoDetail page onPageShow triggered");
    this.currentIndex = 1;
    this.processRouteParams(); // å¤„ç†æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶çš„è·¯ç”±å‚æ•°
  }

  processRouteParams() {
    const params = router.getParams() as RouterParams;
    if (!params || Object.keys(params).length === 0) {
      console.info('TodoDetail: No route params to process.');
      return;
    }
    console.info('TodoDetail router.getParams(): ' + JSON.stringify(params));

    this.handleRouterParams(params);
  }

  handleRouterParams(params: RouterParams) {
    if (!params) return;

    const collectionId = params.collectionId ? String(params.collectionId) : null;
    const subTaskId = params.subTaskId ? String(params.subTaskId) : null;

    if (!collectionId) return;

    const collectionIndex = this.todoCollections.findIndex(c => c.id === collectionId);
    if (collectionIndex === -1) return;

    const collection = this.todoCollections[collectionIndex];

    if (params.sequenceAction === 'taskCompleted' && subTaskId) {
      const taskIndex = collection.subTasks.findIndex(st => st.id === subTaskId);
      if (taskIndex !== -1) {
        // æ ‡è®°å½“å‰ä»»åŠ¡ä¸ºå®Œæˆ
        collection.subTasks[taskIndex].isCompleted = true;
        
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆ
        const allSubTasksDone = collection.subTasks.every(st => st.isCompleted);
        if (allSubTasksDone) {
          collection.isSequenceActive = false;
          collection.currentTaskIndex = -1;
          this.showCongratulationsDialog = true;
          setTimeout(() => {
            this.showCongratulationsDialog = false;
          }, 5000);
          promptAction.showToast({ message: `æ­å–œï¼åˆé›† "${collection.collectionTitle}" å·²å…¨éƒ¨å®Œæˆï¼` });
        } else {
          // åºåˆ—æœªå®Œæˆï¼Œè‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªä»»åŠ¡
          let nextUncompletedTaskIndex = -1;
          for (let i = taskIndex + 1; i < collection.subTasks.length; i++) {
            if (!collection.subTasks[i].isCompleted) {
              nextUncompletedTaskIndex = i;
              break;
            }
          }
          if (nextUncompletedTaskIndex !== -1) {
            collection.currentTaskIndex = nextUncompletedTaskIndex;
            this.startSequenceTask(collection, nextUncompletedTaskIndex);
          } else {
            collection.isSequenceActive = false;
            collection.currentTaskIndex = -1;
          }
        }
      }
    } else if (params.sequenceAction === 'sequenceAborted') {
      collection.isSequenceActive = false;
      collection.currentTaskIndex = -1;
      promptAction.showToast({ message: `åºåˆ— '${collection.collectionTitle}' å·²ä¸­æ­¢` });
    } else if (params.action === 'focusCompleted' && subTaskId) {
      const taskIndex = collection.subTasks.findIndex(st => st.id === subTaskId);
      if (taskIndex !== -1) {
        collection.subTasks[taskIndex].isCompleted = true;
        promptAction.showToast({ message: `ä»»åŠ¡ '${collection.subTasks[taskIndex].title}' å·²å®Œæˆ` });
      }
    }

    // æ›´æ–°UI
    const updatedCollection = new LocalTodoCollection(
      collection.id, 
      collection.collectionTitle, 
      collection.subTasks,
      collection.isExpanded
    );
    updatedCollection.isSequenceActive = collection.isSequenceActive;
    updatedCollection.currentTaskIndex = collection.currentTaskIndex;
    this.todoCollections.splice(collectionIndex, 1, updatedCollection);
    this.todoCollections = [...this.todoCollections];
  }

  addNewCollection() {
    if (this.newCollectionTitle.trim() === '') {
      promptAction.showToast({ message: "åˆé›†åç§°ä¸èƒ½ä¸ºç©º" });
      return;
    }
    const newId = "coll_" + Date.now().toString() + '_' + this.nextCollectionIdSuffix++;
    const defaultSubTasks = [
      new ActualTodoItem(newId + '_s1', "æ–°å­ä»»åŠ¡1 (ç¼–è¾‘æˆ‘)", 10),
      new ActualTodoItem(newId + '_s2', "æ–°å­ä»»åŠ¡2 (ç¼–è¾‘æˆ‘)", 15)
    ];
    const newCollection = new LocalTodoCollection(newId, this.newCollectionTitle.trim(), defaultSubTasks);
    this.todoCollections.push(newCollection);
    this.newCollectionTitle = '';
    promptAction.showToast({ message: "æ–°å¾…åŠåˆé›†å·²æ·»åŠ " });
  }

  startSequenceTask(collection: LocalTodoCollection, startIndex: number = 0) {
    if (!collection || collection.subTasks.length === 0) {
      promptAction.showToast({ message: `åˆé›† "${collection?.collectionTitle}" ä¸­æ²¡æœ‰ä»»åŠ¡ã€‚` });
      return;
    }

    // æ£€æŸ¥ä»startIndexå¼€å§‹æ˜¯å¦è¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡
    let nextTaskIndex = -1;
    for (let i = startIndex; i < collection.subTasks.length; i++) {
      if (!collection.subTasks[i].isCompleted) {
        nextTaskIndex = i;
        break;
      }
    }

    if (nextTaskIndex === -1) {
      // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆ
      const allDone = collection.subTasks.every(st => st.isCompleted);
      if (allDone) {
        this.showCongratulationsDialog = true;
        setTimeout(() => {
          this.showCongratulationsDialog = false;
        }, 5000);
        promptAction.showToast({ message: `å¤ªæ£’äº†ï¼åˆé›† "${collection.collectionTitle}" å·²å…¨éƒ¨å®Œæˆï¼` });
      } else {
        promptAction.showToast({ message: `åˆé›† "${collection.collectionTitle}" ä¸­ä»å½“å‰ä½ç½®å¼€å§‹æ²¡æœ‰æœªå®Œæˆçš„ä»»åŠ¡ã€‚` });
      }
      collection.isSequenceActive = false;
      collection.currentTaskIndex = -1;
      const colIndex = this.todoCollections.findIndex(c => c.id === collection.id);
      if (colIndex !== -1) {
        const updatedCollection = new LocalTodoCollection(
          collection.id, 
          collection.collectionTitle, 
          collection.subTasks,
          collection.isExpanded
        );
        updatedCollection.isSequenceActive = collection.isSequenceActive;
        updatedCollection.currentTaskIndex = collection.currentTaskIndex;
        this.todoCollections.splice(colIndex, 1, updatedCollection);
      }
      this.todoCollections = [...this.todoCollections];
      return;
    }

    collection.isSequenceActive = true;
    collection.currentTaskIndex = nextTaskIndex;
    const subTask = collection.subTasks[nextTaskIndex];

    const colIdx = this.todoCollections.findIndex(c => c.id === collection.id);
    if (colIdx !== -1) {
      const updatedCollection = new LocalTodoCollection(
        collection.id, 
        collection.collectionTitle, 
        collection.subTasks,
        collection.isExpanded
      );
      updatedCollection.isSequenceActive = collection.isSequenceActive;
      updatedCollection.currentTaskIndex = collection.currentTaskIndex;
      this.todoCollections.splice(colIdx, 1, updatedCollection);
    }
    this.todoCollections = [...this.todoCollections];

    const params: FocusTimerRouterParams = {
      title: subTask.title,
      taskTitle: `${collection.collectionTitle} - ${subTask.title}`,
      time: subTask.durationMinutes * 60,
      isSequence: true,
      collectionId: collection.id,
      subTaskId: subTask.id,
      currentSubTaskIndex: nextTaskIndex,
      totalSubTasksInCollection: collection.subTasks.length
    };

    router.pushUrl({ url: 'pages/FocusTimer', params: params })
      .catch((err: RouterError) => {
        console.error(`Error navigating to FocusTimer for sequence: ${JSON.stringify(err)}`);
        promptAction.showToast({ message: `å¯åŠ¨åºåˆ—ä»»åŠ¡å¤±è´¥: ${err.message}` });
        collection.isSequenceActive = false;
        collection.currentTaskIndex = -1;
        const cIdx = this.todoCollections.findIndex(c => c.id === collection.id);
        if (cIdx !== -1) {
          const updatedCollection = new LocalTodoCollection(
            collection.id, 
            collection.collectionTitle, 
            collection.subTasks,
            collection.isExpanded
          );
          updatedCollection.isSequenceActive = collection.isSequenceActive;
          updatedCollection.currentTaskIndex = collection.currentTaskIndex;
          this.todoCollections.splice(cIdx, 1, updatedCollection);
        }
        this.todoCollections = [...this.todoCollections];
      });
  }

  // æ·»åŠ ä¸€ä¸ªå¤„ç†å±•å¼€/æ”¶èµ·çš„æ–¹æ³•
  toggleExpand(collection: LocalTodoCollection) {
    const index = this.todoCollections.findIndex(c => c.id === collection.id);
    if (index === -1) return;

    // åˆ›å»ºæ–°çš„é›†åˆå®ä¾‹ï¼Œä¿æŒæ‰€æœ‰çŠ¶æ€
    const updatedCollection = new LocalTodoCollection(
      collection.id,
      collection.collectionTitle,
      collection.subTasks,
      !collection.isExpanded // åˆ‡æ¢å±•å¼€çŠ¶æ€
    );
    updatedCollection.isSequenceActive = collection.isSequenceActive;
    updatedCollection.currentTaskIndex = collection.currentTaskIndex;

    // æ›´æ–°é›†åˆ
    this.todoCollections.splice(index, 1, updatedCollection);
    this.todoCollections = [...this.todoCollections];
  }

  @Builder
  TodoItemBuilder(item: TodoItemDisplay) {
    Row() {
      Column() {
        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
        if (item.description) {
          Text(item.description)
            .fontSize(14)
            .opacity(0.6)
            .margin({ top: 4 })
        }
      }.layoutWeight(1)

      if (item.isImportant || item.isUrgent) {
        Row() {
          if (item.isImportant) {
            Text('é‡è¦')
              .fontSize(12)
              .fontColor('#FF4500')
              .backgroundColor('#FFE4E1')
              .padding({
                left: 8,
                right: 8,
                top: 2,
                bottom: 2
              })
              .borderRadius(4)
              .margin({ right: 8 })
          }
          if (item.isUrgent) {
            Text('ç´§æ€¥')
              .fontSize(12)
              .fontColor('#FF0000')
              .backgroundColor('#FFF0F0')
              .padding({
                left: 8,
                right: 8,
                top: 2,
                bottom: 2
              })
              .borderRadius(4)
          }
        }
      }

      Text(item.status === TodoStatus.COMPLETED ? 'âœ“' :
        (item.status === TodoStatus.IN_PROGRESS ? 'â³' : ''))
        .fontSize(20)
        .fontColor(item.status === TodoStatus.COMPLETED ? '#4CAF50' : '#FFA500')
        .margin({ left: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .onClick(() => {
      router.pushUrl({
        url: 'pages/FocusTimer',
        params: {
          taskTitle: item.title,
          time: 25 * 60
        }
      }).catch((err: RouterError) => {
        console.error('å¯¼èˆªåˆ°ä¸“æ³¨é¡µé¢å¤±è´¥:', err.message);
      });
    })
  }

  // è·å–åº”ç”¨ä¸Šä¸‹æ–‡
  getAppAbilityContext(): common.UIAbilityContext | undefined {
    const context = getContext(this);
    if (context && typeof context === 'object') {
      try {
        const uiContext = context as common.UIAbilityContext;
        if (uiContext.applicationInfo !== undefined && typeof uiContext.startAbility === 'function') {
          return uiContext;
        }
      } catch (e) {
        console.error("Context conversion to UIAbilityContext error: " + ((e as Error).message || String(e)));
      }
    }
    console.warn("Failed to get a valid UIAbilityContext.");
    return undefined;
  }

  // è·³è½¬åˆ°ç³»ç»Ÿåº”ç”¨æƒé™è®¾ç½®é¡µé¢
  startSystemSettingsGuidanceFlow() {
    const context = this.getAppAbilityContext();
    if (!context) {
      promptAction.showToast({ message: "æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡" });
      return;
    }

    try {
      // å°è¯•ç›´æ¥è·³è½¬åˆ°åº”ç”¨æƒé™è®¾ç½®é¡µé¢
      const want: Want = {
        bundleName: 'com.ohos.settings',
        abilityName: 'com.ohos.settings.MainAbility',
        parameters: {
          SETTINGS_PARAM_TYPE: 'PERMISSION_MANAGER',
          SETTINGS_PARAM_BUNDLE_NAME: context.applicationInfo?.name || '',
          SETTINGS_PARAM_PERMISSION_NAME: 'ALL'
        }
      };

      context.startAbility(want)
        .then(() => {
          console.info('Successfully launched settings page');
        })
        .catch((err: Error) => {
          console.error(`Failed to launch settings page: ${err.message}`);
          // å¦‚æœç›´æ¥è·³è½¬å¤±è´¥ï¼Œå°è¯•è·³è½¬åˆ°åº”ç”¨ç®¡ç†é¡µé¢
          const alternativeWant: Want = {
            bundleName: 'com.ohos.settings',
            abilityName: 'com.ohos.settings.MainAbility',
            parameters: {
              SETTINGS_PARAM_TYPE: 'APP_MANAGEMENT',
              SETTINGS_PARAM_BUNDLE_NAME: context.applicationInfo?.name || ''
            }
          };
          
          return context.startAbility(alternativeWant);
        })
        .catch((err: Error) => {
          console.error(`Failed to launch alternative settings page: ${err.message}`);
          // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•è·³è½¬åˆ°ç³»ç»Ÿè®¾ç½®ä¸»é¡µ
          const fallbackWant: Want = {
            bundleName: 'com.ohos.settings',
            abilityName: 'com.ohos.settings.MainAbility'
          };
          
          return context.startAbility(fallbackWant);
        })
        .catch((err: Error) => {
          console.error(`All attempts to launch settings failed: ${err.message}`);
          promptAction.showToast({ message: "æ— æ³•æ‰“å¼€è®¾ç½®é¡µé¢ï¼Œè¯·æ‰‹åŠ¨å‰å¾€ç³»ç»Ÿè®¾ç½®>åº”ç”¨ç®¡ç†>æœ¬åº”ç”¨>æƒé™ç®¡ç†" });
        });
    } catch (error) {
      console.error(`Error launching settings: ${(error as Error).message || String(error)}`);
      promptAction.showToast({ message: "æ‰“å¼€è®¾ç½®é¡µé¢æ—¶å‡ºé”™ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®æƒé™" });
    }
  }

  build() {
    Stack() {
      Column().width('100%').height('100%').backgroundColor(this.bgColor)
        Column() {
          Row() {
            Text('å¾…åŠäº‹é¡¹')
            .fontSize(22).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
            Blank()
          Row({ space: 16 }) {
            Row() {
              Text('å¿…å¼€').fontSize(14).fontColor('#FFFFFF')
              Text('æƒé™').fontSize(14).fontColor('#FFFFFF')
            }
            .backgroundColor('rgba(255, 255, 255, 0.2)')
            .borderRadius(12).padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .margin({ right: 4 })
            .onClick(() => { this.startSystemSettingsGuidanceFlow(); })
            Text('+').fontSize(24).fontColor('#FFFFFF')
              .onClick(() => {
                this.newCollectionTitle = '';
                this.addCollectionDialogController.open();
              })
            Text('â‰¡').fontSize(24).fontColor('#FFFFFF')
              .onClick(() => {
                promptAction.showToast({ message: "æ›´å¤šèœå•å¾…å®ç°" });
              })
          }
        }
        .width('100%').height(50).padding({ left: 16, right: 16 })
        .linearGradient({ angle: 90, colors: [['#6A5ACD', 0.0], ['#1E90FF', 1.0]] })

        Scroll() {
          Column({ space: 12 }) {
            ForEach(this.todoCollections, (collection: LocalTodoCollection) => {
        Column() {
          Row() {
                  Text(collection.collectionTitle)
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                    .fontColor(collection.isSequenceActive ? '#FFA500' : '#333333')
                    .layoutWeight(1)
                    .onClick(() => {
                      this.toggleExpand(collection);
                    })

                  Text(collection.isExpanded ? "ğŸ”¼" : "ğŸ”½")
                      .width(24)
                      .height(24)
                    .fontSize(18)
                    .textAlign(TextAlign.Center)
                    .margin({ left: 8 })
                    .onClick(() => {
                      this.toggleExpand(collection);
                    })

                  Button(collection.isSequenceActive ? 'åºåˆ—è¿›è¡Œä¸­...' : 'å¼€å§‹åºåˆ—')
                    .fontSize(14)
                    .fontColor(Color.White)
                    .backgroundColor(collection.isSequenceActive ? '#FFA500' : '#1E90FF')
                    .borderRadius(12)
                    .height(32)
                    .padding({ left: 8, right: 8 })
                    .margin({ left: 10 })
                    .enabled(!collection.isSequenceActive &&
                    collection.subTasks.some(st => !st.isCompleted))
                    .onClick(() => {
                      this.startSequenceTask(collection, 0);
                    })
                    .visibility(collection.subTasks.length > 0 ? Visibility.Visible : Visibility.Hidden)
                  }
                  .width('100%')
                .padding({
                  top: 10,
                  bottom: 10,
                  left: 10,
                  right: 10
                })
                .backgroundColor(collection.isExpanded ? '#F0F8FF' : Color.White)
                .borderRadius(8)

                if (collection.isExpanded) {
                  Column({ space: 8 }) {
                    ForEach(collection.subTasks, (subTask: ActualTodoItem, index: number) => {
                        Row() {
                          Column() {
                          Text(subTask.title)
                              .fontSize(16)
                              .fontWeight(FontWeight.Medium)
                          Text(`${subTask.durationMinutes} åˆ†é’Ÿ`)
                              .fontSize(14)
                            .opacity(0.6)
                              .margin({ top: 4 })
                          }
                          .layoutWeight(1)
                        .alignItems(HorizontalAlign.Start)

                        if (subTask.isCompleted) {
                          Text('âœ“')
                            .fontSize(20)
                              .fontColor('#4CAF50')
                        } else if (collection.currentTaskIndex === index && collection.isSequenceActive) {
                          Text('â³')
                            .fontSize(20)
                            .fontColor('#FFA500')
                        }
                      }
                      .width('100%')
                      .padding(12)
                      .backgroundColor(subTask.isCompleted ? '#F5F5F5' : '#FFFFFF')
                      .borderRadius(8)
                      .margin({ top: index === 0 ? 8 : 0 })
                      .onClick(() => {
                        if (!subTask.isCompleted && !collection.isSequenceActive) {
                          // å¦‚æœç‚¹å‡»æœªå®Œæˆçš„å­ä»»åŠ¡ï¼Œä»è¯¥ä»»åŠ¡å¼€å§‹åºåˆ—
                          this.startSequenceTask(collection, index);
                        }
                      })
                    })
                  }
                  .width('100%')
                  .padding({
                    left: 8,
                    right: 8,
                    bottom: 8,
                    top: 8
                  })
                  .backgroundColor('rgba(0,0,0,0.02)')
                  .borderRadius(8)
                  .animation({
                    duration: 250,
                    curve: Curve.EaseInOut,
                    iterations: 1,
                    playMode: PlayMode.Normal
                  })
                }
              }
              .width('100%')
              .backgroundColor(Color.White)
              .borderRadius(10)
              .padding(12)
              .shadow({
                radius: 3,
                color: 'rgba(0,0,0,0.08)',
                offsetX: 1,
                offsetY: 2
              })
            })
          }
          .width('100%').padding(16)
        }
        .layoutWeight(1)
        
        // åº•éƒ¨å¯¼èˆªæ 
        TabBar({ currentIndex: 1 })
      }
      .width('100%').height('100%')

      if (this.showCongratulationsDialog) {
          Column() {
          // å…¼å®¹å†™æ³•ï¼šå¦‚æœ‰å›¾ç‰‡èµ„æºåˆ™ç”¨å›¾ç‰‡ï¼Œå¦åˆ™ç”¨Emoji
          // Image($r('app.media.congrats')).width(100).height(100).margin({bottom: 15})
          Text("ğŸ‰").fontSize(60).margin({ bottom: 15 }) // ä½¿ç”¨Emojiä½œä¸ºå ä½
          Text('å¤ªæ£’äº†!').fontSize(22).fontWeight(FontWeight.Bold).margin({ bottom: 8 })
          Text('ä½ å·²å®Œæˆå½“å‰åˆé›†ä¸­çš„æ‰€æœ‰ä»»åŠ¡!').fontSize(16).fontColor('#333333').margin({ bottom: 20 })
          Button('æˆ‘çŸ¥é“äº†')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('70%')
            .height(40)
            .backgroundColor('#1E90FF')
            .fontColor(Color.White)
          .onClick(() => {
              this.showCongratulationsDialog = false;
            })
        }
        .width('85%')
        .padding(25)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .shadow({
          radius: 10,
          color: 'rgba(0,0,0,0.2)',
          offsetX: 2,
          offsetY: 2
        })
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Center)
        .markAnchor({ x: '50%', y: '50%' }) // å±…ä¸­æ˜¾ç¤ºçš„å…³é”®
        .position({ x: '50%', y: '50%' })
        .transition(TransitionEffect.opacity(300)
          .combine(TransitionEffect.scale({
            x: 0.7,
            y: 0.7,
            centerX: '50%',
            centerY: '50%'
          })))
        .zIndex(10)
      }
    }
    .width('100%').height('100%')
  }
} 