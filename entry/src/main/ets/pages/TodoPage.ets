import { AddCollectionDialog } from '../components/dialogs/TodoDialogs';
import { AddSubTodoDialog } from '../components/AddSubTodoDialog';
import { TabBar } from '../components/TabBar';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../services/ThemeService';
import { 
  ApiService, 
  TodoCollection, 
  TodoCollectionItem,
  TodoCollectionRequest,
  TodoCollectionItemRequest
} from '../services/ApiService';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ToastOptions } from '../models/ToastOptions';
import { RouterOptions } from '../models/RouterOptions';
import { FocusTimerParams } from '../models/FocusTimerParams';
import { BusinessError } from '@ohos.base';

// ç”¨äºå¯¹è¯æ¡†çš„ç®€å•æ¥å£


// æ»‘åŠ¨æ“ä½œç›¸å…³æ¥å£
interface SwipeActionBuilder {
  builder: () => void;
  actionAreaDistance: number;
  onAction: () => void;
}

interface SwipeActionOptions {
  end: SwipeActionBuilder;
}

@Entry
@Component
struct TodoPage {
  @State todoCollections: TodoCollection[] = [];
  @State isLoadingCollections: boolean = false;
  @State expandedCollections: Set<number> = new Set(); // è®°å½•å“ªäº›åˆé›†æ˜¯å±•å¼€çš„
  @State collectionItems: Map<number, TodoCollectionItem[]> = new Map(); // åˆé›†ID -> å­å¾…åŠåˆ—è¡¨
  @State loadingItems: Set<number> = new Set(); // æ­£åœ¨åŠ è½½å­å¾…åŠçš„åˆé›†ID
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;

  private apiService: ApiService = ApiService.getInstance();
  private themeService: ThemeService = ThemeService.getInstance();
  private themeChangeListener = async () => {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
    } catch (error) {
      console.error('TodoPageä¸»é¢˜æ›´æ–°å¤±è´¥:', error);
    }
  };

  // å¾…åŠåˆé›†å¯¹è¯æ¡†æ§åˆ¶å™¨
  private addTodoCollectionDialogController: CustomDialogController | null = null;

  // æ·»åŠ å­å¾…åŠå¯¹è¯æ¡†æ§åˆ¶å™¨
  private addSubTodoDialogController: CustomDialogController | null = null;

  async aboutToAppear(): Promise<void> {
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    try {
      // é¦–å…ˆåŠ è½½ä¿å­˜çš„ä¸»é¢˜åå¥½è®¾ç½®
      await this.themeService.loadThemePreference();
      this.currentTheme = await this.themeService.getCurrentTheme();
      console.info('TodoPageåŠ è½½ä¸»é¢˜æˆåŠŸ:', this.currentTheme.name);
    } catch (error) {
      console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
    }
    await this.loadTodoCollections();
    // é»˜è®¤å±•å¼€æ‰€æœ‰åˆé›†ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
    await this.expandAllCollections();
  }

  aboutToDisappear() {
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  async onPageShow(): Promise<void> {
    await this.loadTodoCollections();
    // é»˜è®¤å±•å¼€æ‰€æœ‰åˆé›†ï¼ŒåŒ…æ‹¬æ–°åˆ›å»ºçš„
    await this.expandAllCollections();
  }

  // åŠ è½½å¾…åŠåˆé›†
  async loadTodoCollections(): Promise<void> {
    try {
      this.isLoadingCollections = true;
      const apiCollections = await this.apiService.getTodoCollections();
      this.todoCollections = apiCollections;
    } catch (error) {
      console.error('åŠ è½½å¾…åŠåˆé›†å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åŠ è½½å¾…åŠåˆé›†å¤±è´¥'));
    } finally {
      this.isLoadingCollections = false;
    }
  }

  // é»˜è®¤å±•å¼€æ‰€æœ‰åˆé›†ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
  async expandAllCollections(): Promise<void> {
    if (this.todoCollections.length === 0) return;
    
    console.info('é»˜è®¤å±•å¼€æ‰€æœ‰åˆé›†ï¼Œæå‡ç”¨æˆ·ä½“éªŒ');
    
    // å±•å¼€æ‰€æœ‰åˆé›†
    for (let collection of this.todoCollections) {
      this.expandedCollections.add(collection.id);
    }
    this.expandedCollections = new Set(this.expandedCollections);
    
    // åŠ è½½æ‰€æœ‰åˆé›†çš„å­ä»»åŠ¡
    for (let collection of this.todoCollections) {
      try {
        await this.loadCollectionItems(collection.id);
      } catch (error) {
        console.error(`è‡ªåŠ¨åŠ è½½åˆé›†${collection.id}çš„å­ä»»åŠ¡å¤±è´¥:`, error);
      }
    }
  }

  // é‡æ–°åŠ è½½å·²å±•å¼€åˆé›†çš„å­å¾…åŠæ•°æ®
  async reloadExpandedCollections(): Promise<void> {
    const expandedIds = Array.from(this.expandedCollections);
    console.info('é‡æ–°åŠ è½½å·²å±•å¼€åˆé›†çš„å­å¾…åŠæ•°æ®:', expandedIds);
    
    for (let collectionId of expandedIds) {
      try {
        await this.loadCollectionItems(collectionId);
    } catch (error) {
        console.error(`é‡æ–°åŠ è½½åˆé›†${collectionId}å­å¾…åŠå¤±è´¥:`, error);
      }
    }
  }

  // åŠ è½½åˆé›†å­å¾…åŠ
  async loadCollectionItems(collectionId: number): Promise<void> {
    try {
      console.info(`å¼€å§‹åŠ è½½åˆé›†${collectionId}çš„å­å¾…åŠæ•°æ®`);
      this.loadingItems.add(collectionId);
      this.loadingItems = new Set(this.loadingItems);
      
      const items = await this.apiService.getCollectionItems(collectionId);
      console.info(`æˆåŠŸåŠ è½½åˆé›†${collectionId}çš„å­å¾…åŠï¼Œæ•°é‡: ${items.length}`);
      
      this.collectionItems.set(collectionId, items);
      this.collectionItems = new Map(this.collectionItems);
    } catch (error) {
      console.error(`åŠ è½½åˆé›†${collectionId}å­å¾…åŠå¤±è´¥:`, error);
      promptAction.showToast(new ToastOptions('åŠ è½½å­å¾…åŠå¤±è´¥'));
      
      // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦è®¾ç½®ç©ºæ•°ç»„ï¼Œé¿å…ä¸€ç›´æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      this.collectionItems.set(collectionId, []);
      this.collectionItems = new Map(this.collectionItems);
    } finally {
      this.loadingItems.delete(collectionId);
      this.loadingItems = new Set(this.loadingItems);
      console.info(`åˆé›†${collectionId}å­å¾…åŠåŠ è½½å®Œæˆ`);
    }
  }

  // åˆ‡æ¢åˆé›†å±•å¼€/æŠ˜å çŠ¶æ€
  async toggleCollectionExpanded(collectionId: number): Promise<void> {
    if (this.expandedCollections.has(collectionId)) {
      // æŠ˜å 
      this.expandedCollections.delete(collectionId);
      this.expandedCollections = new Set(this.expandedCollections);
      console.info(`åˆé›†${collectionId}å·²æŠ˜å `);
    } else {
      // å±•å¼€
      this.expandedCollections.add(collectionId);
      this.expandedCollections = new Set(this.expandedCollections);
      console.info(`åˆé›†${collectionId}å·²å±•å¼€`);
      
      // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½å­å¾…åŠï¼Œåˆ™ç«‹å³åŠ è½½
      if (!this.collectionItems.has(collectionId)) {
        console.info(`å¼€å§‹åŠ è½½åˆé›†${collectionId}çš„å­å¾…åŠ`);
        await this.loadCollectionItems(collectionId);
      } else {
        console.info(`åˆé›†${collectionId}çš„å­å¾…åŠå·²ç¼“å­˜ï¼Œæ•°é‡: ${this.collectionItems.get(collectionId)?.length}`);
      }
    }
  }

  // åˆ›å»ºå¾…åŠåˆé›†
  async createTodoCollectionWithParams(title: string, description?: string): Promise<void> {
    try {
      const response = await this.apiService.createTodoCollectionDirect(title, description);
      this.todoCollections.push(response);
      this.todoCollections = Array.from(this.todoCollections);
      
      // è‡ªåŠ¨å±•å¼€æ–°åˆ›å»ºçš„åˆé›†ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
      this.expandedCollections.add(response.id);
      this.expandedCollections = new Set(this.expandedCollections);
      
      // åˆå§‹åŒ–æ–°åˆé›†çš„å­ä»»åŠ¡åˆ—è¡¨ä¸ºç©ºæ•°ç»„
      this.collectionItems.set(response.id, []);
      this.collectionItems = new Map(this.collectionItems);
      
      promptAction.showToast(new ToastOptions('å¾…åŠåˆé›†åˆ›å»ºæˆåŠŸ'));
    } catch (error) {
      console.error('åˆ›å»ºå¾…åŠåˆé›†å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åˆ›å»ºå¤±è´¥'));
    }
  }

  // åˆ é™¤å¾…åŠåˆé›† - æ»‘åŠ¨åˆ é™¤
  async deleteTodoCollection(collectionId: number): Promise<void> {
    try {
      await this.apiService.deleteTodoCollection(collectionId);
      this.todoCollections = this.todoCollections.filter(collection => collection.id !== collectionId);
      // æ¸…ç†ç›¸å…³çŠ¶æ€
      this.expandedCollections.delete(collectionId);
      this.collectionItems.delete(collectionId);
      this.loadingItems.delete(collectionId);
      this.expandedCollections = new Set(this.expandedCollections);
      this.collectionItems = new Map(this.collectionItems);
      this.loadingItems = new Set(this.loadingItems);
      promptAction.showToast(new ToastOptions('å¾…åŠåˆé›†å·²åˆ é™¤'));
    } catch (error) {
      console.error('åˆ é™¤å¾…åŠåˆé›†å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åˆ é™¤å¤±è´¥'));
    }
  }

  // æ·»åŠ å­å¾…åŠ - æ·»åŠ åè‡ªåŠ¨å±•å¼€
  async addSubTodo(collectionId: number, title: string, description?: string, durationMinutes: number = 25): Promise<void> {
    try {
      console.info(`å‘é€æ·»åŠ å­å¾…åŠè¯·æ±‚ - åˆé›†ID: ${collectionId}, æ ‡é¢˜: ${title}, æ—¶é•¿: ${durationMinutes}åˆ†é’Ÿ`);
      
      const newItem = await this.apiService.addItemToCollection(collectionId, {
        title,
        description,
        durationMinutes,
        orderIndex: 0
      });
      
      const existingItems = this.collectionItems.get(collectionId) || [];
      existingItems.push(newItem);
      this.collectionItems.set(collectionId, existingItems);
      this.collectionItems = new Map(this.collectionItems);
      
      // è‡ªåŠ¨å±•å¼€è¯¥åˆé›†
      if (!this.expandedCollections.has(collectionId)) {
        this.expandedCollections.add(collectionId);
        this.expandedCollections = new Set(this.expandedCollections);
        console.info(`æ·»åŠ å­ä»»åŠ¡åè‡ªåŠ¨å±•å¼€åˆé›†${collectionId}`);
      }
      
      promptAction.showToast(new ToastOptions('å­å¾…åŠæ·»åŠ æˆåŠŸ'));
    } catch (error) {
      console.error('æ·»åŠ å­å¾…åŠå¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('æ·»åŠ å­å¾…åŠå¤±è´¥'));
    }
  }

  // åˆ é™¤å­å¾…åŠ - æ»‘åŠ¨åˆ é™¤
  async deleteSubTodo(collectionId: number, itemId: number): Promise<void> {
    try {
      await this.apiService.deleteCollectionItem(collectionId, itemId);
      const items = this.collectionItems.get(collectionId) || [];
      const updatedItems = items.filter(item => item.id !== itemId);
      this.collectionItems.set(collectionId, updatedItems);
      this.collectionItems = new Map(this.collectionItems);
      promptAction.showToast(new ToastOptions('å­å¾…åŠå·²åˆ é™¤'));
    } catch (error) {
      console.error('åˆ é™¤å­å¾…åŠå¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åˆ é™¤å¤±è´¥'));
    }
  }

  // åˆ‡æ¢å­å¾…åŠå®ŒæˆçŠ¶æ€
  async toggleSubTodoStatus(collectionId: number, itemId: number): Promise<void> {
    try {
      const items = this.collectionItems.get(collectionId) || [];
      const item = items.find(i => i.id === itemId);
      if (!item) return;

      await this.apiService.toggleCollectionItemStatus(collectionId, itemId);
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      item.isCompleted = !item.isCompleted;
      this.collectionItems.set(collectionId, [...items]);
      this.collectionItems = new Map(this.collectionItems);
      
      promptAction.showToast(new ToastOptions(item.isCompleted ? 'ä»»åŠ¡å·²å®Œæˆ' : 'ä»»åŠ¡å·²é‡æ–°å¼€å¯'));
    } catch (error) {
      console.error('æ›´æ–°å­å¾…åŠçŠ¶æ€å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('æ›´æ–°å¤±è´¥'));
    }
  }

  // å¼€å§‹ä¸“æ³¨å­å¾…åŠ
  startFocusForSubTodo(collectionId: number, itemId: number): void {
    const items = this.collectionItems.get(collectionId) || [];
    const item = items.find(i => i.id === itemId);
    if (!item) return;

    const focusParams: FocusTimerParams = {
      title: item.title,
      time: (item.durationMinutes || 25) * 60,
      taskTitle: item.title,
      isSequence: true,
      collectionId: collectionId.toString(),
      subTaskId: itemId.toString(),
      currentSubTaskIndex: items.findIndex(i => i.id === itemId),
      totalSubTasksInCollection: items.length
    };

    router.pushUrl({ url: 'pages/FocusTimer', params: focusParams });
  }

  // å¼€å§‹åºåˆ—ä¸“æ³¨ï¼ˆæ•´ä¸ªåˆé›†ï¼‰
  startSequenceFocus(collectionId: number): void {
    const items = this.collectionItems.get(collectionId) || [];
    const uncompletedItems = items.filter(item => !item.isCompleted);
    
    if (uncompletedItems.length === 0) {
      promptAction.showToast(new ToastOptions('è¯¥åˆé›†ä¸­æ²¡æœ‰æœªå®Œæˆçš„ä»»åŠ¡'));
      return;
    }

    const firstItem = uncompletedItems[0];
    const focusParams: FocusTimerParams = {
      title: firstItem.title,
      time: (firstItem.durationMinutes || 25) * 60,
      taskTitle: firstItem.title,
      isSequence: true,
      collectionId: collectionId.toString(),
      subTaskId: firstItem.id.toString(),
      currentSubTaskIndex: 0,
      totalSubTasksInCollection: uncompletedItems.length
    };

    router.pushUrl({ url: 'pages/FocusTimer', params: focusParams });
  }

  // è‹¹æœé£æ ¼çš„åˆé›†å¡ç‰‡ç»„ä»¶ - æ”¯æŒæ»‘åŠ¨åˆ é™¤
  @Builder
  CollectionCard(collection: TodoCollection) {
    // ä½¿ç”¨ListItemæ¥å®ç°æ»‘åŠ¨åˆ é™¤
    ListItem() {
      Column() {
        // åˆé›†æ ‡é¢˜åŒºåŸŸ
        Row() {
                  Column() {
          Text(collection.title)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTheme.textColor)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          
          Text(collection.description || '')
            .fontSize(14)
            .fontColor(this.currentTheme.textColor)
            .opacity(0.6)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 4 })
            .visibility(collection.description ? Visibility.Visible : Visibility.None)
        }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          // å±•å¼€/æŠ˜å æŒ‰é’®
          Button() {
            Text(this.expandedCollections.has(collection.id) ? 'â–¼' : 'â–¶')
              .fontSize(14)
              .fontColor(this.currentTheme.glassmorphism.accentPrimary)
          }
          .backgroundColor('transparent')
          .width(32)
          .height(32)
          .onClick(() => {
            this.toggleCollectionExpanded(collection.id);
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 12 })

        // æ“ä½œæŒ‰é’®åŒºåŸŸ - è‹¹æœé£æ ¼æ¸å˜è®¾è®¡
        Row({ space: 8 }) {
          Button('ğŸ“ æ·»åŠ å­ä»»åŠ¡')
            .fontSize(12)
            .fontColor(this.currentTheme.glassmorphism.accentPrimary)
            .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
            .borderRadius(16)
            .height(32)
            .padding({ left: 12, right: 12 })
            .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
            .shadow({
              radius: 4,
              color: this.currentTheme.glassmorphism.shadowSoft,
              offsetX: 0,
              offsetY: 1
            })
            .onClick(() => {
              this.showAddSubTodoDialog(collection.id);
            })

          Button('ğŸš€ å¼€å§‹åºåˆ—')
            .fontSize(12)
            .fontColor('#FFFFFF')
            .linearGradient({
              angle: 135,
              colors: [
                [this.currentTheme.glassmorphism.accentPrimary, 0.0],
                [this.currentTheme.glassmorphism.accentSecondary, 1.0]
              ]
            })
            .borderRadius(16)
            .height(32)
            .padding({ left: 12, right: 12 })
            .shadow({
              radius: 6,
              color: this.currentTheme.glassmorphism.accentPrimary + '40',
              offsetX: 0,
              offsetY: 2
            })
            .blur(0.3) // è½»å¾®å“‘å…‰æ•ˆæœ
            .onClick(() => {
              this.startSequenceFocus(collection.id);
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })

        // å­å¾…åŠåˆ—è¡¨
        Column() {
          Divider()
            .color(this.currentTheme.glassmorphism.borderLight)
            .margin({ left: 16, right: 16 })

          // åŠ è½½çŠ¶æ€
          Row() {
            LoadingProgress()
              .width(20)
              .height(20)
              .color(this.currentTheme.glassmorphism.accentPrimary)
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.6)
              .margin({ left: 8 })
          }
          .width('100%')
          .height(60)
          .justifyContent(FlexAlign.Center)
          .visibility(this.loadingItems.has(collection.id) ? Visibility.Visible : Visibility.None)

          // ç©ºçŠ¶æ€
          Text('æš‚æ— å­ä»»åŠ¡')
            .fontSize(14)
            .fontColor(this.currentTheme.textColor)
            .opacity(0.5)
            .width('100%')
            .height(60)
            .textAlign(TextAlign.Center)
            .padding({ top: 20 })
            .visibility(!this.loadingItems.has(collection.id) && (this.collectionItems.get(collection.id) || []).length === 0 ? Visibility.Visible : Visibility.None)

          // å­ä»»åŠ¡åˆ—è¡¨
          List() {
            ForEach(this.collectionItems.get(collection.id) || [], (item: TodoCollectionItem) => {
              this.SubTodoItem(collection.id, item);
            }, (item: TodoCollectionItem) => item.id.toString())
          }
          .width('100%')
          .backgroundColor('transparent')
          .divider({ strokeWidth: 0 })
          .visibility(!this.loadingItems.has(collection.id) && (this.collectionItems.get(collection.id) || []).length > 0 ? Visibility.Visible : Visibility.None)
        }
        .visibility(this.expandedCollections.has(collection.id) ? Visibility.Visible : Visibility.None)
      }
      .width('100%')
      .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
      .borderRadius(16)
      .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
      .shadow({
        radius: 8,
        color: this.currentTheme.glassmorphism.shadowSoft,
        offsetX: 0,
        offsetY: 4
      })
      .margin({ bottom: 16 })
    }
    .swipeAction(this.createDeleteAction(collection.id, 80))
  }

  // è‹¹æœé£æ ¼çš„å­å¾…åŠé¡¹ç»„ä»¶ - æ”¯æŒæ»‘åŠ¨åˆ é™¤
  @Builder
  SubTodoItem(collectionId: number, item: TodoCollectionItem) {
    ListItem() {
      Row() {
        // å®ŒæˆçŠ¶æ€æŒ‰é’®
        Button() {
          Text(item.isCompleted ? 'âœ“' : 'â—‹')
            .fontSize(16)
            .fontColor(item.isCompleted ? '#FFFFFF' : this.currentTheme.glassmorphism.accentPrimary)
        }
        .width(32)
        .height(32)
        .borderRadius(16)
        .backgroundColor(item.isCompleted ? this.currentTheme.glassmorphism.accentPrimary : 'transparent')
        .border({ 
          width: 2, 
          color: this.currentTheme.glassmorphism.accentPrimary 
        })
        .onClick(() => {
          this.toggleSubTodoStatus(collectionId, item.id);
        })

        // ä»»åŠ¡ä¿¡æ¯
        Column() {
          Text(item.title)
            .fontSize(16)
            .fontColor(this.currentTheme.textColor)
            .opacity(item.isCompleted ? 0.5 : 1.0)
            .decoration({ type: item.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // æè¿°æ–‡æœ¬ - ä¸»é¢˜æ„ŸçŸ¥æ¸å˜æ ·å¼
          Stack() {
            // æ¸å˜èƒŒæ™¯
            Text(item.description || '')
              .fontSize(12)
              .fontColor('transparent')
              .linearGradient({
                angle: 90,
                colors: item.isCompleted ? [
                  [this.currentTheme.glassmorphism.accentTertiary, 0.0],
                  [this.currentTheme.glassmorphism.borderLight, 1.0]
                ] : [
                  [this.currentTheme.glassmorphism.accentSecondary, 0.0],
                  [this.currentTheme.glassmorphism.accentPrimary, 1.0]
                ]
              })
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .blur(0.2) // è½»å¾®å“‘å…‰æ•ˆæœ

            // æ–‡å­—å†…å®¹
            Text(item.description || '')
              .fontSize(12)
              .fontColor(item.isCompleted ? 
                this.currentTheme.glassmorphism.accentTertiary : 
                this.currentTheme.glassmorphism.accentSecondary)
              .opacity(item.isCompleted ? 0.5 : 0.8)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .margin({ top: 2 })
          .visibility(item.description ? Visibility.Visible : Visibility.None)

          Stack() {
            // æ¸å˜èƒŒæ™¯
            Text(`â±ï¸ ${item.durationMinutes || 25}åˆ†é’Ÿ`)
              .fontSize(12)
              .fontColor('transparent')
              .linearGradient({
                angle: 45,
                colors: [
                  [this.currentTheme.glassmorphism.accentPrimary, 0.0],
                  [this.currentTheme.glassmorphism.accentSecondary, 1.0]
                ]
              })
              .fontWeight(FontWeight.Medium)
              .blur(0.1) // è½»å¾®å“‘å…‰æ•ˆæœ

            // æ–‡å­—å†…å®¹
            Text(`â±ï¸ ${item.durationMinutes || 25}åˆ†é’Ÿ`)
              .fontSize(12)
              .fontColor(this.currentTheme.glassmorphism.accentPrimary)
              .fontWeight(FontWeight.Medium)
          }
          .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12 })

        // ä¸“æ³¨æŒ‰é’® - ä¸»é¢˜æ„ŸçŸ¥æ¸å˜å“‘å…‰è®¾è®¡
        Stack() {
          // æ¸å˜èƒŒæ™¯å±‚
          Column()
            .width(34)
            .height(34)
            .borderRadius(16)
            .linearGradient({
              angle: 135,
              colors: [
                [this.currentTheme.glassmorphism.accentPrimary, 0.0],
                [this.currentTheme.glassmorphism.accentSecondary, 0.5],
                [this.currentTheme.glassmorphism.accentTertiary, 1.0]
              ]
            })
            .shadow({
              radius: 10,
              color: this.currentTheme.glassmorphism.accentPrimary + '40',
              offsetX: 0,
              offsetY: 3
            })
            .border({ 
              width: 0.5, 
              color: this.currentTheme.glassmorphism.accentPrimary + '60' 
            })
            .blur(0.6) // å¢å¼ºå“‘å…‰æ•ˆæœ

          // æŒ‰é’®å†…å®¹
          Button('ğŸ¯')
            .fontSize(12)
            .fontColor('#FFFFFF')
            .backgroundColor('transparent')
            .borderRadius(16)
            .width(34)
            .height(34)
            .onClick(() => {
              this.startFocusForSubTodo(collectionId, item.id);
            })
        }
        .visibility(item.isCompleted ? Visibility.None : Visibility.Visible)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(this.currentTheme.backgroundColor)
      .borderRadius(12)
      .margin({ left: 8, right: 8, top: 4, bottom: 4 })
    }
    .swipeAction(this.createSubTodoDeleteAction(collectionId, item.id, 60))
  }

  // æ˜¾ç¤ºæ·»åŠ åˆé›†å¯¹è¯æ¡†
  async showAddTodoCollectionDialog(): Promise<void> {
    try {
      // é¢„å…ˆè·å–å½“å‰ä¸»é¢˜ï¼Œç¡®ä¿å¼¹çª—æ˜¾ç¤ºæ—¶ä¸»é¢˜å·²åŠ è½½
      const currentTheme = await this.themeService.getCurrentTheme();
      console.info('å‡†å¤‡æ‰“å¼€æ·»åŠ åˆé›†å¼¹çª—ï¼Œå½“å‰ä¸»é¢˜:', currentTheme.name);
      
      // æ¯æ¬¡æ‰“å¼€æ—¶é‡æ–°åˆ›å»ºï¼Œç¡®ä¿è·å–æœ€æ–°ä¸»é¢˜
      this.addTodoCollectionDialogController = new CustomDialogController({
        builder: AddCollectionDialog({
          currentTheme: currentTheme, // ä¼ é€’å½“å‰ä¸»é¢˜
          onConfirm: (title: string, description?: string) => {
            this.createTodoCollectionWithParams(title, description);
          }
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center,
        customStyle: true, // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼
        maskColor: Color.Transparent // å»æ‰é»˜è®¤çš„é®ç½©é¢œè‰²
      });
      this.addTodoCollectionDialogController.open();
    } catch (error) {
      console.error('æ‰“å¼€æ·»åŠ åˆé›†å¼¹çª—å¤±è´¥:', error);
    }
  }

  // æ˜¾ç¤ºæ·»åŠ å­å¾…åŠå¯¹è¯æ¡†
  async showAddSubTodoDialog(collectionId: number): Promise<void> {
    try {
      // é¢„å…ˆè·å–å½“å‰ä¸»é¢˜ï¼Œç¡®ä¿å¼¹çª—æ˜¾ç¤ºæ—¶ä¸»é¢˜å·²åŠ è½½
      const currentTheme = await this.themeService.getCurrentTheme();
      console.info('å‡†å¤‡æ‰“å¼€æ·»åŠ å­å¾…åŠå¼¹çª—ï¼Œå½“å‰ä¸»é¢˜:', currentTheme.name);
      
      // æ¯æ¬¡æ‰“å¼€æ—¶é‡æ–°åˆ›å»ºï¼Œç¡®ä¿è·å–æœ€æ–°ä¸»é¢˜
      this.addSubTodoDialogController = new CustomDialogController({
        builder: AddSubTodoDialog({
          currentTheme: currentTheme, // ä¼ é€’å½“å‰ä¸»é¢˜
          onConfirm: (title: string, description: string, duration: number) => {
            this.addSubTodo(collectionId, title, description, duration);
          }
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center,
        customStyle: true, // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼
        maskColor: Color.Transparent // å»æ‰é»˜è®¤çš„é®ç½©é¢œè‰²
      });
      this.addSubTodoDialogController.open();
    } catch (error) {
      console.error('æ‰“å¼€æ·»åŠ å­å¾…åŠå¼¹çª—å¤±è´¥:', error);
    }
  }

  // åˆ›å»ºåˆ é™¤åˆé›†çš„æ»‘åŠ¨æ“ä½œ
  private createDeleteAction(collectionId: number, width: number): SwipeActionOptions {
    const deleteAction: SwipeActionOptions = {
      end: {
        builder: () => {
          this.createDeleteButton(width, 16, () => {
            this.deleteTodoCollection(collectionId);
          });
        },
        actionAreaDistance: width,
        onAction: () => {
          this.deleteTodoCollection(collectionId);
        }
      } as SwipeActionBuilder
    };
    return deleteAction;
  }

  // åˆ›å»ºåˆ é™¤å­å¾…åŠçš„æ»‘åŠ¨æ“ä½œ
  private createSubTodoDeleteAction(collectionId: number, itemId: number, width: number): SwipeActionOptions {
    const deleteAction: SwipeActionOptions = {
      end: {
        builder: () => {
          this.createDeleteButton(width, 12, () => {
            this.deleteSubTodo(collectionId, itemId);
          });
        },
        actionAreaDistance: width,
        onAction: () => {
          this.deleteSubTodo(collectionId, itemId);
        }
      } as SwipeActionBuilder
    };
    return deleteAction;
  }

  // åˆ›å»ºåˆ é™¤æŒ‰é’®çš„æ„å»ºå™¨
  @Builder
  private createDeleteButton(width: number, borderRadius: number, clickAction: () => void) {
    Button('åˆ é™¤')
      .fontSize(width > 70 ? 16 : 14)
      .fontColor('#FFFFFF')
      .backgroundColor('#FF3B30')
      .borderRadius(borderRadius)
      .width(width)
      .height(width > 70 ? '100%' : '90%')
      .onClick(clickAction)
  }

  build() {
    Column() {
      // è‹¹æœé£æ ¼çš„é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('ğŸ“ å¾…åŠç®¡ç†')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.currentTheme.textColor)
          .layoutWeight(1)

        Button() {
          Text('ï¼‹')
            .fontSize(20)
            .fontColor('#FFFFFF')
        }
        .width(36)
        .height(36)
        .borderRadius(18)
        .linearGradient({
          angle: 135,
          colors: [
            [this.currentTheme.glassmorphism.accentPrimary, 0.0],
            [this.currentTheme.glassmorphism.accentSecondary, 1.0]
          ]
        })
        .shadow({
          radius: 10,
          color: this.currentTheme.glassmorphism.accentPrimary + '50',
          offsetX: 0,
          offsetY: 3
        })
        .blur(0.3) // å“‘å…‰æ•ˆæœ
        .onClick(() => {
          this.showAddTodoCollectionDialog();
        })
      }
      .width('100%')
      .height(64)
      .padding({ left: 20, right: 20 })
      .backgroundColor(this.currentTheme.backgroundColor)

      // ä¸»å†…å®¹åŒºåŸŸ
      // åŠ è½½çŠ¶æ€
      Column() {
        LoadingProgress()
          .width(40)
          .height(40)
          .color(this.currentTheme.glassmorphism.accentPrimary)
        Text('åŠ è½½ä¸­...')
          .fontSize(16)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.6)
          .margin({ top: 16 })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.currentTheme.backgroundColor)
      .visibility(this.isLoadingCollections ? Visibility.Visible : Visibility.None)

      // ç©ºçŠ¶æ€
      Column() {
        Text('ğŸ“‹')
          .fontSize(64)
          .opacity(0.3)
          .margin({ bottom: 16 })
        Text('è¿˜æ²¡æœ‰å¾…åŠåˆé›†')
          .fontSize(18)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.5)
          .margin({ bottom: 8 })
        Text('ç‚¹å‡»å³ä¸Šè§’ + å·åˆ›å»ºç¬¬ä¸€ä¸ªåˆé›†')
          .fontSize(14)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.4)
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.currentTheme.backgroundColor)
      .visibility(!this.isLoadingCollections && this.todoCollections.length === 0 ? Visibility.Visible : Visibility.None)

      // åˆé›†åˆ—è¡¨ - æ”¯æŒæ»‘åŠ¨åˆ é™¤
      List() {
        ForEach(this.todoCollections, (collection: TodoCollection) => {
          this.CollectionCard(collection);
        }, (collection: TodoCollection) => collection.id.toString())
      }
      .layoutWeight(1)
      .backgroundColor(this.currentTheme.backgroundColor)
      .scrollBar(BarState.Off)
      .padding({ left: 16, right: 16, top: 16, bottom: 100 })
      .divider({ strokeWidth: 0 })
      .visibility(!this.isLoadingCollections && this.todoCollections.length > 0 ? Visibility.Visible : Visibility.None)

      // åº•éƒ¨å¯¼èˆªæ 
      TabBar({ currentIndex: 1 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.currentTheme.backgroundColor)
  }
}