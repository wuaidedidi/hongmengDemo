import { AddTodoCollectionDialog } from '../components/AddTodoCollectionDialog';
import { AddSubTodoDialog } from '../components/AddSubTodoDialog';
import { TabBar } from '../components/TabBar';
import { ThemeService, ThemeConfig } from '../services/ThemeService';
import { 
  ApiService, 
  TodoCollection, 
  TodoCollectionItem,
  TodoCollectionRequest,
  TodoCollectionItemRequest
} from '../services/ApiService';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ToastOptions } from '../models/ToastOptions';
import { RouterOptions } from '../models/RouterOptions';
import { FocusTimerParams } from '../models/FocusTimerParams';
import { BusinessError } from '@ohos.base';

// ç”¨äºå¯¹è¯æ¡†çš„ç®€å•æ¥å£
interface DialogData {
  title: string;
  description?: string;
}

@Entry
@Component
struct TodoPage {
  @State todoCollections: TodoCollection[] = [];
  @State isLoadingCollections: boolean = false;
  @State expandedCollections: Set<number> = new Set(); // è®°å½•å“ªäº›åˆé›†æ˜¯å±•å¼€çš„
  @State collectionItems: Map<number, TodoCollectionItem[]> = new Map(); // åˆé›†ID -> å­å¾…åŠåˆ—è¡¨
  @State loadingItems: Set<number> = new Set(); // æ­£åœ¨åŠ è½½å­å¾…åŠçš„åˆé›†ID
  @State currentTheme: ThemeConfig = {
    id: 'light',
    name: 'æµ…è‰²ä¸»é¢˜',
    primaryColor: '#007AFF',
    backgroundColor: '#FFFFFF',
    textColor: '#000000',
    cardBackgroundColor: '#F8F8F8',
    borderColor: '#E0E0E0',
    shadowColor: 'rgba(0, 0, 0, 0.1)',
    errorColor: '#FF3B30'
  };

  private apiService: ApiService = ApiService.getInstance();
  private themeService: ThemeService = ThemeService.getInstance();

  // å¾…åŠåˆé›†å¯¹è¯æ¡†æ§åˆ¶å™¨
  private addTodoCollectionDialogController: CustomDialogController = new CustomDialogController({
    builder: AddTodoCollectionDialog({
      onConfirm: (data: DialogData) => {
        this.createTodoCollectionWithParams(data.title, data.description);
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  // æ·»åŠ å­å¾…åŠå¯¹è¯æ¡†æ§åˆ¶å™¨
  private addSubTodoDialogController: CustomDialogController | null = null;

  async aboutToAppear(): Promise<void> {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
    } catch (error) {
      console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
    }
    await this.loadTodoCollections();
  }

  async onPageShow(): Promise<void> {
    await this.loadTodoCollections();
    // ç¡®ä¿é‡æ–°åŠ è½½å·²å±•å¼€åˆé›†çš„å­å¾…åŠæ•°æ®
    await this.reloadExpandedCollections();
  }

  // åŠ è½½å¾…åŠåˆé›†
  async loadTodoCollections(): Promise<void> {
    try {
      this.isLoadingCollections = true;
      const apiCollections = await this.apiService.getTodoCollections();
      this.todoCollections = apiCollections;
    } catch (error) {
      console.error('åŠ è½½å¾…åŠåˆé›†å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åŠ è½½å¾…åŠåˆé›†å¤±è´¥'));
    } finally {
      this.isLoadingCollections = false;
    }
  }

  // é‡æ–°åŠ è½½å·²å±•å¼€åˆé›†çš„å­å¾…åŠæ•°æ®
  async reloadExpandedCollections(): Promise<void> {
    const expandedIds = Array.from(this.expandedCollections);
    console.info('é‡æ–°åŠ è½½å·²å±•å¼€åˆé›†çš„å­å¾…åŠæ•°æ®:', expandedIds);
    
    for (let collectionId of expandedIds) {
      try {
        await this.loadCollectionItems(collectionId);
      } catch (error) {
        console.error(`é‡æ–°åŠ è½½åˆé›†${collectionId}å­å¾…åŠå¤±è´¥:`, error);
      }
    }
  }

  // åŠ è½½åˆé›†å­å¾…åŠ
  async loadCollectionItems(collectionId: number): Promise<void> {
    try {
      console.info(`å¼€å§‹åŠ è½½åˆé›†${collectionId}çš„å­å¾…åŠæ•°æ®`);
      this.loadingItems.add(collectionId);
      this.loadingItems = new Set(this.loadingItems);
      
      const items = await this.apiService.getCollectionItems(collectionId);
      console.info(`æˆåŠŸåŠ è½½åˆé›†${collectionId}çš„å­å¾…åŠï¼Œæ•°é‡: ${items.length}`);
      
      this.collectionItems.set(collectionId, items);
      this.collectionItems = new Map(this.collectionItems);
    } catch (error) {
      console.error(`åŠ è½½åˆé›†${collectionId}å­å¾…åŠå¤±è´¥:`, error);
      promptAction.showToast(new ToastOptions('åŠ è½½å­å¾…åŠå¤±è´¥'));
      
      // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦è®¾ç½®ç©ºæ•°ç»„ï¼Œé¿å…ä¸€ç›´æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      this.collectionItems.set(collectionId, []);
      this.collectionItems = new Map(this.collectionItems);
    } finally {
      this.loadingItems.delete(collectionId);
      this.loadingItems = new Set(this.loadingItems);
      console.info(`åˆé›†${collectionId}å­å¾…åŠåŠ è½½å®Œæˆ`);
    }
  }

  // åˆ‡æ¢åˆé›†å±•å¼€/æŠ˜å çŠ¶æ€
  async toggleCollectionExpanded(collectionId: number): Promise<void> {
    if (this.expandedCollections.has(collectionId)) {
      // æŠ˜å 
      this.expandedCollections.delete(collectionId);
      this.expandedCollections = new Set(this.expandedCollections);
      console.info(`åˆé›†${collectionId}å·²æŠ˜å `);
    } else {
      // å±•å¼€
      this.expandedCollections.add(collectionId);
      this.expandedCollections = new Set(this.expandedCollections);
      console.info(`åˆé›†${collectionId}å·²å±•å¼€`);
      
      // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½å­å¾…åŠï¼Œåˆ™ç«‹å³åŠ è½½
      if (!this.collectionItems.has(collectionId)) {
        console.info(`å¼€å§‹åŠ è½½åˆé›†${collectionId}çš„å­å¾…åŠ`);
        await this.loadCollectionItems(collectionId);
      } else {
        console.info(`åˆé›†${collectionId}çš„å­å¾…åŠå·²ç¼“å­˜ï¼Œæ•°é‡: ${this.collectionItems.get(collectionId)?.length}`);
      }
    }
  }

  // åˆ›å»ºå¾…åŠåˆé›†
  async createTodoCollectionWithParams(title: string, description?: string): Promise<void> {
    try {
      const response = await this.apiService.createTodoCollectionDirect(title, description);
      this.todoCollections.push(response);
      this.todoCollections = Array.from(this.todoCollections);
      promptAction.showToast(new ToastOptions('å¾…åŠåˆé›†åˆ›å»ºæˆåŠŸ'));
    } catch (error) {
      console.error('åˆ›å»ºå¾…åŠåˆé›†å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åˆ›å»ºå¤±è´¥'));
    }
  }

  // åˆ é™¤å¾…åŠåˆé›†
  async deleteTodoCollection(collectionId: number): Promise<void> {
    try {
      await this.apiService.deleteTodoCollection(collectionId);
      this.todoCollections = this.todoCollections.filter(collection => collection.id !== collectionId);
      // æ¸…ç†ç›¸å…³çŠ¶æ€
      this.expandedCollections.delete(collectionId);
      this.collectionItems.delete(collectionId);
      this.loadingItems.delete(collectionId);
      this.expandedCollections = new Set(this.expandedCollections);
      this.collectionItems = new Map(this.collectionItems);
      this.loadingItems = new Set(this.loadingItems);
      promptAction.showToast(new ToastOptions('å¾…åŠåˆé›†å·²åˆ é™¤'));
    } catch (error) {
      console.error('åˆ é™¤å¾…åŠåˆé›†å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åˆ é™¤å¤±è´¥'));
    }
  }

  // æ·»åŠ å­å¾…åŠ
  async addSubTodo(collectionId: number, title: string, description?: string, durationMinutes: number = 25): Promise<void> {
    try {
      const newItem = await this.apiService.addItemToCollection(collectionId, {
        title,
        description,
        order: 0  // åç«¯ä¼šè‡ªåŠ¨å¤„ç†é¡ºåº
      });
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      const existingItems = this.collectionItems.get(collectionId) || [];
      existingItems.push(newItem);
      this.collectionItems.set(collectionId, existingItems);
      this.collectionItems = new Map(this.collectionItems);
      
      promptAction.showToast(new ToastOptions('å­å¾…åŠæ·»åŠ æˆåŠŸ'));
    } catch (error) {
      console.error('æ·»åŠ å­å¾…åŠå¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('æ·»åŠ å­å¾…åŠå¤±è´¥'));
    }
  }

  // åˆ é™¤å­å¾…åŠ
  async deleteSubTodo(collectionId: number, itemId: number): Promise<void> {
    try {
      await this.apiService.deleteCollectionItem(collectionId, itemId);
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      const existingItems = this.collectionItems.get(collectionId) || [];
      const updatedItems = existingItems.filter(item => item.id !== itemId);
      this.collectionItems.set(collectionId, updatedItems);
      this.collectionItems = new Map(this.collectionItems);
      
      promptAction.showToast(new ToastOptions('å­å¾…åŠå·²åˆ é™¤'));
    } catch (error) {
      console.error('åˆ é™¤å­å¾…åŠå¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('åˆ é™¤å¤±è´¥'));
    }
  }

  // åˆ‡æ¢å­å¾…åŠå®ŒæˆçŠ¶æ€
  async toggleSubTodoStatus(collectionId: number, itemId: number): Promise<void> {
    try {
      const updatedItem = await this.apiService.toggleCollectionItemStatus(collectionId, itemId);
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      const existingItems = this.collectionItems.get(collectionId) || [];
      const index = existingItems.findIndex(item => item.id === itemId);
      if (index !== -1) {
        existingItems[index] = updatedItem;
        this.collectionItems.set(collectionId, [...existingItems]);
        this.collectionItems = new Map(this.collectionItems);
      }
      
      const message = updatedItem.completed ? 'å­å¾…åŠå·²å®Œæˆ' : 'å­å¾…åŠå·²é‡æ–°æ¿€æ´»';
      promptAction.showToast(new ToastOptions(message));
    } catch (error) {
      console.error('æ›´æ–°å­å¾…åŠçŠ¶æ€å¤±è´¥:', error);
      promptAction.showToast(new ToastOptions('æ›´æ–°çŠ¶æ€å¤±è´¥'));
    }
  }

  // å¼€å§‹å•ä¸ªå­å¾…åŠä¸“æ³¨
  startFocusForSubTodo(collectionId: number, itemId: number): void {
    const items = this.collectionItems.get(collectionId) || [];
    console.info(`å¼€å§‹å•ä¸ªå­å¾…åŠä¸“æ³¨ - åˆé›†ID: ${collectionId}, å­å¾…åŠID: ${itemId}, æ€»æ•°: ${items.length}`);
    
    const currentIndex = items.findIndex(item => item.id === itemId);
    
    if (currentIndex === -1) {
      console.error(`æ‰¾ä¸åˆ°å­å¾…åŠ ${itemId} åœ¨åˆé›† ${collectionId} ä¸­`);
      promptAction.showToast(new ToastOptions('æ‰¾ä¸åˆ°æŒ‡å®šçš„å­å¾…åŠ'));
      return;
    }

    const currentItem = items[currentIndex];
    console.info(`å½“å‰ä»»åŠ¡ä¿¡æ¯:`, { id: currentItem.id, title: currentItem.title, index: currentIndex });
    
    const params: FocusTimerParams = {
      title: currentItem.title,
      taskTitle: currentItem.title,
      time: 25 * 60, // é»˜è®¤25åˆ†é’Ÿï¼Œå› ä¸ºApiServiceä¸­çš„TodoCollectionItemæ²¡æœ‰durationMinuteså±æ€§
      isSequence: true,
      collectionId: collectionId.toString(),
      subTaskId: itemId.toString(),
      currentSubTaskIndex: currentIndex,
      totalSubTasksInCollection: items.length
    };

    console.info(`å¯åŠ¨ä¸“æ³¨å‚æ•°:`, JSON.stringify(params));

    const routerOpts = new RouterOptions('pages/FocusTimer');
    router.pushUrl({
      url: routerOpts.url,
      params: params
    }, router.RouterMode.Single, (err: BusinessError) => {
      if (err) {
        console.error(`è·³è½¬FocusTimerå‡ºé”™: ${err.message}`);
      }
    });
  }

  // å¼€å§‹åˆé›†åºåˆ—ä¸“æ³¨ï¼ˆä»ç¬¬ä¸€ä¸ªå¼€å§‹ï¼‰
  async startFocusForCollection(collection: TodoCollection): Promise<void> {
    console.info(`å¼€å§‹åˆé›†åºåˆ—ä¸“æ³¨ - åˆé›†: ${collection.title}`);
    
    // è‡ªåŠ¨å±•å¼€åˆé›†ï¼ˆå¦‚æœæœªå±•å¼€ï¼‰
    if (!this.expandedCollections.has(collection.id)) {
      console.info(`è‡ªåŠ¨å±•å¼€åˆé›†${collection.id}`);
      this.expandedCollections.add(collection.id);
      this.expandedCollections = new Set(this.expandedCollections);
    }
    
    // ç¡®ä¿å·²åŠ è½½å­å¾…åŠæ•°æ®
    if (!this.collectionItems.has(collection.id)) {
      console.info(`åˆé›†${collection.id}çš„å­å¾…åŠæ•°æ®æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½...`);
      try {
        await this.loadCollectionItems(collection.id);
      } catch (error) {
        console.error('åŠ è½½å­å¾…åŠæ•°æ®å¤±è´¥:', error);
        promptAction.showToast(new ToastOptions('åŠ è½½å­å¾…åŠæ•°æ®å¤±è´¥'));
        return;
      }
    }
    
    const items = this.collectionItems.get(collection.id) || [];
    console.info(`åˆé›†åºåˆ—ä¸“æ³¨ - å­å¾…åŠæ•°é‡: ${items.length}`);
    
    if (items.length === 0) {
      console.warn('åˆé›†ä¸­æ²¡æœ‰å­å¾…åŠ');
      promptAction.showToast(new ToastOptions('åˆé›†ä¸­æ²¡æœ‰å­å¾…åŠï¼Œè¯·å…ˆæ·»åŠ å­å¾…åŠ'));
      return;
    }

    // ä»ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„å­å¾…åŠå¼€å§‹
    const firstIncompleteIndex = items.findIndex(item => !item.completed);
    const startIndex = firstIncompleteIndex === -1 ? 0 : firstIncompleteIndex;
    const firstItem = items[startIndex];
    
    console.info(`åºåˆ—å¼€å§‹ä¿¡æ¯:`, { 
      startIndex, 
      firstIncompleteIndex, 
      firstItem: { id: firstItem.id, title: firstItem.title, completed: firstItem.completed },
      totalItems: items.length
    });

    const params: FocusTimerParams = {
      title: `${collection.title} - ${firstItem.title}`,
      taskTitle: firstItem.title,
      time: 25 * 60, // é»˜è®¤25åˆ†é’Ÿ
      isSequence: true,
      collectionId: collection.id.toString(),
      subTaskId: firstItem.id.toString(),
      currentSubTaskIndex: startIndex,
      totalSubTasksInCollection: items.length
    };

    console.info(`å¯åŠ¨åºåˆ—ä¸“æ³¨å‚æ•°:`, JSON.stringify(params));

    const routerOpts = new RouterOptions('pages/FocusTimer');
    router.pushUrl({
      url: routerOpts.url,
      params: params
    }, router.RouterMode.Single, (err: BusinessError) => {
      if (err) {
        console.error(`è·³è½¬FocusTimerå‡ºé”™: ${err.message}`);
      }
    });
  }

  // æ˜¾ç¤ºæ·»åŠ å­å¾…åŠå¯¹è¯æ¡†
  showAddSubTodoDialog(collectionId: number): void {
    this.addSubTodoDialogController = new CustomDialogController({
      builder: AddSubTodoDialog({
        onConfirm: (title: string, description: string, duration: number) => {
          this.addSubTodo(collectionId, title, description, duration);
        }
      }),
      autoCancel: true,
      alignment: DialogAlignment.Center
    });
    this.addSubTodoDialogController.open();
  }

  // æ¸²æŸ“å¾…åŠåˆé›†åˆ—è¡¨
  @Builder
  buildTodoCollectionsList() {
    if (this.isLoadingCollections) {
      Row() {
        LoadingProgress()
          .width(30)
          .height(30)
          .margin({ right: 10 })
        Text('åŠ è½½ä¸­...')
          .fontSize(16)
          .fontColor(this.currentTheme.textColor)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding(20)
    } else if (this.todoCollections.length === 0) {
      Column() {
        Text('æš‚æ— å¾…åŠåˆé›†')
          .fontSize(16)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.6)
        Text('ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ æ–°çš„å¾…åŠåˆé›†')
          .fontSize(14)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.4)
          .margin({ top: 8 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding(40)
    } else {
      List({ space: 8 }) {
        ForEach(this.todoCollections, (collection: TodoCollection) => {
          ListItem() {
            this.buildCollectionItemView(collection)
          }
          .swipeAction({
            end: {
              builder: () => {
                this.deleteCollectionBuilder(collection)
              }
            }
          })
        }, (collection: TodoCollection) => collection.id.toString())
      }
      .width('100%')
      .divider({ strokeWidth: 0 })
    }
  }

  // æ„å»ºåˆé›†é¡¹è§†å›¾
  @Builder
  buildCollectionItemView(collection: TodoCollection) {
    Column() {
      // åˆé›†ä¸»è¡Œ
      Row() {
        // å±•å¼€/æŠ˜å æŒ‡ç¤ºå™¨
        Text(this.expandedCollections.has(collection.id) ? 'â–¼' : 'â–¶')
          .fontSize(14)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.6)
          .width(20)
          .onClick(() => {
            this.toggleCollectionExpanded(collection.id);
          })

        Column() {
          Text(collection.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.textColor)
          
          if (collection.description) {
            Text(collection.description)
              .fontSize(14)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.6)
              .margin({ top: 4 })
          }
          
          Text(this.getItemCountText(collection.id))
            .fontSize(12)
            .fontColor(this.currentTheme.textColor)
            .opacity(0.5)
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .onClick(() => {
          this.toggleCollectionExpanded(collection.id);
        })

        Button('å¼€å§‹åºåˆ—')
          .fontSize(12)
          .fontColor(Color.White)
          .backgroundColor(this.currentTheme.primaryColor)
          .borderRadius(8)
          .height(28)
          .padding({left: 8, right: 8})
          .onClick(async () => {
            await this.startFocusForCollection(collection);
          })
      }
      .width('100%')
      .padding(12)

      // å­å¾…åŠåˆ—è¡¨ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰
      if (this.expandedCollections.has(collection.id)) {
        this.buildSubItemsList(collection.id)
      }
    }
    .width('100%')
    .backgroundColor(this.currentTheme.cardBackgroundColor)
    .borderRadius(8)
  }

  // æ„å»ºå­é¡¹åˆ—è¡¨
  @Builder
  buildSubItemsList(collectionId: number) {
    Divider()
      .color(this.currentTheme.borderColor)
      .margin({ left: 12, right: 12 })

    if (this.loadingItems.has(collectionId)) {
      Row() {
        LoadingProgress()
          .width(20)
          .height(20)
          .margin({ right: 8 })
        Text('åŠ è½½å­å¾…åŠä¸­...')
          .fontSize(14)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.6)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 10, bottom: 10 })
    } else {
      Column({ space: 4 }) {
        // ä½¿ç”¨Listç»„ä»¶æ”¯æŒswipeAction
        List({ space: 4 }) {
          ForEach(this.getCollectionItems(collectionId), (item: TodoCollectionItem, index: number) => {
            ListItem() {
              this.buildSubItemRow(item, index, collectionId)
            }
            .swipeAction({
              end: {
                builder: () => {
                  this.deleteSubTodoBuilder(item, collectionId)
                }
              }
            })
          }, (item: TodoCollectionItem) => item.id.toString())
        }
        .width('100%')
        .scrollBar(BarState.Off)

        // æ·»åŠ å­å¾…åŠæŒ‰é’®
        Row() {
          Text('+')
            .fontSize(16)
            .fontColor(this.currentTheme.primaryColor)
            .width(30)
          
          Text('æ·»åŠ å­å¾…åŠ')
            .fontSize(14)
            .fontColor(this.currentTheme.primaryColor)
            .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .onClick(() => {
          this.showAddSubTodoDialog(collectionId);
        })
      }
      .width('100%')
      .padding({ bottom: 8 })
    }
  }

  // æ„å»ºå­é¡¹è¡Œ
  @Builder
  buildSubItemRow(item: TodoCollectionItem, index: number, collectionId: number) {
    Row() {
      Text(`${index + 1}.`)
        .fontSize(14)
        .fontColor(this.currentTheme.textColor)
        .opacity(0.6)
        .width(30)
      
      Column() {
        Text(item.title)
          .fontSize(14)
          .fontColor(this.currentTheme.textColor)
          .decoration({type: item.completed ? TextDecorationType.LineThrough : TextDecorationType.None })
          .opacity(item.completed ? 0.6 : 1.0)
        
        if (item.description) {
          Text(item.description)
            .fontSize(12)
            .fontColor(this.currentTheme.textColor)
            .opacity(item.completed ? 0.4 : 0.6)
            .margin({ top: 2 })
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      
      Text('25min') // é»˜è®¤25åˆ†é’Ÿï¼Œå› ä¸ºApiServiceä¸­çš„TodoCollectionItemæ²¡æœ‰durationMinuteså±æ€§
        .fontSize(12)
        .fontColor(this.currentTheme.textColor)
        .opacity(0.5)
        .margin({ right: 8 })
      
      if (item.completed) {
        Text('âœ“')
          .fontSize(16)
          .fontColor('#34C759')
          .margin({ right: 8 })
      }

      Button('å¼€å§‹')
        .fontSize(10)
        .fontColor(Color.White)
        .backgroundColor(this.currentTheme.primaryColor)
        .borderRadius(6)
        .height(24)
        .padding({left: 6, right: 6})
        .onClick(() => {
          this.startFocusForSubTodo(collectionId, item.id);
        })
    }
    .width('100%')
    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
    .backgroundColor(item.completed ? 'rgba(0, 0, 0, 0.05)' : 'transparent')
    .borderRadius(4)
    .onClick(() => {
      this.toggleSubTodoStatus(collectionId, item.id);
    })
  }

  // åˆ é™¤å­å¾…åŠæŒ‰é’®æ„å»ºå™¨
  @Builder
  deleteSubTodoBuilder(item: TodoCollectionItem, collectionId: number) {
    Row() {
      Column() {
        Text('ğŸ—‘ï¸')
          .fontSize(16)
          .margin({ bottom: 2 })
        Text('åˆ é™¤')
          .fontSize(10)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .width(70)
      .height('100%')
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [['#FF6B6B', 0.0], ['#FF3B30', 1.0]]
      })
      .shadow({
        radius: 6,
        color: 'rgba(255, 59, 48, 0.3)',
        offsetX: 2,
        offsetY: 2
      })
      .onClick(() => {
        AlertDialog.show({
          title: 'ç¡®è®¤åˆ é™¤',
          message: `ç¡®å®šè¦åˆ é™¤å­å¾…åŠ"${item.title}"å—ï¼Ÿ`,
          primaryButton: {
            value: 'å–æ¶ˆ',
            action: () => {}
          },
          secondaryButton: {
            value: 'åˆ é™¤',
            fontColor: '#FF3B30',
            action: () => {
              this.deleteSubTodo(collectionId, item.id);
            }
          }
        });
      })
    }
    .height('100%')
  }

  // åˆ é™¤åˆé›†æŒ‰é’®æ„å»ºå™¨
  @Builder
  deleteCollectionBuilder(collection: TodoCollection) {
    Row() {
      Column() {
        Text('ğŸ—‘ï¸')
          .fontSize(18)
          .margin({ bottom: 2 })
        Text('åˆ é™¤')
          .fontSize(12)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .width(80)
      .height('100%')
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [['#FF6B6B', 0.0], ['#FF3B30', 1.0]]
      })
      .shadow({
        radius: 8,
        color: 'rgba(255, 59, 48, 0.3)',
        offsetX: 2,
        offsetY: 2
      })
      .onClick(() => {
        AlertDialog.show({
          title: 'ç¡®è®¤åˆ é™¤',
          message: `ç¡®å®šè¦åˆ é™¤å¾…åŠåˆé›†"${collection.title}"å—ï¼Ÿ`,
          primaryButton: {
            value: 'å–æ¶ˆ',
            action: () => {}
          },
          secondaryButton: {
            value: 'åˆ é™¤',
            fontColor: '#FF3B30',
            action: () => {
              this.deleteTodoCollection(collection.id);
            }
          }
        });
      })
      .gesture(
        TapGesture()
          .onAction(() => {
            animateTo({
              duration: 150,
              curve: Curve.FastOutSlowIn
            }, () => {
              // ç‚¹å‡»åé¦ˆåŠ¨ç”»
            })
          })
      )
      .stateStyles({
        pressed: {
          .backgroundColor('#D32F2F')
          .scale({ x: 0.95, y: 0.95 })
        },
        normal: {
          .backgroundColor('transparent')
          .scale({ x: 1.0, y: 1.0 })
        }
      })
    }
    .width(80)
    .height('100%')
    .backgroundColor('transparent')
  }

  // è·å–å­å¾…åŠæ•°é‡çš„æ˜¾ç¤ºæ–‡æœ¬
  getItemCountText(collectionId: number): string {
    if (this.loadingItems.has(collectionId)) {
      return 'åŠ è½½ä¸­...';
    }
    
    const items = this.collectionItems.get(collectionId);
    if (items === undefined) {
      // å¦‚æœåˆé›†æ˜¯å±•å¼€çŠ¶æ€ä½†æ•°æ®æœªåŠ è½½ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
      if (this.expandedCollections.has(collectionId)) {
        return 'åŠ è½½ä¸­...';
      }
      // å¦‚æœåˆé›†æ˜¯æŠ˜å çŠ¶æ€ï¼Œæ˜¾ç¤ºæœªåŠ è½½
      return 'ç‚¹å‡»å±•å¼€æŸ¥çœ‹';
    }
    
    return `${items.length} ä¸ªå­å¾…åŠ`;
  }

  // è¾…åŠ©æ–¹æ³•
  getItemCount(collectionId: number): number {
    return this.collectionItems.get(collectionId)?.length || 0;
  }

  getCollectionItems(collectionId: number): TodoCollectionItem[] {
    return this.collectionItems.get(collectionId) || [];
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('å¾…åŠåˆé›†ç®¡ç†')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        
        Blank()
        
        Button('+')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.addTodoCollectionDialogController.open();
          })
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor(this.currentTheme.primaryColor)

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          this.buildTodoCollectionsList()
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor(this.currentTheme.backgroundColor)

      // åº•éƒ¨å¯¼èˆªæ 
      TabBar({ currentIndex: 1 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.currentTheme.backgroundColor)
  }
}