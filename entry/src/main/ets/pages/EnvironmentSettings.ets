import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import preferences from '@ohos.data.preferences';
import { getAllEnvironments, EnvironmentConfig, DEFAULT_ENVIRONMENT } from '../config/Environment';
import { ThemeService, ThemeConfig } from '../services/ThemeService';

@Entry
@Component
struct EnvironmentSettings {
  @State currentEnvironment: string = DEFAULT_ENVIRONMENT;
  @State environments: EnvironmentConfig[] = getAllEnvironments();
  @State currentTheme: ThemeConfig = {
    id: 'light',
    name: 'æµ…è‰²ä¸»é¢˜',
    primaryColor: '#007AFF',
    backgroundColor: '#F2F2F7',
    textColor: '#000000',
    cardBackgroundColor: '#FFFFFF',
    borderColor: '#E5E5EA',
    shadowColor: '#00000010',
    errorColor: '#FF3B30'
  };
  private themeService = ThemeService.getInstance();
  private preferencesStore: preferences.Preferences | null = null;

  private themeChangeListener = (theme: ThemeConfig) => {
    this.currentTheme = theme;
  };

  async aboutToAppear() {
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    this.currentTheme = await this.themeService.getCurrentTheme();
    
    // åˆå§‹åŒ–åå¥½è®¾ç½®
    try {
      this.preferencesStore = await preferences.getPreferences(getContext(), 'environment_settings');
      // è¯»å–å½“å‰ç¯å¢ƒè®¾ç½®
      this.currentEnvironment = await this.preferencesStore.get('current_environment', DEFAULT_ENVIRONMENT) as string;
    } catch (error) {
      console.error('Failed to initialize preferences:', error);
    }
  }

  aboutToDisappear() {
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  async switchEnvironment(envName: string) {
    try {
      if (this.preferencesStore) {
        await this.preferencesStore.put('current_environment', envName);
        await this.preferencesStore.flush();
        this.currentEnvironment = envName;
        
        promptAction.showToast({
          message: `å·²åˆ‡æ¢åˆ°${ENVIRONMENTS[envName].description}`,
          duration: 2000
        });
        
        // æç¤ºç”¨æˆ·é‡å¯åº”ç”¨ä»¥ç”Ÿæ•ˆ
        setTimeout(() => {
          promptAction.showDialog({
            title: 'ç¯å¢ƒåˆ‡æ¢æˆåŠŸ',
            message: 'è¯·é‡å¯åº”ç”¨ä»¥ä½¿æ–°ç¯å¢ƒé…ç½®ç”Ÿæ•ˆ',
            buttons: [
              {
                text: 'ç¡®å®š',
                color: this.currentTheme.primaryColor
              }
            ]
          });
        }, 500);
      }
    } catch (error) {
      console.error('Failed to switch environment:', error);
      promptAction.showToast({
        message: 'ç¯å¢ƒåˆ‡æ¢å¤±è´¥',
        duration: 2000
      });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Image('/common/images/back.png')
          .width(24)
          .height(24)
          .margin({ left: 16 })
          .onClick(() => {
            router.back();
          })

        Text('ç¯å¢ƒè®¾ç½®')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.currentTheme.textColor)
          .margin({ left: 16 })

        Blank()

        Text('ğŸŒ')
          .fontSize(24)
          .fontColor(this.currentTheme.textColor)
          .margin({ right: 16 })
      }
      .width('100%')
      .height(56)
      .backgroundColor(this.currentTheme.cardBackgroundColor)

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        Text('é€‰æ‹©æœåŠ¡å™¨ç¯å¢ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.currentTheme.textColor)
          .margin({ bottom: 16 })
          .alignSelf(ItemAlign.Start)

        // ç¯å¢ƒé€‰æ‹©åˆ—è¡¨
        ForEach(this.environments, (env: EnvironmentConfig) => {
          Row() {
            Column() {
              Text(env.description)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor(this.currentTheme.textColor)
                .alignSelf(ItemAlign.Start)

              Text(env.baseUrl)
                .fontSize(14)
                .fontColor(this.currentTheme.textColor)
                .opacity(0.7)
                .margin({ top: 4 })
                .alignSelf(ItemAlign.Start)
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            Radio({ value: env.name, group: 'environment' })
              .checked(this.currentEnvironment === env.name)
              .onChange((isChecked: boolean) => {
                if (isChecked) {
                  this.switchEnvironment(env.name);
                }
              })
          }
          .width('100%')
          .padding(16)
          .backgroundColor(this.currentTheme.cardBackgroundColor)
          .borderRadius(12)
          .margin({ bottom: 12 })
          .border({
            width: this.currentEnvironment === env.name ? 2 : 1,
            color: this.currentEnvironment === env.name ? this.currentTheme.primaryColor : this.currentTheme.borderColor
          })
          .onClick(() => {
            this.switchEnvironment(env.name);
          })
        })

        // è¯´æ˜æ–‡å­—
        Text('ğŸ’¡ æç¤ºï¼šåˆ‡æ¢ç¯å¢ƒåéœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆ')
          .fontSize(14)
          .fontColor(this.currentTheme.textColor)
          .opacity(0.7)
          .margin({ top: 24 })
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor(this.currentTheme.backgroundColor)
      .padding(16)
    }
    .width('100%')
    .height('100%')
  }
}