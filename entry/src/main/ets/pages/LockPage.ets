import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../services/ThemeService';

// æ—¶é•¿é€‰é¡¹æŽ¥å£
interface DurationOption {
  label: string;
  minutes: number;
  icon: string;
  description: string;
}

@Entry
@Component
struct LockPage {
  @State selectedDuration: number = 25; // é»˜è®¤25åˆ†é’Ÿ
  @State isLocked: boolean = false;
  @State remainingTime: number = 0;
  @State showConfirmDialog: boolean = false;
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;
  private intervalId: number = -1;
  private themeService = ThemeService.getInstance();

  private themeChangeListener = async () => {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
    } catch (error) {
      console.error('LockPageä¸»é¢˜æ›´æ–°å¤±è´¥:', error);
    }
  };

  async aboutToAppear() {
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    // é¦–å…ˆåŠ è½½ä¿å­˜çš„ä¸»é¢˜åå¥½è®¾ç½®
    await this.themeService.loadThemePreference();
    this.currentTheme = await this.themeService.getCurrentTheme();
  }

  aboutToDisappear() {
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
    this.stopLock();
  }

  // æ—¶é•¿é€‰é¡¹æ•°æ®
  private getDurationOptions(): DurationOption[] {
    return [
      { label: 'ç•ªèŒ„æ—¶é—´', minutes: 25, icon: 'ðŸ…', description: 'ç»å…¸ä¸“æ³¨æ³•' },
      { label: 'çŸ­æš‚ä¸“æ³¨', minutes: 15, icon: 'âš¡', description: 'å¿«é€Ÿé›†ä¸­' },
      { label: 'æ·±åº¦ä¸“æ³¨', minutes: 45, icon: 'ðŸ§ ', description: 'æ·±å…¥æ€è€ƒ' },
      { label: 'é•¿æ—¶ä¸“æ³¨', minutes: 60, icon: 'ðŸŽ¯', description: 'æŒä¹…ä¸“æ³¨' },
      { label: 'è¶…é•¿ä¸“æ³¨', minutes: 90, icon: 'ðŸš€', description: 'æžé™æŒ‘æˆ˜' },
      { label: 'è‡ªå®šä¹‰', minutes: 30, icon: 'âš™ï¸', description: 'ä¸ªæ€§åŒ–æ—¶é•¿' }
    ];
  }

  startLock() {
    this.showConfirmDialog = true;
  }

  confirmLock() {
    this.showConfirmDialog = false;
    this.isLocked = true;
    this.remainingTime = this.selectedDuration * 60;
    
    this.intervalId = setInterval(() => {
      if (this.remainingTime > 0) {
        this.remainingTime--;
      } else {
        this.completeLock();
      }
    }, 1000);

    promptAction.showToast({ message: `å¼€å§‹${this.selectedDuration}åˆ†é’Ÿé”æœº` });
  }

  stopLock() {
    this.isLocked = false;
    clearInterval(this.intervalId);
    this.remainingTime = 0;
  }

  completeLock() {
    this.stopLock();
    promptAction.showToast({ message: 'é”æœºæ—¶é—´ç»“æŸï¼' });
  }

  formatTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
  }

  getProgress(): number {
    const totalSeconds = this.selectedDuration * 60;
    return ((totalSeconds - this.remainingTime) / totalSeconds) * 100;
  }

  // è‹¹æžœé£Žæ ¼çš„æ—¶é•¿é€‰æ‹©æŒ‰é’®
  @Builder
  DurationButton(option: DurationOption) {
    Column() {
      Text(option.icon)
        .fontSize(32)
        .margin({ bottom: 8 })
      
      Text(option.label)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.currentTheme.textColor)
        .margin({ bottom: 4 })
      
      Text(`${option.minutes}åˆ†é’Ÿ`)
        .fontSize(14)
        .fontColor(this.selectedDuration === option.minutes ? '#FFFFFF' : this.currentTheme.glassmorphism.accentPrimary)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 4 })
      
      Text(option.description)
        .fontSize(12)
        .fontColor(this.selectedDuration === option.minutes ? '#FFFFFF' : this.currentTheme.textColor)
        .opacity(0.7)
    }
    .width('100%')
    .height(120)
    .backgroundColor(this.selectedDuration === option.minutes ? 
      this.currentTheme.glassmorphism.accentPrimary : 
      this.currentTheme.glassmorphism.surfaceLight)
    .borderRadius(16)
    .border({ 
      width: this.selectedDuration === option.minutes ? 2 : 1, 
      color: this.selectedDuration === option.minutes ? 
        this.currentTheme.glassmorphism.accentPrimary : 
        this.currentTheme.glassmorphism.borderLight 
    })
    .shadow({
      radius: this.selectedDuration === option.minutes ? 16 : 8,
      color: this.selectedDuration === option.minutes ? 
        this.currentTheme.glassmorphism.accentPrimary + '40' : 
        this.currentTheme.glassmorphism.shadowSoft,
      offsetX: 0,
      offsetY: this.selectedDuration === option.minutes ? 8 : 4
    })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      this.selectedDuration = option.minutes;
    })
  }

  // ç¡®è®¤å¯¹è¯æ¡†
  @Builder
  ConfirmDialog() {
    Column() {
      Text('ðŸ”’')
        .fontSize(48)
        .margin({ bottom: 20 })
      
      Text('ç¡®è®¤å¼€å§‹é”æœºï¼Ÿ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.textColor)
        .margin({ bottom: 8 })
      
      Text(`å°†é”æœº ${this.selectedDuration} åˆ†é’Ÿ`)
        .fontSize(16)
        .fontColor(this.currentTheme.glassmorphism.accentPrimary)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 8 })
      
      Text('é”æœºæœŸé—´æ— æ³•ä½¿ç”¨æ‰‹æœº')
        .fontSize(14)
        .fontColor(this.currentTheme.textColor)
        .opacity(0.6)
        .textAlign(TextAlign.Center)
        .margin({ bottom: 32 })

      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .height(44)
          .fontSize(16)
          .fontColor(this.currentTheme.textColor)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
          .borderRadius(22)
          .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
          .onClick(() => {
            this.showConfirmDialog = false;
          })

        Button('å¼€å§‹é”æœº')
          .layoutWeight(1)
          .height(44)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .backgroundColor(this.currentTheme.glassmorphism.accentPrimary)
          .borderRadius(22)
          .onClick(() => {
            this.confirmLock();
          })
      }
      .width('100%')
    }
    .width('300vp')
    .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
    .borderRadius(20)
    .padding(24)
    .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
    .shadow({
      radius: 24,
      color: this.currentTheme.glassmorphism.shadowStrong,
      offsetX: 0,
      offsetY: 12
    })
  }

  build() {
    Stack() {
      if (!this.isLocked) {
        // æ—¶é•¿é€‰æ‹©ç•Œé¢
        Column() {
          // é¡¶éƒ¨å¯¼èˆªæ 
          Row() {
            Button() {
              Text('â†')
                .fontSize(24)
                .fontColor(this.currentTheme.textColor)
            }
            .width(44)
            .height(44)
            .backgroundColor('transparent')
            .onClick(() => {
              router.replaceUrl({ url: 'pages/Index' });
            })

            Text('é”æœºä¸“æ³¨')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.textColor)
              .layoutWeight(1)
              .textAlign(TextAlign.Center)

            // å ä½ç¬¦ä¿æŒå±…ä¸­
            Text('')
              .width(44)
              .height(44)
          }
          .width('100%')
          .height(60)
          .padding({ left: 20, right: 20 })

          // ä¸»è¦å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              // æ ‡é¢˜åŒºåŸŸ
              Column() {
                Text('ðŸ”’')
                  .fontSize(64)
                  .margin({ bottom: 16 })
                
                Text('é€‰æ‹©é”æœºæ—¶é•¿')
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.currentTheme.textColor)
                  .margin({ bottom: 8 })
                
                Text('é€‰æ‹©ä¸“æ³¨æ—¶é•¿ï¼Œå¼€å§‹é«˜æ•ˆå­¦ä¹ ')
                  .fontSize(16)
                  .fontColor(this.currentTheme.textColor)
                  .opacity(0.6)
                  .textAlign(TextAlign.Center)
              }
              .alignItems(HorizontalAlign.Center)
              .margin({ bottom: 40 })

              // æ—¶é•¿é€‰é¡¹ - æ”¹ä¸ºå•åˆ—åž‚ç›´å¸ƒå±€
              Column({ space: 16 }) {
                ForEach(this.getDurationOptions(), (option: DurationOption) => {
                  this.DurationButton(option);
                }, (option: DurationOption) => option.label)
              }
              .width('100%')
              .margin({ bottom: 40 })

              // å¼€å§‹æŒ‰é’®
              Button() {
                Row() {
                  Text('ðŸš€')
                    .fontSize(20)
                    .margin({ right: 8 })
                  Text(`å¼€å§‹ ${this.selectedDuration} åˆ†é’Ÿé”æœº`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                }
              }
              .width('100%')
              .height(56)
              .backgroundColor(this.currentTheme.glassmorphism.accentPrimary)
              .borderRadius(28)
              .fontColor('#FFFFFF')
              .shadow({
                radius: 16,
                color: this.currentTheme.glassmorphism.accentPrimary + '40',
                offsetX: 0,
                offsetY: 8
              })
              .onClick(() => {
                this.startLock();
              })
              .margin({ bottom: 40 })
            }
            .width('100%')
            .padding({ left: 20, right: 20 })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
        .width('100%')
        .height('100%')
        .backgroundColor(this.currentTheme.backgroundColor)
      } else {
        // é”æœºçŠ¶æ€ç•Œé¢
        Column() {
          // é”æœºçŠ¶æ€æ˜¾ç¤º
          Column() {
            Text('ðŸ”’')
              .fontSize(80)
              .margin({ bottom: 24 })
            
            Text('é”æœºä¸­...')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.textColor)
              .margin({ bottom: 16 })

            // åœ†å½¢è¿›åº¦çŽ¯
            Stack() {
              // èƒŒæ™¯åœ†çŽ¯
              Circle({ width: 200, height: 200 })
                .fill('transparent')
                .stroke(this.currentTheme.glassmorphism.borderLight)
                .strokeWidth(6)

              // è¿›åº¦åœ†çŽ¯
              Circle({ width: 200, height: 200 })
                .fill('transparent')
                .stroke(this.currentTheme.glassmorphism.accentPrimary)
                .strokeWidth(6)
                .strokeDashArray([this.getProgress() * 6.28, 628])
                .rotate({ angle: -90 })

              // ä¸­å¿ƒæ—¶é—´æ˜¾ç¤º
              Column() {
                Text(this.formatTime(this.remainingTime))
                  .fontSize(32)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.currentTheme.textColor)
                  .margin({ bottom: 4 })

                Text('å‰©ä½™æ—¶é—´')
                  .fontSize(14)
                  .fontColor(this.currentTheme.textColor)
                  .opacity(0.6)
              }
              .justifyContent(FlexAlign.Center)
            }
            .margin({ bottom: 40 })

            Text('ä¸“æ³¨å­¦ä¹ ä¸­ï¼Œè¯·å‹¿æ‰“æ‰°')
              .fontSize(16)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.6)
              .textAlign(TextAlign.Center)
              .margin({ bottom: 40 })

            Button('å¼ºåˆ¶è§£é”')
              .width(200)
              .height(44)
              .fontSize(16)
              .fontColor(this.currentTheme.glassmorphism.accentSecondary)
              .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
              .borderRadius(22)
              .border({ width: 2, color: this.currentTheme.glassmorphism.accentSecondary })
              .onClick(() => {
                this.stopLock();
                promptAction.showToast({ message: 'å·²å¼ºåˆ¶è§£é”' });
              })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .padding(40)
        }
        .width('100%')
        .height('100%')
        .backgroundColor(this.currentTheme.backgroundColor)
      }

      // ç¡®è®¤å¯¹è¯æ¡†
      if (this.showConfirmDialog) {
        Column() {
          this.ConfirmDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showConfirmDialog = false;
        })
      }
    }
  }
}