import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { ThemeService, ThemeConfig, THEME_CONFIGS } from '../services/ThemeService';

// ä¸»é¢˜é€‰é¡¹æ¥å£
interface ThemeOption {
  id: string;
  name: string;
  description: string;
  icon: string;
}

@Entry
@Component
struct ThemeSettingsPage {
  @State currentTheme: string = 'light';
  @State isLoading: boolean = false;
  private themeService = ThemeService.getInstance();

  // ä¸»é¢˜é€‰é¡¹
  private themeOptions: ThemeOption[] = [
    {
      id: 'light',
      name: 'æµ…è‰²ä¸»é¢˜',
      description: 'é€‚åˆç™½å¤©ä½¿ç”¨ï¼ŒæŠ¤çœ¼èˆ’é€‚',
      icon: 'â˜€ï¸'
    },
    {
      id: 'dark',
      name: 'æ·±è‰²ä¸»é¢˜',
      description: 'é€‚åˆå¤œé—´ä½¿ç”¨ï¼Œå‡å°‘çœ¼éƒ¨ç–²åŠ³',
      icon: 'ğŸŒ™'
    },
    {
      id: 'auto',
      name: 'è·Ÿéšç³»ç»Ÿ',
      description: 'æ ¹æ®ç³»ç»Ÿè®¾ç½®è‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜',
      icon: 'ğŸ”„'
    },
    {
      id: 'blue',
      name: 'æµ·æ´‹è“',
      description: 'æ¸…æ–°çš„è“è‰²ä¸»é¢˜',
      icon: 'ğŸŒŠ'
    },
    {
      id: 'green',
      name: 'æ£®æ—ç»¿',
      description: 'è‡ªç„¶çš„ç»¿è‰²ä¸»é¢˜',
      icon: 'ğŸŒ²'
    },
    {
      id: 'purple',
      name: 'æ¢¦å¹»ç´«',
      description: 'ä¼˜é›…çš„ç´«è‰²ä¸»é¢˜',
      icon: 'ğŸ’œ'
    }
    ];

  async aboutToAppear() {
    await this.loadCurrentTheme();
  }

  private async loadCurrentTheme() {
    try {
      this.currentTheme = await this.themeService.getCurrentThemeId();
      console.info('å½“å‰ä¸»é¢˜:', this.currentTheme);
    } catch (error) {
      console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
      this.currentTheme = 'light';
    }
  }



  async selectTheme(themeId: string) {
    if (this.isLoading) return;
    
    this.isLoading = true;
    
    try {
      const success = await this.themeService.setTheme(themeId);
      if (success) {
        this.currentTheme = themeId;
        
        const themeName = this.themeOptions.find(theme => theme.id === themeId)?.name || 'æœªçŸ¥ä¸»é¢˜';
        promptAction.showToast({
          message: `å·²åˆ‡æ¢åˆ°${themeName}`,
          duration: 2000
        });
        
        console.info('ä¸»é¢˜åˆ‡æ¢æˆåŠŸ:', themeName);
      } else {
        throw new Error('ä¸»é¢˜åˆ‡æ¢å¤±è´¥');
      }
    } catch (error) {
      console.error('ä¿å­˜ä¸»é¢˜å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¸»é¢˜åˆ‡æ¢å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  @Builder
  ThemeOption(theme: ThemeOption) {
    Row() {
      // ä¸»é¢˜å›¾æ ‡
      Text(theme.icon)
        .fontSize(24)
        .margin({ right: 16 })

      // ä¸»é¢˜ä¿¡æ¯
      Column() {
        Row() {
          Text(theme.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
          
          Blank()
          
          // é€‰ä¸­çŠ¶æ€æŒ‡ç¤ºå™¨
          if (this.currentTheme === theme.id) {
            Text('âœ“')
              .fontSize(18)
              .fontColor(ThemeService.getThemeConfig(theme.id)?.primaryColor || '#007AFF')
              .fontWeight(FontWeight.Bold)
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)

        Text(theme.description)
          .fontSize(14)
          .fontColor('#666666')
          .margin({ top: 4 })
          .textAlign(TextAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // ä¸»é¢˜é¢œè‰²é¢„è§ˆ
      Row({ space: 8 }) {
        Circle({ width: 16, height: 16 })
          .fill(ThemeService.getThemeConfig(theme.id)?.primaryColor || '#007AFF')
         Circle({ width: 16, height: 16 })
           .fill(ThemeService.getThemeConfig(theme.id)?.backgroundColor || '#FFFFFF')
           .stroke(ThemeService.getThemeConfig(theme.id)?.textColor || '#000000')
           .strokeWidth(1)
         Circle({ width: 16, height: 16 })
           .fill(ThemeService.getThemeConfig(theme.id)?.textColor || '#000000')
      }
      .margin({ top: 8 })
    }
    .width('100%')
    .height(80)
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(this.currentTheme === theme.id ? '#F0F8FF' : '#FFFFFF')
    .border({
      width: this.currentTheme === theme.id ? 2 : 1,
      color: this.currentTheme === theme.id ? (ThemeService.getThemeConfig(theme.id)?.primaryColor || '#007AFF') : '#E0E0E0',
      radius: 12
    })
    .margin({ left: 16, right: 16, bottom: 8 })
    .onClick(() => {
      if (!this.isLoading) {
        this.selectTheme(theme.id);
      }
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor('#333333')
          .onClick(() => {
            router.back();
          })

        Text('ä¸»é¢˜è®¾ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Text('')
          .width(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      Divider()
        .color('#E0E0E0')
        .height(1)

      // ä¸»é¢˜é€‰é¡¹åˆ—è¡¨
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#007AFF')
          
          Text('æ­£åœ¨åˆ‡æ¢ä¸»é¢˜...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          Column() {
            // è¯´æ˜æ–‡å­—
            Text('é€‰æ‹©æ‚¨å–œæ¬¢çš„ä¸»é¢˜é£æ ¼')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 16, bottom: 16, left: 16, right: 16 })
              .textAlign(TextAlign.Start)
              .width('100%')

            // ä¸»é¢˜é€‰é¡¹
            ForEach(this.themeOptions, (theme: ThemeOption) => {
              this.ThemeOption(theme)
            })

            // åº•éƒ¨è¯´æ˜
            Text('ä¸»é¢˜è®¾ç½®å°†åœ¨ä¸‹æ¬¡å¯åŠ¨åº”ç”¨æ—¶å®Œå…¨ç”Ÿæ•ˆ')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 24, bottom: 32, left: 16, right: 16 })
              .textAlign(TextAlign.Center)
              .width('100%')
          }
        }
        .layoutWeight(1)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}