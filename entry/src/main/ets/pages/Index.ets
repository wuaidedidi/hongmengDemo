import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import wantConstant from '@ohos.ability.wantConstant';
import Want from '@ohos.app.ability.Want';
import { TabBar } from '../components/TabBar';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import { PhxSystemActionUtil } from '../utils/PhxSystemActionUtil';
import { ApiService, TodoItemRequest } from '../services/ApiService';
import type { TodoItem as ApiTodoItem } from '../services/ApiService';
import { TodoItem } from '../model/TodoItem';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../services/ThemeService';
import { ThemeAwareGlassCard, ThemeAwareGradientBackground, GlassmorphismStyles } from '../utils/GlassmorphismStyles';

// TodoList è¢«ç§»é™¤ï¼Œå› ä¸ºå®ƒä¸ TodoCollection å…³è”è¾ƒå¤šï¼Œåç»­æŒ‰éœ€è°ƒæ•´
// import { TodoList } from '../view/TodoList';

// ä¸ç›´æ¥å¯¼å…¥Contextç±»å‹ï¼Œæˆ‘ä»¬å°†åœ¨éœ€è¦æ—¶ä½¿ç”¨commonæ¨¡å—
// Index.ets

// å®šä¹‰é€šç”¨é”™è¯¯æ¥å£ï¼Œæ›¿ä»£any/unknownç±»å‹
interface CommonError {
  message: string;
  code?: string | number;
  name?: string;
  stack?: string;
  cause?: string;
  detail?: string;
  // ç§»é™¤ç´¢å¼•ç­¾åï¼ŒArkTSä¸æ”¯æŒ
}

// ç³»ç»Ÿè®¾ç½®è·³è½¬å‚æ•°æ¥å£
interface SettingsWantOptions {
  action?: string;
  bundleName?: string;
  abilityName?: string;
  uri?: string;
  parameters?: Record<string, string | number | boolean | Array<string | number | boolean>>;
}

// Wantç±»å‹å®šä¹‰
interface SystemWant {
  action?: string;
  bundleName?: string;
  abilityName?: string;
  uri?: string;
  parameters?: Record<string, string | number | boolean | Array<string | number | boolean>>;
}

// ä¸Šä¸‹æ–‡æ¥å£å®šä¹‰
interface ContextLike {
  applicationInfo?: Record<string, string>;
  startAbility: Function;
}

// FocusTimeré¡µé¢è·¯ç”±å‚æ•°å®šä¹‰
interface FocusTimerRouterParams {
  taskTitle?: string;
  title?: string;
  time?: number; // æ³¨æ„ï¼šFocusTimer æœŸæœ›çš„æ˜¯ç§’
  duration?: number; // è¿™ä¸ªå¯èƒ½æ˜¯åˆ†é’Ÿï¼Œéœ€è¦ç»Ÿä¸€
  isSequence?: boolean; // Index é¡µé¢ä¸å†å¤„ç†åºåˆ—
  collectionId?: string; // Index é¡µé¢ä¸å†å¤„ç†åˆé›†
  subTaskId?: string; // Index é¡µé¢ä¸å†å¤„ç†å­ä»»åŠ¡
  currentSubTaskIndex?: number; // Index é¡µé¢ä¸å†å¤„ç†å­ä»»åŠ¡ç´¢å¼•
  totalSubTasksInCollection?: number; // Index é¡µé¢ä¸å†å¤„ç†åˆé›†ä»»åŠ¡æ€»æ•°
  todoId?: string | number; // æ”¯æŒå¾…åŠäº‹é¡¹ID
}

// æ·»åŠ è‡ªå¯åŠ¨è®¾ç½®Wantå‚æ•°æ¥å£
interface StartupSettingsParams {
  packageName: string;
}

// TodoOperationé¡µé¢è·¯ç”±å‚æ•°å®šä¹‰ (å¯èƒ½ä»éœ€è°ƒæ•´ï¼Œå–å†³äºç®€å•å¾…åŠçš„æ“ä½œ)
interface TodoOperationParams {
  todoId: string | number;
  todoTitle?: string;
}

// // å­ä»»åŠ¡ç¼–è¾‘é¡µé¢è·¯ç”±å‚æ•° (ä»Indexç§»é™¤)
// interface SubTaskEditPageParams {
//   collectionId: string;
//   subTaskId: string;
// }

// // å­ä»»åŠ¡æŸ¥æ‰¾ç»“æœæ¥å£ (ä»Indexç§»é™¤)
// interface SubTaskResult {
//   collection: TodoCollection | undefined;
//   subtask: ActualTodoItem | undefined;
// }

// å®šä¹‰AboutToAppearæ–¹æ³•ä¸­ä½¿ç”¨çš„å‚æ•°æ¥å£
interface AboutToAppearParams {
  action?: string;
  todoId?: string | number; // ä¿ç•™ç”¨äºç®€å•å¾…åŠè¿”å›
  // sequenceAction?: string; // ç§»é™¤åºåˆ—ç›¸å…³
  // collectionId?: string | number; // ç§»é™¤åˆé›†ç›¸å…³
  // completedSubTaskIndex?: string | number; // ç§»é™¤å­ä»»åŠ¡ç›¸å…³
  // currentSubTaskIndexCompleted?: number; // ç§»é™¤å­ä»»åŠ¡ç›¸å…³
  // allSubTasksInCollectionCompleted?: boolean; // ç§»é™¤åˆé›†å®Œæˆç›¸å…³
}

// å®šä¹‰åç§»é‡ç±»
class DialogOffset {
  dx: number;
  dy: number;

  constructor(dx: number, dy: number) {
    this.dx = dx;
    this.dy = dy;
  }
}

// æƒé™åˆ—è¡¨ç±»å‹
class PermissionItem {
  name: string;
  granted: boolean;

  constructor(name: string, granted: boolean) {
    this.name = name;
    this.granted = granted;
  }
}

// è·¯ç”±å‚æ•°æ¥å£
interface RouterParams {
  action?: string;
  todoId?: string | number; // ç®€å•å¾…åŠID
  // ç§»é™¤åºåˆ—å’Œåˆé›†ç›¸å…³å‚æ•°
  // sequenceAction?: string;
  // collectionId?: string | number;
  // completedSubTaskIndex?: string | number;
  // currentSubTaskIndexCompleted?: string;
  // allSubTasksInCollectionCompleted?: string;
}

// åœ¨æ–‡ä»¶é¡¶éƒ¨çš„æ¥å£å®šä¹‰éƒ¨åˆ†æ·»åŠ ä¸€ä¸ªé€šç”¨é”™è¯¯ç±»å‹
// é€šç”¨é”™è¯¯ç±»å‹ï¼Œç”¨äºå¤„ç†å„ç§é”™è¯¯æƒ…å†µ
interface ErrorInfo {
  message: string;
  code?: number;
  details?: string;
}

// åˆ›å»ºé”™è¯¯ä¿¡æ¯çš„è¾…åŠ©æ–¹æ³•
function createErrorInfo(err: Error): ErrorInfo {
  return { message: err.message };
}

// ä»å­—ç¬¦ä¸²åˆ›å»ºé”™è¯¯ä¿¡æ¯
function createErrorInfoFromString(errStr: string): ErrorInfo {
  return { message: errStr };
}

// ä»å¯¹è±¡åˆ›å»ºé”™è¯¯ä¿¡æ¯
function createErrorInfoFromObject(errObj: CommonError): ErrorInfo {
  const message = errObj.message ? String(errObj.message) : "æœªçŸ¥é”™è¯¯";
  const code = typeof errObj.code === 'number' ? errObj.code : undefined;
  const details = String(errObj);
  return { message, code, details };
}

// AddSimpleTodoDialog ä¿æŒï¼Œç”¨äºæ·»åŠ ç®€å•å¾…åŠ
@CustomDialog
struct AddSimpleTodoDialog {
  @State todoName: string = '';
  @State todoType: string = '';
  @State todoDuration: number = 25;
  @Prop currentTheme: ThemeConfig; // æ·»åŠ ä¸»é¢˜å±æ€§
  onConfirm: (name: string, type: string, duration: number) => void = () => {
  };
  controller?: CustomDialogController;

  build() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Column() {
        Text('âœ¨')
          .fontSize(32)
          .margin({ bottom: 8 })
        Text('æ·»åŠ æ–°å¾…åŠ')
          .fontSize(20)
          .fontColor(this.currentTheme.textColor)
          .fontWeight(FontWeight.Bold)
      }
      .alignItems(HorizontalAlign.Center)
      .margin({ bottom: 24 })

      // è¾“å…¥åŒºåŸŸ
      Column({ space: 16 }) {
        TextInput({ placeholder: "å¾…åŠåç§°", text: this.todoName })
          .onChange(val => {
            this.todoName = val;
          })
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight + 'D0')
          .borderRadius(16)
          .border({ 
            width: 0.5, 
            color: this.currentTheme.glassmorphism.accentSecondary + '50' 
          })
          .fontColor(this.currentTheme.textColor)
          .placeholderColor(this.currentTheme.textColor + '80')
          .padding(16)
          .backdropBlur(8)
          .shadow({
            radius: 6,
            color: this.currentTheme.glassmorphism.accentPrimary + '20',
            offsetX: 0,
            offsetY: 2
          })

        TextInput({ placeholder: "ç±»å‹ (å¦‚: å­¦ä¹ , å·¥ä½œ)", text: this.todoType })
          .onChange(val => {
            this.todoType = val;
          })
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight + 'D0')
          .borderRadius(16)
          .border({ 
            width: 0.5, 
            color: this.currentTheme.glassmorphism.accentSecondary + '50' 
          })
          .fontColor(this.currentTheme.textColor)
          .placeholderColor(this.currentTheme.textColor + '80')
          .padding(16)
          .backdropBlur(8)
          .shadow({
            radius: 6,
            color: this.currentTheme.glassmorphism.accentPrimary + '20',
            offsetX: 0,
            offsetY: 2
          })

        TextInput({ placeholder: "æ—¶é•¿ (åˆ†é’Ÿ)", text: this.todoDuration.toString() })
          .type(InputType.Number)
          .onChange(val => {
            this.todoDuration = Number(val) || 25;
          })
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight + 'D0')
          .borderRadius(16)
          .border({ 
            width: 0.5, 
            color: this.currentTheme.glassmorphism.accentSecondary + '50' 
          })
          .fontColor(this.currentTheme.textColor)
          .placeholderColor(this.currentTheme.textColor + '80')
          .padding(16)
          .backdropBlur(8)
          .shadow({
            radius: 6,
            color: this.currentTheme.glassmorphism.accentPrimary + '20',
            offsetX: 0,
            offsetY: 2
          })
      }
      .margin({ bottom: 24 })

      // æŒ‰é’®åŒºåŸŸ
      Row({ space: 12 }) {
        Button("å–æ¶ˆ")
          .onClick(() => this.controller?.close())
          .layoutWeight(1)
          .height(48)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight + 'B0')
          .borderRadius(16)
          .border({ 
            width: 0.5, 
            color: this.currentTheme.glassmorphism.accentSecondary + '60' 
          })
          .fontColor(this.currentTheme.glassmorphism.accentSecondary)
          .backdropBlur(8)
          .shadow({
            radius: 8,
            color: this.currentTheme.glassmorphism.accentSecondary + '20',
            offsetX: 0,
            offsetY: 2
          })

        Button("ç¡®å®š")
          .onClick(() => {
            this.onConfirm(this.todoName, this.todoType, this.todoDuration);
            this.controller?.close();
          })
          .layoutWeight(1)
          .height(48)
          .linearGradient({
            angle: 135,
            colors: [
              [this.currentTheme.glassmorphism.accentPrimary, 0.0],
              [this.currentTheme.glassmorphism.accentSecondary, 1.0]
            ]
          })
          .borderRadius(16)
          .border({ 
            width: 0.5, 
            color: this.currentTheme.glassmorphism.accentPrimary + '60' 
          })
          .fontColor('#FFFFFF')
          .backdropBlur(8)
          .shadow({
            radius: 12,
            color: this.currentTheme.glassmorphism.accentPrimary + '50',
            offsetX: 0,
            offsetY: 3
          })
          .blur(0.2)
      }
      .width('100%')
    }
    .padding(24)
    .width(320)
    .backgroundColor(this.currentTheme.backgroundColor + 'F8') // é™ä½é€æ˜åº¦ï¼Œæé«˜å¯è¯»æ€§
    .borderRadius(24)
    .backdropBlur(15) // é€‚åº¦å‡å°‘èƒŒæ™¯æ¨¡ç³Š
    .border({ 
      width: 0.5, 
      color: this.currentTheme.glassmorphism.accentPrimary + '40' // ç¨å¾®å¢åŠ è¾¹æ¡†å¯è§åº¦
    })
    .shadow({
      radius: 25,
      color: this.currentTheme.glassmorphism.accentPrimary + '30',
      offsetX: 0,
      offsetY: 10
    })
    .linearGradient({
      angle: 135,
      colors: [
        [this.currentTheme.backgroundColor + 'F5', 0.0],
        [this.currentTheme.glassmorphism.surfaceLight + 'F8', 1.0]
      ]
    })
  }
}

// // New CustomDialog for adding TodoCollection (ç§»è‡³ TodoDetail.ets)
// @CustomDialog
// struct AddCollectionDialog { ... }

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State bgColor: string = 'rgba(255, 192, 203, 0.15)';
  @State isClockInMenuShow: boolean = false;
  @State isClockInStatsShow: boolean = false;
  @State isPermissionDialogShow: boolean = false;
  @State isLoggedIn: boolean = false;
  @State username: string = '';
  @State password: string = '';
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;
  private apiService: ApiService = ApiService.getInstance();
  private themeService: ThemeService = ThemeService.getInstance();
  private themeChangeListener = async () => {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
      console.info('Indexé¡µé¢ä¸»é¢˜å·²æ›´æ–°:', this.currentTheme.name);
    } catch (error) {
      console.error('Indexä¸»é¢˜æ›´æ–°å¤±è´¥:', error);
    }
  };
  // ä½¿ç”¨åç«¯APIçš„å¾…åŠäº‹é¡¹
  @State simpleTodos: TodoItem[] = [];
  @State isLoadingTodos: boolean = false;
  // @State selectedTodoId: number = -1; // å¦‚æœéœ€è¦è·Ÿè¸ªé€‰ä¸­çš„ç®€å•å¾…åŠï¼Œå¯ä»¥ä¿ç•™
  @State isOperationMenuShow: boolean = false; // ä¿ç•™æ“ä½œèœå•çŠ¶æ€ (å¯èƒ½ç”¨äºç®€å•å¾…åŠçš„ç¼–è¾‘/åˆ é™¤)
  // @State showAddTodoModal: boolean = false; // AddSimpleTodoDialog æœ‰è‡ªå·±çš„controller

  // ç”¨äº AddSimpleTodoDialog çš„çŠ¶æ€å˜é‡
  @State newSimpleTodoName: string = '';
  @State newSimpleTodoType: string = '';
  @State newSimpleTodoDuration: number = 25;
  permissionList: PermissionItem[] = [
    new PermissionItem('é€šçŸ¥æƒé™', false),
    new PermissionItem('æ—¥å†æƒé™', false),
    new PermissionItem('ä½ç½®æƒé™', false)
  ];
  // // Dialog controller for adding collections (ç§»é™¤)
  // private addCollectionDialog: CustomDialogController = ... ;

  // Dialog controller for adding simple todos
  private addSimpleTodoDialogController: CustomDialogController | null = null;

  async aboutToAppear() {
    this.checkLoginStatus();
    // æ³¨å†Œä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    // åŠ è½½å½“å‰ä¸»é¢˜
    try {
      // é¦–å…ˆåŠ è½½ä¿å­˜çš„ä¸»é¢˜åå¥½è®¾ç½®
      await this.themeService.loadThemePreference();
      this.currentTheme = await this.themeService.getCurrentTheme();
      console.info('Indexé¡µé¢åŠ è½½ä¸»é¢˜æˆåŠŸ:', this.currentTheme.name);
    } catch (error) {
      console.error('Indexé¡µé¢åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
    }
  }

  aboutToDisappear() {
    // æ³¨é”€ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  async checkLoginStatus() {
    const savedUsername = await this.apiService.getUsername();
    const savedToken = await this.apiService.getToken();

    // åªæœ‰åœ¨åŒæ—¶å­˜åœ¨ç”¨æˆ·åå’Œæœ‰æ•ˆtokenæ—¶æ‰è‡ªåŠ¨ç™»å½•
    if (savedUsername && savedToken) {
      this.username = savedUsername;
      this.isLoggedIn = true;
      console.info('è‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œç”¨æˆ·:', this.username);
      // ç™»å½•æˆåŠŸååŠ è½½å¾…åŠäº‹é¡¹
      await this.loadTodos();
    } else {
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„ç™»å½•çŠ¶æ€ï¼Œæ¸…é™¤å¯èƒ½æ®‹ç•™çš„æ•°æ®
      await this.apiService.clearAuth();
      this.isLoggedIn = false;
      console.info('æœªæ‰¾åˆ°æœ‰æ•ˆç™»å½•çŠ¶æ€');
    }
  }

  async handleLogin() {
    console.info('ç‚¹å‡»ç™»å½•ï¼Œç”¨æˆ·å:', this.username, 'å¯†ç :', this.password);
    try {
      console.info('è°ƒç”¨ ApiService.login');
      const response = await this.apiService.login(this.username, this.password);
      console.info('åç«¯è¿”å›:', JSON.stringify(response));
      await this.apiService.setToken(response.token);
      await this.apiService.setUsername(this.username);
      this.isLoggedIn = true;
      promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' });
      // ç™»å½•æˆåŠŸååŠ è½½å¾…åŠäº‹é¡¹
      await this.loadTodos();
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥è¯¦ç»†ä¿¡æ¯:', JSON.stringify(error));
      console.error('é”™è¯¯æ¶ˆæ¯:', (error as Error).message);
      promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼š' + (error as Error).message });
    }
  }

  async handleRegister() {
    try {
      await this.apiService.register(this.username, this.password);
      promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•' });
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error);
      promptAction.showToast({ message: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
    }
  }

  async handleLogout() {
    await this.apiService.clearAuth();
    this.isLoggedIn = false;
    this.username = '';
    this.password = '';
    promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
  }

  async handleCheckIn() {
    try {
      await this.apiService.checkIn();
      promptAction.showToast({ message: 'æ‰“å¡æˆåŠŸ' });
      this.isClockInMenuShow = false;
    } catch (error) {
      console.error('æ‰“å¡å¤±è´¥:', error);
    }
  }

  onPageShow() {
    console.info("Index page onPageShow triggered");
    const routeParams = router.getParams() as RouterParams;
    if (routeParams && typeof routeParams === 'object') {
      console.info('Index onPageShow router.getParams(): ' + JSON.stringify(routeParams));

      if (routeParams.action === 'focusCompleted' && routeParams.todoId !== undefined) {
        const completedTodoId = Number(routeParams.todoId);
        // é€šè¿‡APIæ›´æ–°å¾…åŠçŠ¶æ€
        this.toggleTodoStatus(completedTodoId);

        const todo = this.simpleTodos.find(t => t.id === completedTodoId);
        if (todo) {
          promptAction.showToast({ message: `ä»»åŠ¡ "${todo.title}" ä¸“æ³¨å®Œæˆï¼` });
        }
      }
      // ç§»é™¤æ‰€æœ‰ä¸ sequenceAction, collectionId, completedSubTaskIndex ç›¸å…³çš„å¤„ç†é€»è¾‘
    }
    this.currentIndex = 0; // ç¡®ä¿åœ¨é¡µé¢æ˜¾ç¤ºæ—¶ currentIndex æ­£ç¡®

    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
    this.loadTodos();
  }

  // æ˜¾ç¤ºæ·»åŠ ç®€å•å¾…åŠå¯¹è¯æ¡†
  async showAddSimpleTodoDialog(): Promise<void> {
    try {
      // é‡ç½®è¾“å…¥çŠ¶æ€
      this.newSimpleTodoName = '';
      this.newSimpleTodoType = '';
      this.newSimpleTodoDuration = 25;
      
      // é¢„å…ˆè·å–å½“å‰ä¸»é¢˜ï¼Œç¡®ä¿å¼¹çª—æ˜¾ç¤ºæ—¶ä¸»é¢˜å·²åŠ è½½
      const currentTheme = await this.themeService.getCurrentTheme();
      console.info('å‡†å¤‡æ‰“å¼€æ·»åŠ ç®€å•å¾…åŠå¼¹çª—ï¼Œå½“å‰ä¸»é¢˜:', currentTheme.name);
      
      // æ¯æ¬¡æ‰“å¼€æ—¶é‡æ–°åˆ›å»ºï¼Œç¡®ä¿è·å–æœ€æ–°ä¸»é¢˜
      this.addSimpleTodoDialogController = new CustomDialogController({
        builder: AddSimpleTodoDialog({
          todoName: this.newSimpleTodoName,
          todoType: this.newSimpleTodoType,
          todoDuration: this.newSimpleTodoDuration,
          currentTheme: currentTheme, // ä¼ é€’å½“å‰ä¸»é¢˜
          onConfirm: (name: string, type: string, duration: number) => {
            this.addNewSimpleTodoFromDialog(name, type, duration);
          }
        }),
        autoCancel: true,
        alignment: DialogAlignment.Center,
        customStyle: true, // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼
        maskColor: Color.Transparent // å»æ‰é»˜è®¤çš„é®ç½©é¢œè‰²
      });
      this.addSimpleTodoDialogController.open();
    } catch (error) {
      console.error('æ‰“å¼€æ·»åŠ ç®€å•å¾…åŠå¼¹çª—å¤±è´¥:', error);
    }
  }

  async addNewSimpleTodoFromDialog(name: string, type: string, duration: number) {
    if (name.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠåç§°' });
      return;
    }
    if (type.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠç±»å‹' });
      return;
    }
    if (duration <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿' });
      return;
    }

    try {
      const todoData: TodoItemRequest = {
        title: name.trim(),
        description: type.trim(),
        type: type.trim() || 'general',
        duration: duration,
        isImportant: false,
        isUrgent: false
      };

      const newTodo: ApiTodoItem = await this.apiService.createTodoItem(todoData);

      // è½¬æ¢ä¸ºæœ¬åœ°TodoItemæ ¼å¼
      const localTodo = new TodoItem(
        newTodo.id,
        newTodo.title,
        newTodo.type || 'general',
        newTodo.duration || 25,
        newTodo.completed
      );

      this.simpleTodos.push(localTodo);

      // é‡ç½®è¾“å…¥æ¡†çŠ¶æ€
      this.newSimpleTodoName = '';
      this.newSimpleTodoType = '';
      this.newSimpleTodoDuration = 25;

      promptAction.showToast({ message: "æ–°å¾…åŠå·²æ·»åŠ " });
    } catch (error) {
      console.error('æ·»åŠ å¾…åŠå¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : String(error);
      promptAction.showToast({ message: 'æ·»åŠ å¾…åŠå¤±è´¥ï¼š' + errorMessage });
    }
  }

  async addNewSimpleTodo() {
    if (this.newSimpleTodoName.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠåç§°' });
      return;
    }
    if (this.newSimpleTodoType.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠç±»å‹' });
      return;
    }
    if (this.newSimpleTodoDuration <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿' });
      return;
    }

    try {
      const todoData: TodoItemRequest = {
        title: this.newSimpleTodoName.trim(),
        description: this.newSimpleTodoType.trim(),
        type: this.newSimpleTodoType.trim() || 'general',
        duration: this.newSimpleTodoDuration,
        isImportant: false,
        isUrgent: false
      };

      const newTodo: ApiTodoItem = await this.apiService.createTodoItem(todoData);

      // è½¬æ¢ä¸ºæœ¬åœ°TodoItemæ ¼å¼
      const localTodo = new TodoItem(
        newTodo.id,
        newTodo.title,
        newTodo.type || 'general',
        newTodo.duration || 25,
        newTodo.completed
      );

      this.simpleTodos.push(localTodo);

      // é‡ç½®è¾“å…¥æ¡†
      this.newSimpleTodoName = '';
      this.newSimpleTodoType = '';
      this.newSimpleTodoDuration = 25;

      promptAction.showToast({ message: "æ–°å¾…åŠå·²æ·»åŠ " });
    } catch (error) {
      console.error('æ·»åŠ å¾…åŠå¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : String(error);
      promptAction.showToast({ message: 'æ·»åŠ å¾…åŠå¤±è´¥ï¼š' + errorMessage });
    }
  }

  // åŠ è½½å¾…åŠäº‹é¡¹
  async loadTodos() {
    if (!this.isLoggedIn) {
      return;
    }

    try {
      this.isLoadingTodos = true;
      const todos: ApiTodoItem[] = await this.apiService.getTodoItems();

      // è½¬æ¢ä¸ºæœ¬åœ°TodoItemæ ¼å¼
      this.simpleTodos = todos.map((todo: ApiTodoItem): TodoItem => new TodoItem(
        todo.id,
        todo.title,
        todo.type || 'general',
        todo.duration || 25,
        todo.completed
      ));
    } catch (error) {
      console.error('åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥:', error);
      promptAction.showToast({ message: 'åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥' });
    } finally {
      this.isLoadingTodos = false;
    }
  }

  // åˆ‡æ¢å¾…åŠå®ŒæˆçŠ¶æ€
  async toggleTodoStatus(todoId: number) {
    try {
      const updatedTodo: ApiTodoItem = await this.apiService.toggleTodoItemStatus(todoId);

      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      const index = this.simpleTodos.findIndex(t => t.id === todoId);
      if (index !== -1) {
        this.simpleTodos[index].isCompleted = updatedTodo.completed;
        this.simpleTodos = Array.from(this.simpleTodos); // è§¦å‘UIæ›´æ–°
      }

      promptAction.showToast({
        message: updatedTodo.completed ? 'ä»»åŠ¡å·²å®Œæˆ' : 'ä»»åŠ¡å·²é‡æ–°æ¿€æ´»'
      });
    } catch (error) {
      console.error('æ›´æ–°å¾…åŠçŠ¶æ€å¤±è´¥:', error);
      promptAction.showToast({ message: 'æ›´æ–°çŠ¶æ€å¤±è´¥' });
    }
  }

  // åˆ é™¤å¾…åŠäº‹é¡¹
  async deleteTodo(todoId: number) {
    try {
      await this.apiService.deleteTodoItem(todoId);

      // ä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤
      this.simpleTodos = this.simpleTodos.filter(t => t.id !== todoId);

      promptAction.showToast({ message: 'å¾…åŠå·²åˆ é™¤' });
    } catch (error) {
      console.error('åˆ é™¤å¾…åŠå¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' });
    }
  }

  // ä¸ºå¾…åŠå¼€å§‹ä¸“æ³¨çš„æ–¹æ³•
  private startFocusForTodo(todo: TodoItem): void {
    const params: FocusTimerRouterParams = {
      title: todo.title,
      taskTitle: todo.title,
      time: todo.duration * 60,
      todoId: todo.id,
      isSequence: false
    };
    router.pushUrl({ url: 'pages/FocusTimer', params: params })
      .catch((err: Error) => {
        console.error(`è·³è½¬FocusTimerå‡ºé”™: ${err.message}`);
      });
  }

  handlePermissionSettings() {
    const context = this.getAppAbilityContext();
    if (!context) {
      promptAction.showToast({ message: "æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡" });
      return;
    }
    // è·³è½¬åˆ°åº”ç”¨è¯¦æƒ…é¡µ
    PhxSystemActionUtil.goAppInfoSetting(context);
  }

  // --- System and Permission Methods Placeholder ---
  getAppAbilityContext(): common.UIAbilityContext | undefined {
    const context = getContext(this) as common.UIAbilityContext; // æ˜ç¡®ç±»å‹
    if (context && typeof context === 'object') {
      try {
        // å°è¯•å°†contextè½¬ä¸ºUIAbilityContextç±»å‹
        const uiContext = context as common.UIAbilityContext;
        // æ£€æŸ¥å¿…è¦çš„å±æ€§æ˜¯å¦å­˜åœ¨
        if (uiContext.applicationInfo !== undefined && typeof uiContext.startAbility === 'function') {
          return uiContext;
        }
      } catch (e) {
        const errorMessage = e instanceof Error ? e.message : String(e);
        console.error("Context conversion to UIAbilityContext error: " + errorMessage);
      }
    }
    console.warn("Failed to get a valid UIAbilityContext.");
    return undefined;
  }

  async startSystemSettingsGuidanceFlow() {
    console.info('[MyTestApp] startSystemSettingsGuidanceFlow: Method executing with new logic.');
    const context = this.getAppAbilityContext();
    if (!context) {
      promptAction.showToast({ message: "æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡" });
      return;
    }

    const currentBundleName = context.applicationInfo?.name || context.abilityInfo?.bundleName || '';
    if (!currentBundleName) {
      promptAction.showToast({ message: "æ— æ³•è·å–å½“å‰åº”ç”¨åŒ…å" });
      console.error('[MyTestApp] æ— æ³•è·å–å½“å‰åº”ç”¨åŒ…å');
      return;
    }
    console.info(`[MyTestApp] å½“å‰åº”ç”¨åŒ…å: ${currentBundleName}`);

    // ä¾æ¬¡å°è¯•æ‰€æœ‰å¸¸è§action
    const tryWants: Want[] = [
      { action: 'ohos.settings.action.application_details_settings', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.APP_DETAILS', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.APP_PERMISSION_MANAGER', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.APP_NOTIFICATION_SETTINGS', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.SETTINGS' }
    ];
    let success = false;
    for (let want of tryWants) {
      try {
        console.info(`[MyTestApp] å°è¯•action: ${JSON.stringify(want)}`);
        await context.startAbility(want as Want);
        console.info('[MyTestApp] è·³è½¬è®¾ç½®ç›¸å…³é¡µé¢æˆåŠŸ');
        success = true;
        break;
      } catch (e) {
        console.error(`[MyTestApp] è·³è½¬å¤±è´¥: ${e}`);
        // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
      }
    }
    if (!success) {
      promptAction.showToast({
        message: "æ— æ³•æ‰“å¼€è®¾ç½®é¡µé¢ï¼Œè¯·æ‰‹åŠ¨å‰å¾€è®¾ç½®",
        duration: 3000
      });
    }
  }

  createSystemWant(options: SettingsWantOptions): SystemWant {
    // This function should create a Want object based on options
    // Placeholder implementation
    let want: Want = {
      bundleName: options.bundleName,
      abilityName: options.abilityName,
      uri: options.uri,
      parameters: options.parameters,
      action: options.action
    };
    // Make sure Want conforms to SystemWant, or SystemWant is an interface Want implements
    return want as SystemWant;
  }

  // --- End of Placeholder ---

  // åˆ é™¤ç®€å•å¾…åŠæŒ‰é’®æ„å»ºå™¨
  @Builder
  deleteSimpleTodoBuilder(todo: TodoItem) {
    Row() {
      Column() {
        Text('ğŸ—‘ï¸')
          .fontSize(18)
          .margin({ bottom: 2 })
        Text('åˆ é™¤')
          .fontSize(12)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .width(80)
      .height('100%')
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [['#FF6B6B', 0.0], ['#FF3B30', 1.0]]
      })
      .shadow({
        radius: 8,
        color: 'rgba(255, 59, 48, 0.3)',
        offsetX: 2,
        offsetY: 2
      })
      .onClick(() => {
        AlertDialog.show({
          title: 'ç¡®è®¤åˆ é™¤',
          message: `ç¡®å®šè¦åˆ é™¤å¾…åŠäº‹é¡¹"${todo.title}"å—ï¼Ÿ`,
          primaryButton: {
            value: 'å–æ¶ˆ',
            action: () => {}
          },
          secondaryButton: {
            value: 'åˆ é™¤',
            fontColor: '#FF3B30',
            action: () => {
              this.deleteTodo(todo.id);
            }
          }
        });
      })
      .gesture(
        TapGesture()
          .onAction(() => {
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
            animateTo({
              duration: 150,
              curve: Curve.FastOutSlowIn
            }, () => {
              // ç‚¹å‡»åé¦ˆåŠ¨ç”»
            })
          })
      )
      .stateStyles({
        pressed: {
          .backgroundColor('#D32F2F')
          .scale({ x: 0.95, y: 0.95 })
        },
        normal: {
          .backgroundColor('transparent')
          .scale({ x: 1.0, y: 1.0 })
        }
      })
    }
    .width(80)
    .height('100%')
    .backgroundColor('transparent')
  }

  @Builder
  AddSimpleTodoDialog() {
    Column({ space: 20 }) {
      Text('æ·»åŠ æ–°å¾…åŠ')
        .fontSize(20)
        .fontColor(this.currentTheme.glassmorphism.accentPrimary)
        .fontWeight(FontWeight.Bold)
        .textShadow({
          radius: 8,
          color: this.currentTheme.glassmorphism.accentPrimary + '50',
          offsetX: 0,
          offsetY: 0
        })

      // ... existing dialog content ...
    }
    .width('100%')
    .backgroundColor(this.currentTheme.glassmorphism.surfaceStrong)
    .borderRadius(20)
    .border({ width: 1, color: this.currentTheme.glassmorphism.borderMedium })
    .padding(24)
    .shadow({
      radius: 24,
      color: this.currentTheme.glassmorphism.shadowDeep,
      offsetX: 0,
      offsetY: 12
    })
  }

  build() {
    if (!this.isLoggedIn) {
      // ç™»å½•ç•Œé¢ - ä½¿ç”¨ä¸»é¢˜æ„ŸçŸ¥çš„æ¸å˜èƒŒæ™¯
      ThemeAwareGradientBackground({ gradientType: 'primary' }) {
        Column() {
          // æ ‡é¢˜åŒºåŸŸ
          Column() {
            Text('âœ¨')
              .fontSize(64)
              .margin({ bottom: 16 })
            
            Text('Daily Focus')
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.textColor)
              .textShadow({
                radius: 12,
                color: this.currentTheme.glassmorphism.accentPrimary + '60',
                offsetX: 0,
                offsetY: 0
              })
              .margin({ bottom: 8 })
            
            Text('ä¸“æ³¨æ¯ä¸€å¤©ï¼Œæˆå°±æ›´å¥½çš„è‡ªå·±')
              .fontSize(16)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.8)
              .margin({ bottom: 48 })
          }

          // ç™»å½•å¡ç‰‡ - ä½¿ç”¨ä¸»é¢˜æ„ŸçŸ¥çš„ç»ç’ƒå¡ç‰‡
          ThemeAwareGlassCard({ level: 'strong' }) {
            Column({ space: 20 }) {
              // ç™»å½•æ ‡é¢˜
              Text('æ¬¢è¿å›æ¥')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.currentTheme.textColor)
                .textAlign(TextAlign.Center)

              // ç”¨æˆ·åè¾“å…¥
              TextInput({ placeholder: 'ç”¨æˆ·å', text: this.username })
                .type(InputType.Normal)
                .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                .borderRadius(12)
                .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
                .fontColor(this.currentTheme.textColor)
                .placeholderColor(this.currentTheme.textColor + '60')
                .onChange((value: string) => {
                  this.username = value;
                })

              // å¯†ç è¾“å…¥
              TextInput({ placeholder: 'å¯†ç ', text: this.password })
                .type(InputType.Password)
                .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                .borderRadius(12)
                .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
                .fontColor(this.currentTheme.textColor)
                .placeholderColor(this.currentTheme.textColor + '60')
                .onChange((value: string) => {
                  this.password = value;
                })

              // ç™»å½•æŒ‰é’®
              Button('ğŸš€ ç™»å½•')
                .width('100%')
                .height(50)
                .backgroundColor(this.currentTheme.glassmorphism.accentPrimary + '30')
                .borderRadius(25)
                .border({ width: 1, color: this.currentTheme.glassmorphism.accentPrimary })
                .fontColor(this.currentTheme.glassmorphism.accentPrimary)
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .shadow({
                  radius: 20,
                  color: this.currentTheme.glassmorphism.accentPrimary + '40',
                  offsetX: 0,
                  offsetY: 0
                })
                .onClick(() => {
                  this.handleLogin();
                })

              // æ³¨å†ŒæŒ‰é’®
              Button('âœ¨ æ³¨å†Œ')
                .width('100%')
                .height(50)
                .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                .borderRadius(25)
                .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
                .fontColor(this.currentTheme.textColor)
                .fontSize(16)
                .shadow({
                  radius: 8,
                  color: this.currentTheme.glassmorphism.shadowSoft,
                  offsetX: 0,
                  offsetY: 4
                })
                .onClick(() => {
                  this.handleRegister();
                })
            }
          }
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .padding(24)
      }
    } else {
      // ä¸»ç•Œé¢å†…å®¹ - åº”ç”¨æ¸å˜èƒŒæ™¯
      ThemeAwareGradientBackground({ gradientType: 'primary' }) {
        Column() {
          // é¡¶éƒ¨æ¯›ç»ç’ƒå¯¼èˆªæ 
          Row() {
            Text('âœ¨ å¾…åŠåˆ—è¡¨')
              .fontSize(20)
              .fontColor(this.currentTheme.textColor)
              .fontWeight(FontWeight.Bold)
              .textShadow({
                radius: 8,
                color: this.currentTheme.glassmorphism.accentPrimary + '50',
                offsetX: 0,
                offsetY: 0
              })
            
            Blank()
            
            Row({ space: 12 }) {
              // æƒé™è®¾ç½®æŒ‰é’®
              Row() {
                Text('ğŸ›¡ï¸')
                  .fontSize(16)
                  .margin({ right: 4 })
                Text('æƒé™')
                  .fontSize(12)
                  .fontColor(this.currentTheme.textColor)
              }
              .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
              .borderRadius(16)
              .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .shadow({
                radius: 8,
                color: this.currentTheme.glassmorphism.shadowSoft,
                offsetX: 0,
                offsetY: 4
              })
              .onClick(() => {
                this.handlePermissionSettings();
              })

              // æ‰“å¡æŒ‰é’®
              Text('âœ“')
                .fontSize(20)
                .fontColor(this.currentTheme.glassmorphism.accentSecondary)
                .textShadow({
                  radius: 8,
                  color: this.currentTheme.glassmorphism.accentSecondary,
                  offsetX: 0,
                  offsetY: 0
                })
                .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                .borderRadius(20)
                .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
                .width(40)
                .height(40)
                .textAlign(TextAlign.Center)
                .onClick(() => {
                  promptAction.showToast({ message: "æ‰“å¡èœå•å¾…å®ç°" });
                })

              // æ·»åŠ æŒ‰é’®
              Text('+')
                .fontSize(24)
                .fontColor(this.currentTheme.glassmorphism.accentTertiary)
                .textShadow({
                  radius: 12,
                  color: this.currentTheme.glassmorphism.accentTertiary,
                  offsetX: 0,
                  offsetY: 0
                })
                .backgroundColor(this.currentTheme.glassmorphism.surfaceMedium)
                .borderRadius(20)
                .border({ width: 1, color: this.currentTheme.glassmorphism.accentTertiary })
                .width(40)
                .height(40)
                .textAlign(TextAlign.Center)
                .onClick(() => {
                  this.showAddSimpleTodoDialog();
                })

              // èœå•æŒ‰é’®
              Text('â‰¡')
                .fontSize(20)
                .fontColor(this.currentTheme.glassmorphism.accentPrimary)
                .textShadow({
                  radius: 8,
                  color: this.currentTheme.glassmorphism.accentPrimary,
                  offsetX: 0,
                  offsetY: 0
                })
                .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                .borderRadius(20)
                .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
                .width(40)
                .height(40)
                .textAlign(TextAlign.Center)
                .onClick(() => {
                  router.pushUrl({ url: 'pages/ThemeSettingsPage' });
                })
            }
          }
          .width('100%')
          .height(60)
          .padding({ left: 20, right: 20 })
          .backgroundColor(this.currentTheme.glassmorphism.blurOverlay)
          .border({ width: { bottom: 1 }, color: this.currentTheme.glassmorphism.borderLight })

          // å†…å®¹åŒºåŸŸ
          Scroll() {
            Column({ space: 16 }) {
              if (this.isLoadingTodos) {
                // åŠ è½½çŠ¶æ€çš„ç»ç’ƒå¡ç‰‡
                ThemeAwareGlassCard({ level: 'medium' }) {
                  Column() {
                    LoadingProgress()
                      .width(40)
                      .height(40)
                      .color(this.currentTheme.glassmorphism.accentPrimary)
                      .margin({ bottom: 12 })
                    Text('åŠ è½½ä¸­...')
                      .fontSize(16)
                      .fontColor(this.currentTheme.glassmorphism.accentPrimary)
                      .textShadow({
                        radius: 8,
                        color: this.currentTheme.glassmorphism.accentPrimary + '50',
                        offsetX: 0,
                        offsetY: 0
                      })
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .padding(32)
                }
              } else if (this.simpleTodos.length === 0) {
                // ç©ºçŠ¶æ€çš„ç»ç’ƒå¡ç‰‡
                ThemeAwareGlassCard({ level: 'medium' }) {
                  Column() {
                    Text('ğŸŒŸ')
                      .fontSize(48)
                      .margin({ bottom: 16 })
                    Text('æš‚æ— å¾…åŠäº‹é¡¹')
                      .fontSize(18)
                      .fontColor(this.currentTheme.glassmorphism.accentSecondary)
                      .fontWeight(FontWeight.Bold)
                      .textShadow({
                        radius: 8,
                        color: this.currentTheme.glassmorphism.accentSecondary + '50',
                        offsetX: 0,
                        offsetY: 0
                      })
                    Text('ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ æ–°çš„å¾…åŠ')
                      .fontSize(14)
                      .fontColor(this.currentTheme.textColor)
                      .opacity(0.7)
                      .margin({ top: 8 })
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .padding(40)
                }
              } else {
                // å¾…åŠåˆ—è¡¨
                ForEach(this.simpleTodos, (todo: TodoItem) => {
                  ThemeAwareGlassCard({ level: 'light' }) {
                    Row() {
                      // å®ŒæˆçŠ¶æ€æŒ‡ç¤ºå™¨
                      Circle({ width: 12, height: 12 })
                        .fill(todo.isCompleted ? 
                          this.currentTheme.glassmorphism.accentSecondary : 
                          this.currentTheme.glassmorphism.accentPrimary)
                        .shadow(todo.isCompleted ? undefined : {
                          radius: 8,
                          color: this.currentTheme.glassmorphism.accentPrimary + '60',
                          offsetX: 0,
                          offsetY: 0
                        })
                        .margin({ right: 12 })

                      // å¾…åŠå†…å®¹
                      Column() {
                        // ä½¿ç”¨Stackå®ç°æ¸å˜æ–‡å­—æ•ˆæœ
                        Stack() {
                          Text(todo.title)
                            .fontSize(16)
                            .fontWeight(FontWeight.Medium)
                            .decoration({
                              type: todo.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None
                            })
                            .opacity(todo.isCompleted ? 0.6 : 1.0)
                            .linearGradient(todo.isCompleted ? undefined : {
                              angle: 45,
                              colors: [
                                [this.currentTheme.glassmorphism.accentPrimary, 0.0],
                                [this.currentTheme.glassmorphism.accentSecondary, 1.0]
                              ]
                            })
                            .blur(todo.isCompleted ? 0 : 0.3) // è½»å¾®å“‘å…‰æ•ˆæœ
                            .textShadow({
                              radius: todo.isCompleted ? 2 : 6,
                              color: todo.isCompleted ? 
                                this.currentTheme.glassmorphism.shadowSoft : 
                                this.currentTheme.glassmorphism.accentPrimary + '50',
                              offsetX: 0,
                              offsetY: todo.isCompleted ? 1 : 2
                            })
                        }

                        if (todo.type) {
                          // å‡çº§æè¿°æ ‡ç­¾çš„æ¸å˜å’Œå“‘å…‰æ•ˆæœ
                          Stack() {
                            Text(todo.type)
                              .fontSize(12)
                              .fontColor('#FFFFFF')
                              .fontWeight(FontWeight.Medium)
                              .textShadow({
                                radius: 4,
                                color: '#00000040',
                                offsetX: 0,
                                offsetY: 1
                              })
                          }
                          .linearGradient({
                            angle: 135,
                            colors: [
                              [this.currentTheme.glassmorphism.accentSecondary, 0.0],
                              [this.currentTheme.glassmorphism.accentTertiary, 1.0]
                            ]
                          })
                          .borderRadius(12)
                          .border({ 
                            width: 1, 
                            color: this.currentTheme.glassmorphism.accentSecondary + '60' 
                          })
                          .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                          .shadow({
                            radius: 8,
                            color: this.currentTheme.glassmorphism.accentSecondary + '40',
                            offsetX: 0,
                            offsetY: 2
                          })
                          .blur(0.4) // å“‘å…‰æ•ˆæœ
                          .margin({ top: 6 })
                        }

                        // æ·»åŠ æ—¶é•¿æ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (todo.duration && todo.duration > 0) {
                          Stack() {
                            Text(`${todo.duration}åˆ†é’Ÿ`)
                              .fontSize(11)
                              .fontColor('#FFFFFF')
                              .fontWeight(FontWeight.Medium)
                              .textShadow({
                                radius: 3,
                                color: '#00000030',
                                offsetX: 0,
                                offsetY: 1
                              })
                          }
                          .linearGradient({
                            angle: 45,
                            colors: [
                              [this.currentTheme.glassmorphism.accentTertiary, 0.0],
                              [this.currentTheme.glassmorphism.accentPrimary, 1.0]
                            ]
                          })
                          .borderRadius(10)
                          .border({ 
                            width: 1, 
                            color: this.currentTheme.glassmorphism.accentTertiary + '50' 
                          })
                          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                          .shadow({
                            radius: 6,
                            color: this.currentTheme.glassmorphism.accentTertiary + '30',
                            offsetX: 0,
                            offsetY: 1
                          })
                          .blur(0.3) // è½»å¾®å“‘å…‰æ•ˆæœ
                          .margin({ top: 4 })
                        }
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)

                      // ä¸“æ³¨æŒ‰é’® - å‡çº§ä¸ºäºŒè‰²æ¸å˜å“‘å…‰æ•ˆæœ
                      Stack() {
                        Text('ä¸“æ³¨')
                          .fontSize(12)
                          .fontColor('#FFFFFF')
                          .fontWeight(FontWeight.Medium)
                          .textAlign(TextAlign.Center)
                          .width('100%')
                          .height('100%')
                          .textShadow({
                            radius: 4,
                            color: '#00000050',
                            offsetX: 0,
                            offsetY: 1
                          })
                      }
                      .width(80)
                      .height(36)
                      .padding({ left: 16, right: 16 })
                      .linearGradient({
                        angle: 135,
                        colors: [
                          [this.currentTheme.glassmorphism.accentPrimary, 0.0],
                          [this.currentTheme.glassmorphism.accentSecondary, 1.0]
                        ]
                      })
                      .borderRadius(16)
                      .border({ 
                        width: 1, 
                        color: this.currentTheme.glassmorphism.accentPrimary + '60' 
                      })
                      .shadow({
                        radius: 12,
                        color: this.currentTheme.glassmorphism.accentPrimary + '40',
                        offsetX: 0,
                        offsetY: 3
                      })
                      .blur(0.6) // å¢å¼ºå“‘å…‰æ•ˆæœ
                      .animation({
                        duration: 200,
                        curve: Curve.EaseInOut
                      })
                      .onClick(() => {
                        this.startFocusForTodo(todo);
                      })
                    }
                    .width('100%')
                    .padding(16)
                    .onClick(() => {
                      this.toggleTodoStatus(todo.id);
                    })
                  }
                }, (todo: TodoItem) => todo.id.toString())
              }
            }
            .width('100%')
            .padding(20)
          }
          .layoutWeight(1)

          // åº•éƒ¨æ¯›ç»ç’ƒå¯¼èˆªæ 
          Column() {
            TabBar({ currentIndex: 0 })
          }
          .backgroundColor(this.currentTheme.glassmorphism.blurOverlay)
          .border({ width: { top: 1 }, color: this.currentTheme.glassmorphism.borderLight })
        }
        .width('100%')
        .height('100%')
      }
    }
  }
}

// // Minimal TodoItem class is already defined above
// // class TodoItem { ... }

// // Note: System and Permission methods (getAppAbilityContext, etc.) are part of the Index struct.
// // Interfaces are defined at the top of the file.