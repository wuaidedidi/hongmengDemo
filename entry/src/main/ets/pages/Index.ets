/**
 * ğŸ  ä¸»é¡µé¢ (Index) - åº”ç”¨çš„æ ¸å¿ƒå…¥å£é¡µé¢
 * 
 * è¿™æ˜¯é‡æ„åçš„Indexé¡µé¢ï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„ç»„ä»¶åŒ–æ¶æ„è®¾è®¡
 * ç›¸æ¯”ä¹‹å‰çš„1373è¡Œä»£ç ï¼Œé‡æ„åç¼©å‡åˆ°çº¦300è¡Œï¼Œä»£ç å‡å°‘çº¦80%
 * 
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†ï¼ˆç™»å½•/ç™»å‡ºï¼‰
 * - å¾…åŠäº‹é¡¹åˆ—è¡¨æ˜¾ç¤º
 * - ä¸“æ³¨è®¡æ—¶å™¨å…¥å£
 * - ä¸»é¢˜å’Œè®¾ç½®ç®¡ç†
 * - å¤šTabé¡µé¢å¯¼èˆª
 * 
 * ğŸ—ï¸ æ¶æ„ç‰¹ç‚¹ï¼š
 * - ç»„ä»¶åŒ–è®¾è®¡ï¼šæ‹†åˆ†ä¸ºå¯å¤ç”¨çš„å­ç»„ä»¶
 * - å“åº”å¼çŠ¶æ€ï¼šä½¿ç”¨@Stateç®¡ç†é¡µé¢çŠ¶æ€
 * - ä¸»é¢˜ç³»ç»Ÿï¼šæ”¯æŒåŠ¨æ€ä¸»é¢˜åˆ‡æ¢
 * - é”™è¯¯å¤„ç†ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
 * - è·¯ç”±ç®¡ç†ï¼šçµæ´»çš„é¡µé¢å¯¼èˆªå’Œå‚æ•°ä¼ é€’
 */

import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { LoginComponent, LoginState, LoginUtils, LoginCallbacks } from '../components/auth/LoginComponent';
import { SimpleTodoList } from '../components/todo/SimpleTodoList';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../services/ThemeService';
import { ApiService, TodoItem as ApiTodoItem } from '../services/ApiService';
import { ThemeAwareGradientBackground, ThemeAwareGlassCard } from '../utils/GlassmorphismStyles';
import { CommonButton, ButtonPresets } from '../components/common/CommonButton';
import { AddTodoDialog } from '../components/dialogs/TodoDialogs';
import { globalState } from '../utils/StateManager';
import { safeExecute } from '../utils/ErrorHandler';
import { BaseRouterParams, ErrorInfo, IndexRouterParams } from '../types/CommonTypes';
import { UI_SIZES, FONT_SIZES, STRINGS } from '../constants/AppConstants';
import { TodoItem } from '../model/TodoItem';

/**
 * ğŸ§­ å¯¼èˆªæ ç»„ä»¶
 * 
 * æ˜¾ç¤ºåº”ç”¨é¡¶éƒ¨çš„å¯¼èˆªæ ï¼ŒåŒ…å«æ ‡é¢˜ã€è®¾ç½®ã€æ·»åŠ æŒ‰é’®å’Œç”¨æˆ·å¤´åƒ
 * é‡‡ç”¨ç»ç’ƒæ‹Ÿæ€è®¾è®¡é£æ ¼ï¼Œä¸ä¸»é¢˜ç³»ç»Ÿé›†æˆ
 */
@Component
struct NavigationBar {
  /** å½“å‰ä¸»é¢˜é…ç½® */
  @Prop currentTheme: ThemeConfig;
  
  /** æ·»åŠ å¾…åŠäº‹é¡¹å›è°ƒ */
  onAddTodo: () => void = () => {
  };
  
  /** æ‰“å¼€è®¾ç½®é¡µé¢å›è°ƒ */
  onSettings: () => void = () => {
  };
  
  /** æ‰“å¼€ç”¨æˆ·èµ„æ–™é¡µé¢å›è°ƒ */
  onProfile: () => void = () => {
  };

  build() {
    Row() {
      // ğŸ“± é¡µé¢æ ‡é¢˜
      Text('âœ¨ å¾…åŠåˆ—è¡¨')
        .fontSize(FONT_SIZES.TITLE_MEDIUM)
        .fontColor(this.currentTheme.textColor)
        .fontWeight(FontWeight.Bold)

      // å¡«å……ç©ºç™½ç©ºé—´ï¼Œå°†å³ä¾§æŒ‰é’®æ¨åˆ°å³è¾¹
      Blank()

      // ğŸ”§ åŠŸèƒ½æŒ‰é’®ç»„
      Row({ space: 12 }) {
        // âš™ï¸ è®¾ç½®æŒ‰é’®
        Text('âš™ï¸')
          .fontSize(FONT_SIZES.TITLE_MEDIUM)
          .fontColor(this.currentTheme.glassmorphism.accentSecondary)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
          .borderRadius(20)
          .width(40)
          .height(40)
          .textAlign(TextAlign.Center)
          .onClick(() => this.onSettings())

        // â• æ·»åŠ å¾…åŠæŒ‰é’®
        Text('+')
          .fontSize(FONT_SIZES.TITLE_LARGE)
          .fontColor(this.currentTheme.glassmorphism.accentTertiary)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceMedium)
          .borderRadius(20)
          .width(40)
          .height(40)
          .textAlign(TextAlign.Center)
          .onClick(() => this.onAddTodo())

        // ğŸ‘¤ ç”¨æˆ·å¤´åƒæŒ‰é’®
        Text('ğŸ‘¤')
          .fontSize(FONT_SIZES.TITLE_MEDIUM)
          .fontColor(this.currentTheme.glassmorphism.accentPrimary)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
          .borderRadius(20)
          .width(40)
          .height(40)
          .textAlign(TextAlign.Center)
          .onClick(() => this.onProfile())
      }
    }
    .width('100%')
    .padding(16)
    // ä½¿ç”¨ç»ç’ƒæ‹Ÿæ€èƒŒæ™¯æ•ˆæœ
    .backgroundColor(this.currentTheme.glassmorphism.surfaceLight + '80')
  }
}

/**
 * ğŸ  ä¸»Indexé¡µé¢ç»„ä»¶ - é‡æ„åçš„ç°ä»£åŒ–ç‰ˆæœ¬
 * 
 * è¿™æ˜¯åº”ç”¨çš„ä¸»å…¥å£é¡µé¢ï¼Œé‡‡ç”¨Tabå¯¼èˆªç»“æ„
 * æ•´åˆäº†ç”¨æˆ·è®¤è¯ã€å¾…åŠç®¡ç†ã€ä¸“æ³¨è®¡æ—¶ç­‰æ ¸å¿ƒåŠŸèƒ½
 */
@Entry
@Component
struct Index {
  // ğŸ“Š æ ¸å¿ƒçŠ¶æ€ç®¡ç† - å¤§å¹…ç®€åŒ–åçš„çŠ¶æ€
  
  /** å½“å‰Tabç´¢å¼•ï¼ˆ0: å¾…åŠäº‹é¡¹, 1: å¾…åŠåˆé›†, 2: é”æœºé¡µé¢ç­‰ï¼‰ */
  @State currentIndex: number = 0;
  
  /** ç”¨æˆ·ç™»å½•çŠ¶æ€ */
  @State loginState: LoginState = LoginUtils.createEmptyLoginState();
  
  /** å½“å‰ä¸»é¢˜é…ç½® */
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;
  
  // ğŸ”§ æœåŠ¡å®ä¾‹
  /** æ·»åŠ å¾…åŠå¯¹è¯æ¡†æ§åˆ¶å™¨ */
  private addTodoDialogController: CustomDialogController | null = null;
  
  /** ä¸»é¢˜æœåŠ¡å®ä¾‹ */
  private themeService: ThemeService = ThemeService.getInstance();
  
  /** APIæœåŠ¡å®ä¾‹ */
  private apiService: ApiService = ApiService.getInstance();
  
  /**
   * ğŸ¨ ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
   * 
   * å½“ä¸»é¢˜å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°é¡µé¢ä¸»é¢˜
   * ä½¿ç”¨å®‰å…¨æ‰§è¡ŒåŒ…è£…å™¨å¤„ç†æ½œåœ¨çš„å¼‚æ­¥é”™è¯¯
   */
  private themeChangeListener = async () => {
    await safeExecute(
      async () => {
        this.currentTheme = await this.themeService.getCurrentTheme();
        console.info('âœ… Indexé¡µé¢ä¸»é¢˜å·²æ›´æ–°:', this.currentTheme.name);
      },
      (error: ErrorInfo) => console.error('âŒ Indexä¸»é¢˜æ›´æ–°å¤±è´¥:', error.message)
    );
  };

  /**
   * ğŸš€ ç»„ä»¶å³å°†å‡ºç° - åˆå§‹åŒ–é¡µé¢
   * 
   * é¡µé¢ç”Ÿå‘½å‘¨æœŸçš„å…³é”®é˜¶æ®µï¼Œè´Ÿè´£ï¼š
   * 1. æ³¨å†Œä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
   * 2. åŠ è½½ç”¨æˆ·ä¸»é¢˜åå¥½
   * 3. å¤„ç†è·¯ç”±å‚æ•°
   */
  async aboutToAppear() {
    // æ³¨å†Œä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    
    // åŠ è½½ä¸»é¢˜é…ç½®
    await this.loadTheme();
    
    // å¤„ç†è·¯ç”±å‚æ•°ï¼ˆå¦‚ä¸“æ³¨å®Œæˆå›è°ƒç­‰ï¼‰
    this.handleRouteParams();
  }

  /**
   * ğŸ”š ç»„ä»¶å³å°†æ¶ˆå¤± - æ¸…ç†èµ„æº
   * 
   * é¡µé¢é”€æ¯æ—¶çš„æ¸…ç†å·¥ä½œï¼Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨
   */
  aboutToDisappear() {
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  /**
   * ğŸ¨ åŠ è½½ä¸»é¢˜é…ç½®
   * 
   * ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç”¨æˆ·çš„ä¸»é¢˜åå¥½è®¾ç½®
   * å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤ä¸»é¢˜
   */
  private async loadTheme(): Promise<void> {
    await safeExecute(
      async () => {
        await this.themeService.loadThemePreference();
        this.currentTheme = await this.themeService.getCurrentTheme();
        console.info('âœ… Indexé¡µé¢åŠ è½½ä¸»é¢˜æˆåŠŸ:', this.currentTheme.name);
      },
      (error: ErrorInfo) => console.error('âŒ Indexé¡µé¢åŠ è½½ä¸»é¢˜å¤±è´¥:', error.message)
    );
  }

  /**
   * å¤„ç†è·¯ç”±å‚æ•°
   */
  private async handleRouteParams(): Promise<void> {
    const routeParams = router.getParams() as IndexRouterParams;
    
    // å¤„ç†åˆå§‹Tabè®¾ç½®
    if (routeParams?.initialTab !== undefined) {
      this.currentIndex = routeParams.initialTab;
      console.info('è®¾ç½®åˆå§‹Tabç´¢å¼•:', routeParams.initialTab);
      return; // å¦‚æœæœ‰initialTabå‚æ•°ï¼Œç›´æ¥è¿”å›ä¸å¤„ç†å…¶ä»–é€»è¾‘
    }
    
    if (routeParams?.action === 'focusCompleted' && routeParams.todoId !== undefined) {
      const todoId = Number(routeParams.todoId);
      await safeExecute(
        async () => {
          const apiTodos: ApiTodoItem[] = await this.apiService.getTodoItems();
          const todo: ApiTodoItem | undefined = apiTodos.find((t: ApiTodoItem) => t.id === todoId);
          if (todo) {
            promptAction.showToast({ message: `ä»»åŠ¡ "${todo.title}" ä¸“æ³¨å®Œæˆï¼` });
          }
        },
        (error: ErrorInfo) => console.error('è·å–å¾…åŠä¿¡æ¯å¤±è´¥:', error.message)
      );
    }
    this.currentIndex = 0;
  }

  onPageShow() {
    console.info("Index page onPageShow triggered");
    this.handleRouteParams();
  }

  /**
   * åˆ›å»ºç™»å½•å›è°ƒ - ä½¿ç”¨å·¥å…·ç±»
   */
  private createLoginCallbacks(): LoginCallbacks {
    return LoginUtils.createDefaultCallbacks(
      (loginState: LoginState) => {
        this.loginState = loginState;
        globalState.login(loginState.username, loginState.userId || 0, loginState.token || '');
        console.info('ç”¨æˆ·ç™»å½•æˆåŠŸ:', loginState.username);
      },
      (error: string) => {
        console.error('ç™»å½•å¤±è´¥:', error);
      }
    );
  }

  /**
   * æ˜¾ç¤ºæ·»åŠ å¾…åŠå¯¹è¯æ¡†
   */
  private async showAddTodoDialog(): Promise<void> {
    await safeExecute(
      async () => {
        const currentTheme = await this.themeService.getCurrentTheme();

        this.addTodoDialogController = new CustomDialogController({
          builder: AddTodoDialog({
            currentTheme: currentTheme,
            onConfirm: (name: string, type: string, duration: number) => {
              this.handleAddTodo(name, type, duration);
            }
          }),
          autoCancel: true,
          alignment: DialogAlignment.Center,
          customStyle: true
        });

        this.addTodoDialogController.open();
      },
      (error: ErrorInfo) => {
        console.error('æ‰“å¼€æ·»åŠ å¾…åŠå¯¹è¯æ¡†å¤±è´¥:', error.message);
        promptAction.showToast({ message: 'æ‰“å¼€å¯¹è¯æ¡†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
      }
    );
  }

  /**
   * å¤„ç†æ·»åŠ å¾…åŠ
   */
  private handleAddTodo(name: string, type: string, duration: number): void {
    if (!name.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠåç§°' });
      return;
    }
    console.info('æ·»åŠ å¾…åŠ:', { name, type, duration });
  }

  /**
   * å¤„ç†é€€å‡ºç™»å½•
   */
  private async handleLogout(): Promise<void> {
    await safeExecute(
      async () => {
        this.loginState = LoginUtils.createEmptyLoginState();
        globalState.logout();
        promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
      },
      (error: ErrorInfo) => console.error('é€€å‡ºç™»å½•å¤±è´¥:', error.message)
    );
  }

  build() {
    if (!this.loginState.isLoggedIn) {
      // ä½¿ç”¨ç™»å½•ç»„ä»¶ - å¤§å¹…ç®€åŒ–
      LoginComponent({
        callbacks: this.createLoginCallbacks()
      })
    } else {
      // ä¸»ç•Œé¢
      ThemeAwareGradientBackground({ gradientType: 'primary' }) {
        Column() {
          // å¯¼èˆªæ ç»„ä»¶
          NavigationBar({
            currentTheme: this.currentTheme,
            onAddTodo: () => this.showAddTodoDialog(),
            onSettings: () => router.pushUrl({ url: 'pages/ThemeSettingsPage' }),
            onProfile: () => router.pushUrl({ url: 'pages/Profile' })
          })

          // ä¸»å†…å®¹åŒºåŸŸ - ä½¿ç”¨Tabs
          Tabs({
            barPosition: BarPosition.End,
            index: this.currentIndex
          }) {
            // å¾…åŠäº‹é¡¹é¡µé¢ - ä½¿ç”¨SimpleTodoListç»„ä»¶
            TabContent() {
              SimpleTodoList()
            }
            .tabBar(this.TabBuilder('ğŸ“', 'å¾…åŠ', 0))

            // å¾…åŠåˆé›†é¡µé¢ - è‡ªåŠ¨è·³è½¬åˆ°åˆé›†é¡µé¢
            TabContent() {
              Column() {
                Text('æ­£åœ¨è·³è½¬åˆ°åˆé›†ç®¡ç†...')
                  .fontSize(FONT_SIZES.BODY_MEDIUM)
                  .fontColor(this.currentTheme.textColor)
                  .opacity(0.6)
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
            .tabBar(this.TabBuilder('ğŸ“‹', 'åˆé›†', 1))

            // é”æœºé¡µé¢
            TabContent() {
              Column() {
                Text('é”æœºåŠŸèƒ½')
                  .fontSize(FONT_SIZES.TITLE_LARGE)
                  .fontColor(this.currentTheme.textColor)
                  .margin(20)

                CommonButton({
                  config: ButtonPresets.primary('è¿›å…¥é”æœº', () => {
                    router.pushUrl({ url: 'pages/LockPage' });
                  })
                })
                  .margin(20)
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
            }
            .tabBar(this.TabBuilder('ğŸ”’', 'é”æœº', 2))

            // ç»Ÿè®¡é¡µé¢ - è‡ªåŠ¨è·³è½¬åˆ°ç»Ÿè®¡é¡µé¢
            TabContent() {
              Column() {
                Text('æ­£åœ¨è·³è½¬åˆ°ç»Ÿè®¡é¡µé¢...')
                  .fontSize(FONT_SIZES.BODY_MEDIUM)
                  .fontColor(this.currentTheme.textColor)
                  .opacity(0.6)
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
            .tabBar(this.TabBuilder('ğŸ“Š', 'ç»Ÿè®¡', 3))

            // æˆ‘çš„é¡µé¢ - è‡ªåŠ¨è·³è½¬åˆ°ä¸ªäººèµ„æ–™é¡µé¢
            TabContent() {
              Column() {
                Text('æ­£åœ¨è·³è½¬åˆ°ä¸ªäººèµ„æ–™...')
                  .fontSize(FONT_SIZES.BODY_MEDIUM)
                  .fontColor(this.currentTheme.textColor)
                  .opacity(0.6)
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
            .tabBar(this.TabBuilder('ğŸ‘¤', 'æˆ‘çš„', 4))
          }
          .width('100%')
          .layoutWeight(1)
          .onChange((index: number) => {
            this.currentIndex = index;
            // æ ¹æ®Tabç´¢å¼•è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”é¡µé¢ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
            switch (index) {
              case 1: // åˆé›†Tab
                router.replaceUrl({ url: 'pages/TodoPage' });
                break;
              case 3: // ç»Ÿè®¡Tab
                router.replaceUrl({ url: 'pages/StatisticsPage' });
                break;
              case 4: // æˆ‘çš„Tab
                router.replaceUrl({ url: 'pages/Profile' });
                break;
              default:
                break;
            }
          })
        }
        .width('100%')
        .height('100%')
      }
    }
  }

  /**
   * Tabæ ‡ç­¾æ„å»ºå™¨
   */
  @Builder
  TabBuilder(icon: string, title: string, index: number) {
    Column() {
      Text(icon)
        .fontSize(FONT_SIZES.TITLE_MEDIUM)
        .fontColor(this.currentIndex === index ?
        this.currentTheme.glassmorphism.accentPrimary :
          this.currentTheme.textColor + '60')

      Text(title)
        .fontSize(FONT_SIZES.CAPTION)
        .fontColor(this.currentIndex === index ?
        this.currentTheme.glassmorphism.accentPrimary :
          this.currentTheme.textColor + '60')
        .margin({ top: 2 })
    }
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .width('100%')
    .height(UI_SIZES.TAB_BAR_HEIGHT)
    .backgroundColor(this.currentIndex === index ?
      this.currentTheme.glassmorphism.surfaceLight + '40' :
      'transparent')
    .borderRadius(8)
  }
} 