import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import wantConstant from '@ohos.ability.wantConstant';
import Want from '@ohos.app.ability.Want';
import { TabBar } from '../components/TabBar';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import { PhxSystemActionUtil } from '../utils/PhxSystemActionUtil';
import { ApiService, TodoItemRequest } from '../services/ApiService';
import type { TodoItem as ApiTodoItem } from '../services/ApiService';
import { ThemeService, ThemeConfig } from '../services/ThemeService';

// TodoList è¢«ç§»é™¤ï¼Œå› ä¸ºå®ƒä¸ TodoCollection å…³è”è¾ƒå¤šï¼Œåç»­æŒ‰éœ€è°ƒæ•´
// import { TodoList } from '../view/TodoList';

// ä¸ç›´æ¥å¯¼å…¥Contextç±»å‹ï¼Œæˆ‘ä»¬å°†åœ¨éœ€è¦æ—¶ä½¿ç”¨commonæ¨¡å—
// Index.ets

// å®šä¹‰é€šç”¨é”™è¯¯æ¥å£ï¼Œæ›¿ä»£any/unknownç±»å‹
interface CommonError {
  message: string;
  code?: string | number;
  name?: string;
  stack?: string;
  cause?: string;
  detail?: string;
  // ç§»é™¤ç´¢å¼•ç­¾åï¼ŒArkTSä¸æ”¯æŒ
}

// ç³»ç»Ÿè®¾ç½®è·³è½¬å‚æ•°æ¥å£
interface SettingsWantOptions {
  action?: string;
  bundleName?: string;
  abilityName?: string;
  uri?: string;
  parameters?: Record<string, string | number | boolean | Array<string | number | boolean>>;
}

// Wantç±»å‹å®šä¹‰
interface SystemWant {
  action?: string;
  bundleName?: string;
  abilityName?: string;
  uri?: string;
  parameters?: Record<string, string | number | boolean | Array<string | number | boolean>>;
}

// ä¸Šä¸‹æ–‡æ¥å£å®šä¹‰
interface ContextLike {
  applicationInfo?: Record<string, string>;
  startAbility: Function;
}

// FocusTimeré¡µé¢è·¯ç”±å‚æ•°å®šä¹‰
interface FocusTimerRouterParams {
  taskTitle?: string;
  title?: string;
  time?: number; // æ³¨æ„ï¼šFocusTimer æœŸæœ›çš„æ˜¯ç§’
  duration?: number; // è¿™ä¸ªå¯èƒ½æ˜¯åˆ†é’Ÿï¼Œéœ€è¦ç»Ÿä¸€
  isSequence?: boolean; // Index é¡µé¢ä¸å†å¤„ç†åºåˆ—
  collectionId?: string; // Index é¡µé¢ä¸å†å¤„ç†åˆé›†
  subTaskId?: string; // Index é¡µé¢ä¸å†å¤„ç†å­ä»»åŠ¡
  currentSubTaskIndex?: number; // Index é¡µé¢ä¸å†å¤„ç†å­ä»»åŠ¡ç´¢å¼•
  totalSubTasksInCollection?: number; // Index é¡µé¢ä¸å†å¤„ç†åˆé›†ä»»åŠ¡æ€»æ•°
  todoId?: string | number; // æ”¯æŒå¾…åŠäº‹é¡¹ID
}

// æ·»åŠ è‡ªå¯åŠ¨è®¾ç½®Wantå‚æ•°æ¥å£
interface StartupSettingsParams {
  packageName: string;
}

// TodoOperationé¡µé¢è·¯ç”±å‚æ•°å®šä¹‰ (å¯èƒ½ä»éœ€è°ƒæ•´ï¼Œå–å†³äºç®€å•å¾…åŠçš„æ“ä½œ)
interface TodoOperationParams {
  todoId: string | number;
  todoTitle?: string;
}

// // å­ä»»åŠ¡ç¼–è¾‘é¡µé¢è·¯ç”±å‚æ•° (ä»Indexç§»é™¤)
// interface SubTaskEditPageParams {
//   collectionId: string;
//   subTaskId: string;
// }

// // å­ä»»åŠ¡æŸ¥æ‰¾ç»“æœæ¥å£ (ä»Indexç§»é™¤)
// interface SubTaskResult {
//   collection: TodoCollection | undefined;
//   subtask: ActualTodoItem | undefined;
// }

// å®šä¹‰AboutToAppearæ–¹æ³•ä¸­ä½¿ç”¨çš„å‚æ•°æ¥å£
interface AboutToAppearParams {
  action?: string;
  todoId?: string | number; // ä¿ç•™ç”¨äºç®€å•å¾…åŠè¿”å›
  // sequenceAction?: string; // ç§»é™¤åºåˆ—ç›¸å…³
  // collectionId?: string | number; // ç§»é™¤åˆé›†ç›¸å…³
  // completedSubTaskIndex?: string | number; // ç§»é™¤å­ä»»åŠ¡ç›¸å…³
  // currentSubTaskIndexCompleted?: number; // ç§»é™¤å­ä»»åŠ¡ç›¸å…³
  // allSubTasksInCollectionCompleted?: boolean; // ç§»é™¤åˆé›†å®Œæˆç›¸å…³
}

// å®šä¹‰åç§»é‡ç±»
class DialogOffset {
  dx: number;
  dy: number;

  constructor(dx: number, dy: number) {
    this.dx = dx;
    this.dy = dy;
  }
}

// æƒé™åˆ—è¡¨ç±»å‹
class PermissionItem {
  name: string;
  granted: boolean;

  constructor(name: string, granted: boolean) {
    this.name = name;
    this.granted = granted;
  }
}

// è·¯ç”±å‚æ•°æ¥å£
interface RouterParams {
  action?: string;
  todoId?: string | number; // ç®€å•å¾…åŠID
  // ç§»é™¤åºåˆ—å’Œåˆé›†ç›¸å…³å‚æ•°
  // sequenceAction?: string;
  // collectionId?: string | number;
  // completedSubTaskIndex?: string | number;
  // currentSubTaskIndexCompleted?: string;
  // allSubTasksInCollectionCompleted?: string;
}

// TodoItemç±»å®šä¹‰ (è¿™ä¸ªæ˜¯ Index.ets ä½¿ç”¨çš„ç®€å•å¾…åŠé¡¹)
class TodoItem {
  id: number; // ç®€å•å¾…åŠä½¿ç”¨æ•°å­—ID
  title: string;
  type: string; // ä¾‹å¦‚ï¼š'å­¦ä¹ ', 'å·¥ä½œ', 'é”»ç‚¼'
  duration: number = 25; // é»˜è®¤25åˆ†é’Ÿ
  isCompleted: boolean = false; // æ·»åŠ å®ŒæˆçŠ¶æ€

  constructor(id: number, title: string, type: string, duration: number = 25, isCompleted: boolean = false) {
    this.id = id;
    this.title = title;
    this.type = type;
    this.duration = duration;
    this.isCompleted = isCompleted;
  }

  formatDuration(): string {
    return `${this.duration}åˆ†é’Ÿ`;
  }
}

// // æ–°çš„ï¼šå•ä¸ªå…·ä½“å¾…åŠäº‹é¡¹ (ç§»è‡³ TodoDetail.ets)
// class ActualTodoItem { ... }

// // ä¿®æ”¹çš„ï¼šå¾…åŠäº‹é¡¹åˆé›† (ç§»è‡³ TodoDetail.ets)
// class TodoCollection { ... }

// åœ¨æ–‡ä»¶é¡¶éƒ¨çš„æ¥å£å®šä¹‰éƒ¨åˆ†æ·»åŠ ä¸€ä¸ªé€šç”¨é”™è¯¯ç±»å‹
// é€šç”¨é”™è¯¯ç±»å‹ï¼Œç”¨äºå¤„ç†å„ç§é”™è¯¯æƒ…å†µ
interface ErrorInfo {
  message: string;
  code?: number;
  details?: string;
}

// åˆ›å»ºé”™è¯¯ä¿¡æ¯çš„è¾…åŠ©æ–¹æ³•
function createErrorInfo(err: Error): ErrorInfo {
  return { message: err.message };
}

// ä»å­—ç¬¦ä¸²åˆ›å»ºé”™è¯¯ä¿¡æ¯
function createErrorInfoFromString(errStr: string): ErrorInfo {
  return { message: errStr };
}

// ä»å¯¹è±¡åˆ›å»ºé”™è¯¯ä¿¡æ¯
function createErrorInfoFromObject(errObj: CommonError): ErrorInfo {
  const message = errObj.message ? String(errObj.message) : "æœªçŸ¥é”™è¯¯";
  const code = typeof errObj.code === 'number' ? errObj.code : undefined;
  const details = String(errObj);
  return { message, code, details };
}

// AddSimpleTodoDialog ä¿æŒï¼Œç”¨äºæ·»åŠ ç®€å•å¾…åŠ
@CustomDialog
struct AddSimpleTodoDialog {
  @Link todoName: string;
  @Link todoType: string;
  @Link todoDuration: number;
  onConfirm: () => void = () => {
  };
  controller?: CustomDialogController;

  build() {
    Column() {
      Text("æ·»åŠ æ–°å¾…åŠ").fontSize(20).fontWeight(FontWeight.Bold).margin({ bottom: 20 })
      TextInput({ placeholder: "å¾…åŠåç§°", text: this.todoName })
        .onChange(val => {
          this.todoName = val;
        })
        .margin({ bottom: 10 })
      TextInput({ placeholder: "ç±»å‹ (å¦‚: å­¦ä¹ , å·¥ä½œ)", text: this.todoType })
        .onChange(val => {
          this.todoType = val;
        })
        .margin({ bottom: 10 })
      TextInput({ placeholder: "æ—¶é•¿ (åˆ†é’Ÿ)", text: this.todoDuration.toString() })
        .type(InputType.Number)
        .onChange(val => {
          this.todoDuration = Number(val) || 25;
        })
        .margin({ bottom: 20 })
      Row({ space: 10 }) {
        Button("å–æ¶ˆ").onClick(() => this.controller?.close()).layoutWeight(1)
        Button("ç¡®å®š").onClick(() => {
          this.onConfirm();
          this.controller?.close();
        }).layoutWeight(1).backgroundColor('#8A2BE2')
      }.width('100%')
    }
    .padding(20).width("80%").backgroundColor(Color.White).borderRadius(15)
  }
}

// // New CustomDialog for adding TodoCollection (ç§»è‡³ TodoDetail.ets)
// @CustomDialog
// struct AddCollectionDialog { ... }

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State bgColor: string = 'rgba(255, 192, 203, 0.15)';
  @State isClockInMenuShow: boolean = false;
  @State isClockInStatsShow: boolean = false;
  @State isPermissionDialogShow: boolean = false;
  @State isLoggedIn: boolean = false;
  @State username: string = '';
  @State password: string = '';
  @State currentTheme: ThemeConfig = {
    id: 'light',
    name: 'æµ…è‰²ä¸»é¢˜',
    primaryColor: '#007AFF',
    backgroundColor: '#FFFFFF',
    textColor: '#000000',
    cardBackgroundColor: '#F8F8F8',
    borderColor: '#E0E0E0',
    shadowColor: 'rgba(0, 0, 0, 0.1)',
    errorColor: '#FF3B30'
  };
  private apiService: ApiService = ApiService.getInstance();
  private themeService: ThemeService = ThemeService.getInstance();
  private themeChangeListener = (theme: ThemeConfig) => {
    this.currentTheme = theme;
    console.info('Indexé¡µé¢ä¸»é¢˜å·²æ›´æ–°:', theme.name);
  };
  // ä½¿ç”¨åç«¯APIçš„å¾…åŠäº‹é¡¹
  @State simpleTodos: TodoItem[] = [];
  @State isLoadingTodos: boolean = false;
  // @State selectedTodoId: number = -1; // å¦‚æœéœ€è¦è·Ÿè¸ªé€‰ä¸­çš„ç®€å•å¾…åŠï¼Œå¯ä»¥ä¿ç•™
  @State isOperationMenuShow: boolean = false; // ä¿ç•™æ“ä½œèœå•çŠ¶æ€ (å¯èƒ½ç”¨äºç®€å•å¾…åŠçš„ç¼–è¾‘/åˆ é™¤)
  // @State showAddTodoModal: boolean = false; // AddSimpleTodoDialog æœ‰è‡ªå·±çš„controller

  // ç”¨äº AddSimpleTodoDialog çš„çŠ¶æ€å˜é‡
  @State newSimpleTodoName: string = '';
  @State newSimpleTodoType: string = '';
  @State newSimpleTodoDuration: number = 25;
  permissionList: PermissionItem[] = [
    new PermissionItem('é€šçŸ¥æƒé™', false),
    new PermissionItem('æ—¥å†æƒé™', false),
    new PermissionItem('ä½ç½®æƒé™', false)
  ];
  // // Dialog controller for adding collections (ç§»é™¤)
  // private addCollectionDialog: CustomDialogController = ... ;

  // Dialog controller for adding simple todos
  private addSimpleTodoDialogController: CustomDialogController = new CustomDialogController({
    builder: AddSimpleTodoDialog({
      todoName: $newSimpleTodoName,
      todoType: $newSimpleTodoType,
      todoDuration: $newSimpleTodoDuration,
      onConfirm: () => {
        this.addNewSimpleTodo();
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: false // æ ¹æ®éœ€è¦è®¾ç½®
  });

  async aboutToAppear() {
    this.checkLoginStatus();
    // æ³¨å†Œä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    // åŠ è½½å½“å‰ä¸»é¢˜
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
      console.info('Indexé¡µé¢åŠ è½½ä¸»é¢˜:', this.currentTheme.name);
    } catch (error) {
      console.error('Indexé¡µé¢åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
    }
  }

  aboutToDisappear() {
    // æ³¨é”€ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  async checkLoginStatus() {
    const savedUsername = await this.apiService.getUsername();
    const savedToken = await this.apiService.getToken();

    // åªæœ‰åœ¨åŒæ—¶å­˜åœ¨ç”¨æˆ·åå’Œæœ‰æ•ˆtokenæ—¶æ‰è‡ªåŠ¨ç™»å½•
    if (savedUsername && savedToken) {
      this.username = savedUsername;
      this.isLoggedIn = true;
      console.info('è‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œç”¨æˆ·:', this.username);
      // ç™»å½•æˆåŠŸååŠ è½½å¾…åŠäº‹é¡¹
      await this.loadTodos();
    } else {
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„ç™»å½•çŠ¶æ€ï¼Œæ¸…é™¤å¯èƒ½æ®‹ç•™çš„æ•°æ®
      await this.apiService.clearAuth();
      this.isLoggedIn = false;
      console.info('æœªæ‰¾åˆ°æœ‰æ•ˆç™»å½•çŠ¶æ€');
    }
  }

  async handleLogin() {
    console.info('ç‚¹å‡»ç™»å½•ï¼Œç”¨æˆ·å:', this.username, 'å¯†ç :', this.password);
    try {
      console.info('è°ƒç”¨ ApiService.login');
      const response = await this.apiService.login(this.username, this.password);
      console.info('åç«¯è¿”å›:', JSON.stringify(response));
      await this.apiService.setToken(response.token);
      await this.apiService.setUsername(this.username);
      this.isLoggedIn = true;
      promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' });
      // ç™»å½•æˆåŠŸååŠ è½½å¾…åŠäº‹é¡¹
      await this.loadTodos();
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥è¯¦ç»†ä¿¡æ¯:', JSON.stringify(error));
      console.error('é”™è¯¯æ¶ˆæ¯:', (error as Error).message);
      promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼š' + (error as Error).message });
    }
  }

  async handleRegister() {
    try {
      await this.apiService.register(this.username, this.password);
      promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•' });
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error);
      promptAction.showToast({ message: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
    }
  }

  async handleLogout() {
    await this.apiService.clearAuth();
    this.isLoggedIn = false;
    this.username = '';
    this.password = '';
    promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
  }

  async handleCheckIn() {
    try {
      await this.apiService.checkIn();
      promptAction.showToast({ message: 'æ‰“å¡æˆåŠŸ' });
      this.isClockInMenuShow = false;
    } catch (error) {
      console.error('æ‰“å¡å¤±è´¥:', error);
    }
  }

  onPageShow() {
    console.info("Index page onPageShow triggered");
    const routeParams = router.getParams() as RouterParams;
    if (routeParams && typeof routeParams === 'object') {
      console.info('Index onPageShow router.getParams(): ' + JSON.stringify(routeParams));

      if (routeParams.action === 'focusCompleted' && routeParams.todoId !== undefined) {
        const completedTodoId = Number(routeParams.todoId);
        // é€šè¿‡APIæ›´æ–°å¾…åŠçŠ¶æ€
        this.toggleTodoStatus(completedTodoId);

        const todo = this.simpleTodos.find(t => t.id === completedTodoId);
        if (todo) {
          promptAction.showToast({ message: `ä»»åŠ¡ "${todo.title}" ä¸“æ³¨å®Œæˆï¼` });
        }
      }
      // ç§»é™¤æ‰€æœ‰ä¸ sequenceAction, collectionId, completedSubTaskIndex ç›¸å…³çš„å¤„ç†é€»è¾‘
    }
    this.currentIndex = 0; // ç¡®ä¿åœ¨é¡µé¢æ˜¾ç¤ºæ—¶ currentIndex æ­£ç¡®

    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
    this.loadTodos();
  }

  async addNewSimpleTodo() {
    if (this.newSimpleTodoName.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠåç§°' });
      return;
    }
    if (this.newSimpleTodoType.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¾…åŠç±»å‹' });
      return;
    }
    if (this.newSimpleTodoDuration <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿' });
      return;
    }

    try {
      const todoData: TodoItemRequest = {
        title: this.newSimpleTodoName.trim(),
        description: this.newSimpleTodoType.trim(),
        type: this.newSimpleTodoType.trim() || 'general',
        duration: this.newSimpleTodoDuration,
        isImportant: false,
        isUrgent: false
      };

      const newTodo: ApiTodoItem = await this.apiService.createTodoItem(todoData);

      // è½¬æ¢ä¸ºæœ¬åœ°TodoItemæ ¼å¼
      const localTodo = new TodoItem(
        newTodo.id,
        newTodo.title,
        newTodo.type || 'general',
        newTodo.duration || 25,
        newTodo.completed
      );

      this.simpleTodos.push(localTodo);

      // é‡ç½®è¾“å…¥æ¡†
      this.newSimpleTodoName = '';
      this.newSimpleTodoType = '';
      this.newSimpleTodoDuration = 25;

      promptAction.showToast({ message: "æ–°å¾…åŠå·²æ·»åŠ " });
    } catch (error) {
      console.error('æ·»åŠ å¾…åŠå¤±è´¥:', error);
      promptAction.showToast({ message: 'æ·»åŠ å¾…åŠå¤±è´¥ï¼š' + (error as Error).message });
    }
  }

  // åŠ è½½å¾…åŠäº‹é¡¹
  async loadTodos() {
    if (!this.isLoggedIn) {
      return;
    }

    try {
      this.isLoadingTodos = true;
      const todos: ApiTodoItem[] = await this.apiService.getTodoItems();

      // è½¬æ¢ä¸ºæœ¬åœ°TodoItemæ ¼å¼
      this.simpleTodos = todos.map((todo: ApiTodoItem) => new TodoItem(
        todo.id,
        todo.title,
        todo.type || 'general',
        todo.duration || 25,
        todo.completed
      ));
    } catch (error) {
      console.error('åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥:', error);
      promptAction.showToast({ message: 'åŠ è½½å¾…åŠäº‹é¡¹å¤±è´¥' });
    } finally {
      this.isLoadingTodos = false;
    }
  }

  // åˆ‡æ¢å¾…åŠå®ŒæˆçŠ¶æ€
  async toggleTodoStatus(todoId: number) {
    try {
      const updatedTodo: ApiTodoItem = await this.apiService.toggleTodoItemStatus(todoId);

      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      const index = this.simpleTodos.findIndex(t => t.id === todoId);
      if (index !== -1) {
        this.simpleTodos[index].isCompleted = updatedTodo.completed;
        this.simpleTodos = Array.from(this.simpleTodos); // è§¦å‘UIæ›´æ–°
      }

      promptAction.showToast({
        message: updatedTodo.completed ? 'ä»»åŠ¡å·²å®Œæˆ' : 'ä»»åŠ¡å·²é‡æ–°æ¿€æ´»'
      });
    } catch (error) {
      console.error('æ›´æ–°å¾…åŠçŠ¶æ€å¤±è´¥:', error);
      promptAction.showToast({ message: 'æ›´æ–°çŠ¶æ€å¤±è´¥' });
    }
  }

  // åˆ é™¤å¾…åŠäº‹é¡¹
  async deleteTodo(todoId: number) {
    try {
      await this.apiService.deleteTodoItem(todoId);

      // ä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤
      this.simpleTodos = this.simpleTodos.filter(t => t.id !== todoId);

      promptAction.showToast({ message: 'å¾…åŠå·²åˆ é™¤' });
    } catch (error) {
      console.error('åˆ é™¤å¾…åŠå¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' });
    }
  }

  // // startSequenceTask (ç§»é™¤)

  handlePermissionSettings() {
    const context = this.getAppAbilityContext();
    if (!context) {
      promptAction.showToast({ message: "æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡" });
      return;
    }
    // è·³è½¬åˆ°åº”ç”¨è¯¦æƒ…é¡µ
    PhxSystemActionUtil.goAppInfoSetting(context);
  }

  // --- System and Permission Methods Placeholder ---
  getAppAbilityContext(): common.UIAbilityContext | undefined {
    const context = getContext(this) as common.UIAbilityContext; // æ˜ç¡®ç±»å‹
    if (context && typeof context === 'object') {
      try {
        // å°è¯•å°†contextè½¬ä¸ºUIAbilityContextç±»å‹
        const uiContext = context as common.UIAbilityContext;
        // æ£€æŸ¥å¿…è¦çš„å±æ€§æ˜¯å¦å­˜åœ¨
        if (uiContext.applicationInfo !== undefined && typeof uiContext.startAbility === 'function') {
          return uiContext;
        }
      } catch (e) {
        console.error("Context conversion to UIAbilityContext error: " + ((e as Error).message || String(e)));
      }
    }
    console.warn("Failed to get a valid UIAbilityContext.");
    return undefined;
  }

  async startSystemSettingsGuidanceFlow() {
    console.info('[MyTestApp] startSystemSettingsGuidanceFlow: Method executing with new logic.');
    const context = this.getAppAbilityContext();
    if (!context) {
      promptAction.showToast({ message: "æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡" });
      return;
    }

    const currentBundleName = context.applicationInfo?.name || context.abilityInfo?.bundleName || '';
    if (!currentBundleName) {
      promptAction.showToast({ message: "æ— æ³•è·å–å½“å‰åº”ç”¨åŒ…å" });
      console.error('[MyTestApp] æ— æ³•è·å–å½“å‰åº”ç”¨åŒ…å');
      return;
    }
    console.info(`[MyTestApp] å½“å‰åº”ç”¨åŒ…å: ${currentBundleName}`);

    // ä¾æ¬¡å°è¯•æ‰€æœ‰å¸¸è§action
    const tryWants: Want[] = [
      { action: 'ohos.settings.action.application_details_settings', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.APP_DETAILS', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.APP_PERMISSION_MANAGER', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.APP_NOTIFICATION_SETTINGS', parameters: { bundleName: currentBundleName } },
      { action: 'ohos.settings.action.SETTINGS' }
    ];
    let success = false;
    for (let want of tryWants) {
      try {
        console.info(`[MyTestApp] å°è¯•action: ${JSON.stringify(want)}`);
        await context.startAbility(want as Want);
        console.info('[MyTestApp] è·³è½¬è®¾ç½®ç›¸å…³é¡µé¢æˆåŠŸ');
        success = true;
        break;
      } catch (e) {
        console.error(`[MyTestApp] è·³è½¬å¤±è´¥: ${e}`);
        // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
      }
    }
    if (!success) {
      promptAction.showToast({
        message: "æ— æ³•æ‰“å¼€è®¾ç½®é¡µé¢ï¼Œè¯·æ‰‹åŠ¨å‰å¾€è®¾ç½®",
        duration: 3000
      });
    }
  }

  createSystemWant(options: SettingsWantOptions): SystemWant {
    // This function should create a Want object based on options
    // Placeholder implementation
    let want: Want = {
      bundleName: options.bundleName,
      abilityName: options.abilityName,
      uri: options.uri,
      parameters: options.parameters,
      action: options.action
    };
    // Make sure Want conforms to SystemWant, or SystemWant is an interface Want implements
    return want as SystemWant;
  }

  // --- End of Placeholder ---

  // åˆ é™¤ç®€å•å¾…åŠæŒ‰é’®æ„å»ºå™¨
  @Builder
  deleteSimpleTodoBuilder(todo: TodoItem) {
    Row() {
      Column() {
        Text('ğŸ—‘ï¸')
          .fontSize(18)
          .margin({ bottom: 2 })
        Text('åˆ é™¤')
          .fontSize(12)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .width(80)
      .height('100%')
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [['#FF6B6B', 0.0], ['#FF3B30', 1.0]]
      })
      .shadow({
        radius: 8,
        color: 'rgba(255, 59, 48, 0.3)',
        offsetX: 2,
        offsetY: 2
      })
      .onClick(() => {
        AlertDialog.show({
          title: 'ç¡®è®¤åˆ é™¤',
          message: `ç¡®å®šè¦åˆ é™¤å¾…åŠäº‹é¡¹"${todo.title}"å—ï¼Ÿ`,
          primaryButton: {
            value: 'å–æ¶ˆ',
            action: () => {}
          },
          secondaryButton: {
            value: 'åˆ é™¤',
            fontColor: '#FF3B30',
            action: () => {
              this.deleteTodo(todo.id);
            }
          }
        });
      })
      .gesture(
        TapGesture()
          .onAction(() => {
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
            animateTo({
              duration: 150,
              curve: Curve.FastOutSlowIn
            }, () => {
              // ç‚¹å‡»åé¦ˆåŠ¨ç”»
            })
          })
      )
      .stateStyles({
        pressed: {
          .backgroundColor('#D32F2F')
          .scale({ x: 0.95, y: 0.95 })
        },
        normal: {
          .backgroundColor('transparent')
          .scale({ x: 1.0, y: 1.0 })
        }
      })
    }
    .width(80)
    .height('100%')
    .backgroundColor('transparent')
  }

  build() {
    Column() {
      if (!this.isLoggedIn) {
        // ç™»å½•è¡¨å•
        Column() {
          Text('é¸¿è’™æ¯æ—¥æ‰“å¡')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 50, bottom: 30 })

          TextInput({ placeholder: 'ç”¨æˆ·å', text: this.username })
            .width('80%')
            .height(50)
            .margin({ bottom: 20 })
            .onChange((value: string) => {
              this.username = value;
            })

          TextInput({ placeholder: 'å¯†ç ', text: this.password })
            .width('80%')
            .height(50)
            .margin({ bottom: 30 })
            .type(InputType.Password)
            .onChange((value: string) => {
              this.password = value;
            })

          Button('ç™»å½•')
            .width('80%')
            .height(50)
            .backgroundColor('#8A2BE2')
            .onClick(() => {
              this.handleLogin();
            })

          Button('æ³¨å†Œ')
            .width('80%')
            .height(50)
            .margin({ top: 20 })
            .backgroundColor('#F5F5F5')
            .fontColor('#8A2BE2')
            .onClick(() => {
              this.handleRegister();
            })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#FFFFFF')
      } else {
        // ä¸»ç•Œé¢å†…å®¹
        Stack() {
          Column() {
            // é¡¶éƒ¨æ ‡é¢˜æ 
            Row() {
              Text('å¾…åŠåˆ—è¡¨')
                .fontSize(22).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
              Blank()
              Row({ space: 16 }) {
                Row() {
                  Text('å¿…å¼€').fontSize(14).fontColor('#FFFFFF')
                  Text('æƒé™').fontSize(14).fontColor('#FFFFFF')
                }
                .backgroundColor('rgba(255, 255, 255, 0.2)')
                .borderRadius(12)
                .padding({
                  left: 8,
                  right: 8,
                  top: 4,
                  bottom: 4
                })
                .margin({ right: 4 })
                .onClick(() => {
                  this.handlePermissionSettings();
                })

                Text('âœ“').fontSize(24).fontColor('#FFFFFF')
                  .onClick(() => {
                    promptAction.showToast({ message: "æ‰“å¡èœå•å¾…å®ç°" });
                  })
                Text('+').fontSize(24).fontColor('#FFFFFF')
                  .onClick(() => {
                    this.newSimpleTodoName = '';
                    this.newSimpleTodoType = '';
                    this.newSimpleTodoDuration = 25;
                    this.addSimpleTodoDialogController.open();
                  })
                Text('â‰¡').fontSize(24).fontColor('#FFFFFF')
                  .onClick(() => {
                    promptAction.showToast({ message: "æ›´å¤šèœå•å¾…å®ç°" });
                  })
              }
            }
            .width('100%')
            .height(50)
            .padding({ left: 16, right: 16 })
            .backgroundColor(this.currentTheme.primaryColor)

            // å†…å®¹åŒºåŸŸ
            Scroll() {
              Column({ space: 10 }) {
                if (this.isLoadingTodos) {
                  Row() {
                    LoadingProgress()
                      .width(30)
                      .height(30)
                      .margin({ right: 10 })
                    Text('åŠ è½½ä¸­...')
                      .fontSize(16)
                      .fontColor(this.currentTheme.textColor)
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Center)
                  .padding(20)
                } else if (this.simpleTodos.length === 0) {
                  Column() {
                    Text('æš‚æ— å¾…åŠäº‹é¡¹')
                      .fontSize(16)
                      .fontColor(this.currentTheme.textColor)
                      .opacity(0.6)
                    Text('ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ æ–°çš„å¾…åŠ')
                      .fontSize(14)
                      .fontColor(this.currentTheme.textColor)
                      .opacity(0.4)
                      .margin({ top: 8 })
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Center)
                  .padding(40)
                } else {
                  List({ space: 10 }) {
                  ForEach(this.simpleTodos, (todo: TodoItem) => {
                      ListItem() {
                    Row() {
                      Column() {
                        Text(todo.title)
                          .fontSize(18)
                          .fontWeight(FontWeight.Bold)
                          .fontColor(this.currentTheme.textColor)
                          .decoration({
                            type: todo.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None
                          })
                          .opacity(todo.isCompleted ? 0.6 : 1.0)
                              .textAlign(TextAlign.Start)
                        Text(`${todo.type} - ${todo.formatDuration()}`)
                          .fontSize(14)
                          .fontColor(this.currentTheme.textColor)
                          .opacity(todo.isCompleted ? 0.4 : 0.7)
                          .decoration({
                            type: todo.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None
                          })
                          .margin({ top: 4 })
                              .textAlign(TextAlign.Start)
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)

                          // åªä¿ç•™ä¸“æ³¨æŒ‰é’®
                        if (!todo.isCompleted) {
                          Button('ä¸“æ³¨')
                            .fontSize(12)
                            .fontColor(Color.White)
                            .backgroundColor(this.currentTheme.primaryColor)
                            .borderRadius(8)
                            .height(28)
                            .padding({ left: 8, right: 8 })
                            .onClick(() => {
                              const params: FocusTimerRouterParams = {
                                title: todo.title,
                                taskTitle: todo.title,
                                time: todo.duration * 60,
                                todoId: todo.id,
                                isSequence: false
                              };
                              router.pushUrl({ url: 'pages/FocusTimer', params: params })
                                .catch((err: Error) => {
                                  console.error(`è·³è½¬FocusTimerå‡ºé”™: ${err.message}`);
                                });
                            })
                        }
                    }
                    .width('100%')
                    .backgroundColor(this.currentTheme.cardBackgroundColor)
                    .borderRadius(8)
                    .padding(12)
                    .opacity(todo.isCompleted ? 0.7 : 1.0)
                      }
                      .swipeAction({
                        end: {
                          builder: () => {
                            this.deleteSimpleTodoBuilder(todo)
                          }
                        }
                      })
                  }, (todo: TodoItem) => todo.id.toString())
                  }
                  .width('100%')
                  .divider({ strokeWidth: 0 }) // ç§»é™¤åˆ†å‰²çº¿
                }
              }
              .width('100%')
              .padding(16)
            }
            .layoutWeight(1)

            // åº•éƒ¨å¯¼èˆªæ 
            TabBar({ currentIndex: 0 })
          }
          .width('100%')
          .height('100%')
          .backgroundColor(this.currentTheme.backgroundColor)
        }
      }
    }
  }
}

// // Minimal TodoItem class is already defined above
// // class TodoItem { ... }

// // Note: System and Permission methods (getAppAbilityContext, etc.) are part of the Index struct.
// // Interfaces are defined at the top of the file.