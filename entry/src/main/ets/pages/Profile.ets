import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { TabBar } from '../components/TabBar';
import { ApiService } from '../services/ApiService';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../services/ThemeService';

// èœå•é¡¹æŽ¥å£
interface MenuItem {
  icon: string;
  title: string;
  onClick: () => void;
}

@Entry
@Component
struct Profile {
  @State showLogoutConfirm: boolean = false;
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;
  @State username: string = '';
  private apiService = ApiService.getInstance();
  private themeService = ThemeService.getInstance();

  private themeChangeListener = async () => {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
    } catch (error) {
      console.error('Profileä¸»é¢˜æ›´æ–°å¤±è´¥:', error);
    }
  };

  async aboutToAppear() {
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    // é¦–å…ˆåŠ è½½ä¿å­˜çš„ä¸»é¢˜åå¥½è®¾ç½®
    await this.themeService.loadThemePreference();
    this.currentTheme = await this.themeService.getCurrentTheme();
    // èŽ·å–ç”¨æˆ·å
    this.username = await this.apiService.getUsername() || 'ç”¨æˆ·';
  }

  aboutToDisappear() {
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  handleLogout() {
    this.showLogoutConfirm = true;
  }

  async confirmLogout() {
    // æ‰§è¡Œç™»å‡ºæ“ä½œ
    this.showLogoutConfirm = false;
    await this.apiService.clearAuth();
    promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
    router.pushUrl({ url: 'pages/Index' });
  }

  // è‹¹æžœé£Žæ ¼çš„èœå•é¡¹ç»„ä»¶
  @Builder
  MenuCard(title: string, items: MenuItem[]) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.currentTheme.textColor)
        .opacity(0.6)
        .width('100%')
        .textAlign(TextAlign.Start)
        .margin({ bottom: 12 })

      Column() {
        ForEach(items, (item: MenuItem, index: number) => {
          Row() {
            Text(item.icon)
              .fontSize(20)
              .width(32)
              .textAlign(TextAlign.Center)
            
            Text(item.title)
              .fontSize(16)
              .fontColor(this.currentTheme.textColor)
              .layoutWeight(1)
              .margin({ left: 12 })
            
            Text('â€º')
              .fontSize(18)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.3)
          }
          .width('100%')
          .height(52)
          .padding({ left: 16, right: 16 })
          .onClick(item.onClick)

          if (index < items.length - 1) {
            Divider()
              .color(this.currentTheme.glassmorphism.borderLight)
              .strokeWidth(0.5)
              .margin({ left: 60, right: 16 })
          }
        }, (item: MenuItem, index: number) => `${item.title}_${index}`)
      }
      .width('100%')
      .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
      .borderRadius(16)
      .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
      .shadow({
        radius: 8,
        color: this.currentTheme.glassmorphism.shadowSoft,
        offsetX: 0,
        offsetY: 4
      })
    }
    .width('100%')
    .margin({ bottom: 24 })
  }

  // è‹¹æžœé£Žæ ¼çš„ç»Ÿè®¡å¡ç‰‡
  @Builder
  StatCard(icon: string, title: string, value: string, subtitle: string) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 8 })
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.glassmorphism.accentPrimary)
        .margin({ bottom: 4 })
      Text(title)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.currentTheme.textColor)
        .margin({ bottom: 2 })
      Text(subtitle)
        .fontSize(12)
        .fontColor(this.currentTheme.textColor)
        .opacity(0.6)
    }
    .width('100%')
    .height(120)
    .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
    .borderRadius(16)
    .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
    .shadow({
      radius: 8,
      color: this.currentTheme.glassmorphism.shadowSoft,
      offsetX: 0,
      offsetY: 4
    })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  build() {
    Stack() {
      Column() {
        // è‹¹æžœé£Žæ ¼çš„ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
        Column() {
          // ç”¨æˆ·å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯
          Column() {
            // å¤´åƒ
            Stack() {
              Circle({ width: 80, height: 80 })
                .fill(this.currentTheme.glassmorphism.accentPrimary)
                .shadow({
                  radius: 16,
                  color: this.currentTheme.glassmorphism.accentPrimary + '40',
                  offsetX: 0,
                  offsetY: 8
                })
              
              Text('ðŸ‘¤')
                .fontSize(40)
                .fontColor('#FFFFFF')
            }
            .margin({ bottom: 16 })

            // ç”¨æˆ·å
            Text(this.username)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.textColor)
              .margin({ bottom: 8 })

            // åŠ å…¥æ—¶é—´
            Text('ä¸“æ³¨è¾¾äºº Â· 2024å¹´åŠ å…¥')
              .fontSize(14)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.6)
              .margin({ bottom: 24 })

            // ç»Ÿè®¡æ•°æ®
            Row({ space: 16 }) {
              this.StatCard('ðŸŽ¯', 'ä¸“æ³¨æ¬¡æ•°', '42', 'æœ¬å‘¨ +8')
              this.StatCard('â°', 'ä¸“æ³¨æ—¶é•¿', '18h', 'æœ¬å‘¨ +3h')
              this.StatCard('ðŸ”¥', 'è¿žç»­å¤©æ•°', '7', 'æœ€é•¿ 15å¤©')
            }
            .width('100%')
          }
          .width('100%')
          .padding(24)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
          .borderRadius(20)
          .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
          .shadow({
            radius: 16,
            color: this.currentTheme.glassmorphism.shadowMedium,
            offsetX: 0,
            offsetY: 8
          })
          .margin({ bottom: 32 })
        }

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            // ä¸ªæ€§åŒ–è®¾ç½®
            this.MenuCard('ä¸ªæ€§åŒ–', [
              {
                icon: 'ðŸŽ¨',
                title: 'ä¸»é¢˜è®¾ç½®',
                onClick: (): void => {
                  router.pushUrl({ url: 'pages/ThemeSettingsPage' });
                }
              } as MenuItem,
              {
                icon: 'ðŸ””',
                title: 'é€šçŸ¥è®¾ç½®',
                onClick: (): void => {
                  promptAction.showToast({ message: 'é€šçŸ¥è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...' });
                }
              } as MenuItem,
              {
                icon: 'ðŸŒ™',
                title: 'å¤œé—´æ¨¡å¼',
                onClick: (): void => {
                  promptAction.showToast({ message: 'å¤œé—´æ¨¡å¼åŠŸèƒ½å¼€å‘ä¸­...' });
                }
              } as MenuItem
            ])

            // åº”ç”¨è®¾ç½®
            this.MenuCard('åº”ç”¨è®¾ç½®', [
              {
                icon: 'âš™ï¸',
                title: 'é€šç”¨è®¾ç½®',
                onClick: (): void => {
                  promptAction.showToast({ message: 'é€šç”¨è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...' });
                }
              } as MenuItem,
              {
                icon: 'ðŸ”’',
                title: 'éšç§ä¸Žå®‰å…¨',
                onClick: (): void => {
                  promptAction.showToast({ message: 'éšç§è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...' });
                }
              } as MenuItem,
              {
                icon: 'ðŸ“Š',
                title: 'æ•°æ®ç»Ÿè®¡',
                onClick: (): void => {
                  router.pushUrl({ url: 'pages/StatisticsPage' });
                }
              } as MenuItem
            ])

            // æ”¯æŒä¸Žå¸®åŠ©
            this.MenuCard('æ”¯æŒ', [
              {
                icon: 'â“',
                title: 'å¸®åŠ©ä¸­å¿ƒ',
                onClick: (): void => {
                  promptAction.showToast({ message: 'å¸®åŠ©ä¸­å¿ƒåŠŸèƒ½å¼€å‘ä¸­...' });
                }
              } as MenuItem,
              {
                icon: 'ðŸ’¬',
                title: 'æ„è§åé¦ˆ',
                onClick: (): void => {
                  promptAction.showToast({ message: 'æ„è§åé¦ˆåŠŸèƒ½å¼€å‘ä¸­...' });
                }
              } as MenuItem,
              {
                icon: 'â„¹ï¸',
                title: 'å…³äºŽåº”ç”¨',
                onClick: (): void => {
                  promptAction.showToast({ message: 'ä¸“æ³¨å¾…åŠž v1.0.0' });
                }
              } as MenuItem
            ])

            // é€€å‡ºç™»å½•æŒ‰é’®
            Button() {
              Row() {
                Text('âš ï¸')
                  .fontSize(20)
                  .margin({ right: 12 })
                Text('é€€å‡ºç™»å½•')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.currentTheme.glassmorphism.accentSecondary)
              }
            }
            .width('100%')
            .height(52)
            .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
            .borderRadius(16)
            .border({ 
              width: 2, 
              color: this.currentTheme.glassmorphism.accentSecondary 
            })
            .shadow({
              radius: 8,
              color: this.currentTheme.glassmorphism.accentSecondary + '30',
              offsetX: 0,
              offsetY: 4
            })
            .onClick(() => {
              this.handleLogout();
            })
            .margin({ bottom: 120 })
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)

        // åº•éƒ¨å¯¼èˆªæ 
        TabBar({ currentIndex: 4 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.currentTheme.backgroundColor)
      .padding({ top: 20 })

      // è‹¹æžœé£Žæ ¼çš„é€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
      if (this.showLogoutConfirm) {
        Column() {
          Column() {
            Text('âš ï¸')
              .fontSize(48)
              .margin({ bottom: 20 })
            
            Text('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.textColor)
              .margin({ bottom: 8 })
            
            Text('é€€å‡ºåŽéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ä½¿ç”¨')
              .fontSize(14)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.6)
              .textAlign(TextAlign.Center)
              .margin({ bottom: 32 })

            Row({ space: 12 }) {
              Button('å–æ¶ˆ')
                .layoutWeight(1)
                .height(44)
                .fontSize(16)
                .fontColor(this.currentTheme.textColor)
                .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
                .borderRadius(22)
                .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
                .onClick(() => {
                  this.showLogoutConfirm = false;
                })

              Button('ç¡®è®¤é€€å‡º')
                .layoutWeight(1)
                .height(44)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FFFFFF')
                .backgroundColor(this.currentTheme.glassmorphism.accentSecondary)
                .borderRadius(22)
                .onClick(() => {
                  this.confirmLogout();
                })
            }
            .width('100%')
          }
          .width(300)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
          .borderRadius(20)
          .padding(24)
          .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
          .shadow({
            radius: 24,
            color: this.currentTheme.glassmorphism.shadowStrong,
            offsetX: 0,
            offsetY: 12
          })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showLogoutConfirm = false;
        })
      }
    }
  }
}