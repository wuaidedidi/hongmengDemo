import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { TabBar } from '../components/TabBar';
import { ApiService } from '../services/ApiService';
import { ThemeService, ThemeConfig } from '../services/ThemeService';

@Entry
@Component
struct Profile {
  @State showLogoutConfirm: boolean = false;
  @State currentTheme: ThemeConfig = {
    id: 'light',
    name: 'æµ…è‰²ä¸»é¢˜',
    primaryColor: '#007AFF',
    backgroundColor: '#FFFFFF',
    textColor: '#000000',
    cardBackgroundColor: '#F8F8F8',
    borderColor: '#E0E0E0',
    shadowColor: 'rgba(0, 0, 0, 0.1)',
    errorColor: '#FF3B30'
  };
  private apiService = ApiService.getInstance();
  private themeService = ThemeService.getInstance();

  private themeChangeListener = (theme: ThemeConfig) => {
    this.currentTheme = theme;
  };

  async aboutToAppear() {
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    this.currentTheme = await this.themeService.getCurrentTheme();
  }

  aboutToDisappear() {
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
  }

  handleLogout() {
    this.showLogoutConfirm = true;
  }

  async confirmLogout() {
    // æ‰§è¡Œç™»å‡ºæ“ä½œ
    this.showLogoutConfirm = false;
    await this.apiService.clearAuth();
    promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
    router.pushUrl({ url: 'pages/Index' });
  }
  @Builder
  MenuItem(icon: string, title: string, onClick: () => void) {
    Row() {
      Row() {
        Text(icon)
          .fontSize(20)
          .margin({ right: 12 })
        Text(title)
          .fontSize(16)
          .fontColor(this.currentTheme.textColor)
      }
      Text('>')
        .fontSize(16)
        .fontColor(this.currentTheme.textColor)
        .opacity(0.6)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(this.currentTheme.cardBackgroundColor)
    .justifyContent(FlexAlign.SpaceBetween)
    .onClick(onClick)
  }

  build() {
    Stack() {
      Column() {
        // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
        Column() {
          Text('ðŸ‘¤')
            .fontSize(48)
            .fontColor(Color.White)
            .margin({ bottom: 16 })
          Text('ç”¨æˆ·å')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
            .fontColor(Color.White)
          Text('åŠ å…¥æ—¶é—´ï¼š2024-01-01')
            .fontSize(14)
            .opacity(0.8)
            .fontColor(Color.White)
        }
        .width('100%')
        .padding({ top: 40, bottom: 24 })
        .backgroundColor(this.currentTheme.primaryColor)
        .alignItems(HorizontalAlign.Center)

        // èœå•åˆ—è¡¨
        Column() {
          this.MenuItem('âš™ï¸', 'è®¾ç½®', () => {
            promptAction.showToast({ message: 'è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...' });
          })
          Divider().color(this.currentTheme.borderColor).height(1)

          this.MenuItem('ðŸ””', 'é€šçŸ¥è®¾ç½®', () => {
            promptAction.showToast({ message: 'é€šçŸ¥è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...' });
          })
          Divider().color(this.currentTheme.borderColor).height(1)

          this.MenuItem('ðŸŽ¨', 'ä¸»é¢˜è®¾ç½®', () => {
            router.pushUrl({ url: 'pages/ThemeSettingsPage' });
          })
          Divider().color(this.currentTheme.borderColor).height(1)

          this.MenuItem('ðŸ”’', 'éšç§è®¾ç½®', () => {
            promptAction.showToast({ message: 'éšç§è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...' });
          })
          Divider().color(this.currentTheme.borderColor).height(1)

          this.MenuItem('â“', 'å¸®åŠ©ä¸Žåé¦ˆ', () => {
            promptAction.showToast({ message: 'å¸®åŠ©ä¸Žåé¦ˆåŠŸèƒ½å¼€å‘ä¸­...' });
          })
          Divider().color(this.currentTheme.borderColor).height(1)

          this.MenuItem('â„¹ï¸', 'å…³äºŽ', () => {
            promptAction.showToast({ message: 'å…³äºŽåŠŸèƒ½å¼€å‘ä¸­...' });
          })
          Divider().color(this.currentTheme.borderColor).height(1)

          // é€€å‡ºç™»å½•é€‰é¡¹
          Row() {
            Row() {
              Text('âš ï¸')
                .fontSize(20)
                .margin({ right: 12 })
              Text('é€€å‡ºç™»å½•')
                .fontSize(16)
                .fontColor(this.currentTheme.errorColor)
                .fontWeight(FontWeight.Bold)
            }
            .layoutWeight(1)
            .alignItems(VerticalAlign.Center)

            Text('ðŸšª')
              .fontSize(18)
              .fontColor(this.currentTheme.errorColor)
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .backgroundColor(this.currentTheme.cardBackgroundColor)
          .border({ width: 1, color: this.currentTheme.errorColor, radius: 8 })
          .margin({ top: 8, left: 16, right: 16 })
          .onClick(() => {
            this.handleLogout();
          })
        }
        .margin({ top: 16 })
        .layoutWeight(1)
        .backgroundColor(this.currentTheme.cardBackgroundColor)
        .padding({ top: 8, bottom: 8 })

        // åº•éƒ¨å¯¼èˆªæ 
        TabBar({ currentIndex: 4 })
      }
      .width('100%')
      .height('100%')

      // é€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
      if (this.showLogoutConfirm) {
        Column() {
          Column() {
            Text('ç¡®è®¤é€€å‡º')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.textColor)
              .margin({ bottom: 16 })

            Text('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')
              .fontSize(14)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.7)
              .margin({ bottom: 24 })

            Row() {
              Button('å–æ¶ˆ')
                .backgroundColor(this.currentTheme.backgroundColor)
                .fontColor(this.currentTheme.textColor)
                .layoutWeight(1)
                .onClick(() => {
                  this.showLogoutConfirm = false;
                })

              Blank().width(12)

              Button('ç¡®å®š')
                .backgroundColor(this.currentTheme.errorColor)
                .fontColor(Color.White)
                .layoutWeight(1)
                .onClick(() => {
                  this.confirmLogout();
                })
            }
            .width('100%')
          }
          .width(280)
          .padding(24)
          .backgroundColor(this.currentTheme.cardBackgroundColor)
          .borderRadius(12)
        }
        .width('100%')
        .height('100%')
        .backgroundColor(this.currentTheme.shadowColor)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.currentTheme.backgroundColor)
  }
}