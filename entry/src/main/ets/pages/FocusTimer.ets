import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import audioPlayer from '../common/AudioPlayer';

@Entry
@Component
export default struct FocusTimer {
  @State minutes: number = 0;
  @State seconds: number = 0;
  @State totalSeconds: number = 0;
  @State isPaused: boolean = false;
  @State quote: string = 'çºµç„¶ç¼“æ…¢ï¼Œé©°è€Œä¸æ¯ã€‚';
  @State todoTitle: string = '';
  @State isMusicDialogShow: boolean = false; // æ˜¯å¦æ˜¾ç¤ºéŸ³ä¹é€‰æ‹©å¯¹è¯æ¡†
  @State selectedMusic: string = 'æ— å£°'; // å½“å‰é€‰æ‹©çš„éŸ³ä¹
  private timerId: number = -1;
  private musicOptions: string[] = ['æ— å£°', 'è½»æŸ”é’¢ç´', 'è‡ªç„¶é›¨å£°', 'æµ·æµªå£°', 'æ£®æ—é¸Ÿé¸£', 'ç™½å™ªéŸ³', 'å†¥æƒ³éŸ³ä¹'];

  aboutToAppear() {
    const params = router.getParams();
    if (params) {
      const paramsObj = params as Record<string, string | number>;
      if (paramsObj.time !== undefined) {
        this.totalSeconds = paramsObj.time as number;
        this.minutes = Math.floor(this.totalSeconds / 60);
        this.seconds = this.totalSeconds % 60;
      }
      if (paramsObj.title !== undefined) {
        this.todoTitle = paramsObj.title as string;
      }
    }
    
    // é»˜è®¤25åˆ†é’Ÿ
    if (this.totalSeconds <= 0) {
      this.totalSeconds = 25 * 60;
      this.minutes = 25;
      this.seconds = 0;
    }
    
    // å¯åŠ¨è®¡æ—¶å™¨
    this.startTimer();
  }

  aboutToDisappear() {
    // æ¸…é™¤è®¡æ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
    
    // åœæ­¢éŸ³ä¹æ’­æ”¾
    audioPlayer.stop();
  }
  
  startTimer() {
    // ç¡®ä¿åªæœ‰ä¸€ä¸ªè®¡æ—¶å™¨åœ¨è¿è¡Œ
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
    }
    
    this.timerId = setInterval(() => {
      if (!this.isPaused) {
        if (this.totalSeconds > 0) {
          this.totalSeconds--;
          this.minutes = Math.floor(this.totalSeconds / 60);
          this.seconds = this.totalSeconds % 60;
        } else {
          // è®¡æ—¶ç»“æŸ
          clearInterval(this.timerId);
          this.timerId = -1;
          // è®¡æ—¶ç»“æŸæ—¶åœæ­¢éŸ³ä¹
          audioPlayer.stop();
          promptAction.showToast({
            message: 'ä¸“æ³¨æ—¶é—´ç»“æŸï¼',
            duration: 3000
          });
        }
      }
    }, 1000);
  }
  
  // æ’­æ”¾é€‰æ‹©çš„éŸ³ä¹
  playSelectedMusic(music: string) {
    this.selectedMusic = music;
    
    try {
      // æ’­æ”¾é€‰ä¸­çš„éŸ³ä¹
      audioPlayer.play(music);
      
      promptAction.showToast({
        message: music === 'æ— å£°' ? 'å·²åˆ‡æ¢åˆ°é™éŸ³æ¨¡å¼' : `æ­£åœ¨æ’­æ”¾: ${music}`,
        duration: 2000
      });
    } catch (error) {
      console.error(`æ’­æ”¾éŸ³ä¹å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'æ’­æ”¾éŸ³ä¹å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
  
  build() {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 180,
          colors: [['#333355', 0.0], ['#503060', 0.3], ['#803070', 0.7], ['#8A2BE2', 1.0]]
        })
      
      // ä¸»å†…å®¹
      Column() {
        // é¡¶éƒ¨åŒºåŸŸ
        Row() {
          Text('17:06')
            .fontSize(20)
            .fontColor('#FFFFFF')
            .margin({ left: 16 })
          
          Blank()
          
          Row({ space: 4 }) {
            Text('ğŸ“·')
              .fontSize(24)
              .fontColor('#FFFFFF')
            Text('â§‰')
              .fontSize(24)
              .fontColor('#FFFFFF')
            Text('â†—')
              .fontSize(24)
              .fontColor('#FFFFFF')
            Text('â¬‡')
              .fontSize(24)
              .fontColor('#FFFFFF')
          }
          .margin({ right: 16 })
        }
        .width('100%')
        .height(60)
        
        // å¼•ç”¨åŒºåŸŸ
        Row() {
          Text('"')
            .fontSize(60)
            .fontColor('#FFFFFF')
            .opacity(0.5)
            .margin({ top: -30 })
          
          Column() {
            Text(this.quote)
              .fontSize(22)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
              .margin({ top: 30 })
          }
          .layoutWeight(1)
        }
        .width('100%')
        .margin({ top: 16, bottom: 32 })
        .padding({ left: 16, right: 16 })
        
        // å€’è®¡æ—¶åŒºåŸŸ
        Column() {
          Stack() {
            Circle()
              .width(300)
              .height(300)
              .fill('transparent')
              .stroke('#FFFFFF')
              .strokeWidth(8)
              .opacity(0.5)
            
            Text(`${this.minutes.toString().padStart(2, '0')}:${this.seconds.toString().padStart(2, '0')}`)
              .fontSize(80)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
          }
          .margin({ top: 40, bottom: 40 })
          
          // æç¤ºæ–‡æœ¬
          Text('ç‚¹å‡»å¼€å§‹æŒ‰é’®æ¥ä¸“æ³¨è®¡æ—¶')
            .fontSize(18)
            .fontColor('#FFFFFF')
            .opacity(0.8)
          
          Text(`${this.isPaused ? 'å·²æš‚åœ' : 'è¿›è¡Œä¸­'} Â· ${this.selectedMusic}`)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .opacity(0.6)
            .margin({ top: 8 })
        }
        .layoutWeight(1)
        .width('100%')
        .justifyContent(FlexAlign.Center)
        
        // åº•éƒ¨æ§åˆ¶æ 
        Row() {
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Text('ğŸŒ™')
              .fontSize(24)
              .fontColor('#FFFFFF')
          }
          .width(50)
          .height(50)
          .backgroundColor('rgba(255, 255, 255, 0.2)')
          
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Text('ğŸµ')
              .fontSize(24)
              .fontColor('#FFFFFF')
          }
          .width(50)
          .height(50)
          .backgroundColor('rgba(255, 255, 255, 0.2)')
          .onClick(() => {
            this.isMusicDialogShow = true;
          })
          
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Text(this.isPaused ? 'â–¶' : 'â¸')
              .fontSize(30)
              .fontColor('#FFFFFF')
          }
          .width(70)
          .height(70)
          .backgroundColor('rgba(255, 255, 255, 0.3)')
          .margin({ left: 16, right: 16 })
          .onClick(() => {
            this.isPaused = !this.isPaused;
            
            // å¤„ç†éŸ³ä¹çš„æš‚åœå’Œæ¢å¤
            if (this.isPaused) {
              audioPlayer.pause();
            } else {
              // åªæœ‰åœ¨é"æ— å£°"æ¨¡å¼ä¸‹æ¢å¤æ’­æ”¾
              if (this.selectedMusic !== 'æ— å£°') {
                audioPlayer.resume();
              }
            }
          })
          
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Text('â†»')
              .fontSize(24)
              .fontColor('#FFFFFF')
          }
          .width(50)
          .height(50)
          .backgroundColor('rgba(255, 255, 255, 0.2)')
          .onClick(() => {
            // é‡ç½®è®¡æ—¶å™¨
            this.isPaused = true;
            this.totalSeconds = 25 * 60; // é‡ç½®ä¸º25åˆ†é’Ÿ
            this.minutes = 25;
            this.seconds = 0;
            
            // åœæ­¢éŸ³ä¹
            audioPlayer.pause();
          })
          
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Text('â– ')
              .fontSize(24)
              .fontColor('#FFFFFF')
          }
          .width(50)
          .height(50)
          .backgroundColor('rgba(255, 255, 255, 0.2)')
          .onClick(() => {
            // åœæ­¢éŸ³ä¹
            audioPlayer.stop();
            router.back();
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 30 })
        
        Text('â†“')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .margin({ bottom: 24 })
          .onClick(() => {
            // åœæ­¢éŸ³ä¹
            audioPlayer.stop();
            router.back();
          })
      }
      .width('100%')
      .height('100%')
      
      // éŸ³ä¹é€‰æ‹©å¯¹è¯æ¡†
      if (this.isMusicDialogShow) {
        Column() {
          Column() {
            // æ ‡é¢˜
            Text('é€‰æ‹©èƒŒæ™¯éŸ³ä¹')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 20, bottom: 16 })
            
            // éŸ³ä¹é€‰é¡¹åˆ—è¡¨
            List() {
              ForEach(this.musicOptions, (music: string) => {
                ListItem() {
                  Row() {
                    Text(music)
                      .fontSize(18)
                      .fontColor(this.selectedMusic === music ? '#8A2BE2' : '#333333')
                      .fontWeight(this.selectedMusic === music ? FontWeight.Bold : FontWeight.Normal)
                    
                    Blank()
                    
                    if (this.selectedMusic === music) {
                      Text('âœ“')
                        .fontSize(18)
                        .fontColor('#8A2BE2')
                    }
                  }
                  .width('100%')
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .onClick(() => {
                    this.playSelectedMusic(music);
                    this.isMusicDialogShow = false;
                  })
                }
              })
            }
            .width('100%')
            .margin({ bottom: 20 })
            
            // å–æ¶ˆæŒ‰é’®
            Button('å–æ¶ˆ')
              .width('80%')
              .height(45)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#8A2BE2')
              .borderRadius(22)
              .margin({ bottom: 20 })
              .onClick(() => {
                this.isMusicDialogShow = false;
              })
          }
          .width('85%')
          .borderRadius(16)
          .backgroundColor('#FFFFFF')
          .alignItems(HorizontalAlign.Center)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          // ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
          this.isMusicDialogShow = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }
} 