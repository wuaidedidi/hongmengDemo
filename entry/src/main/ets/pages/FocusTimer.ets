import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { FocusTimerParams } from '../models/FocusTimerParams';
import { ApiService } from '../services/ApiService';
import AudioPlayer from '../common/AudioPlayer';
import { ThemeService, ThemeConfig, DEFAULT_THEME_CONFIG } from '../services/ThemeService';
import { NextTaskDialog } from '../components/dialogs/NextTaskDialog';
import { 
  FocusCompletionParams, 
  TaskLogInfo, 
  SoundOption, 
  NextTaskItem,
  FocusTimerRouterParams
} from '../types/CommonTypes';

// ç±»å‹ç”¨äºå®é™…ä¼ é€’ç»™routerçš„å‚æ•°
type RouterParamsObject = Record<string, string | number | boolean>;



@Entry
@Component
struct FocusTimer {
  @State timerDuration: number = 25 * 60; // é»˜è®¤25åˆ†é’Ÿ
  @State remainingTime: number = 25 * 60;
  @State isRunning: boolean = false;
  @State isPaused: boolean = false;
  @State currentTask: string = '';
  @State showTaskDialog: boolean = false;
  @State showSoundSelector: boolean = false;
  @State selectedSound: string = 'forest';
  @State currentTheme: ThemeConfig = DEFAULT_THEME_CONFIG;
  @State showNextTaskDialog: boolean = false;
  @State showEarlyCompleteDialog: boolean = false;
  @State nextTaskName: string = '';
  @State isSequence: boolean = false;
  @State collectionId: string = '';
  @State subTaskId: string = '';
  @State currentSubTaskIndex: number = 0;
  @State totalSubTasksInCollection: number = 0;
  @State nextTaskItem: NextTaskItem = {
    id: 0,
    title: '',
    isCompleted: false,
    orderIndex: 0,
    collectionId: 0,
    createTime: ''
  };
  private intervalId: number = -1;
  private apiService = ApiService.getInstance();
  private audioPlayer = AudioPlayer;
  private themeService = ThemeService.getInstance();
  private themeChangeListener = async () => {
    try {
      this.currentTheme = await this.themeService.getCurrentTheme();
    } catch (error) {
      console.error('FocusTimerä¸»é¢˜æ›´æ–°å¤±è´¥:', error);
    }
  };

  async aboutToAppear() {
    this.themeService.addThemeChangeListener(this.themeChangeListener);
    // é¦–å…ˆåŠ è½½ä¿å­˜çš„ä¸»é¢˜åå¥½è®¾ç½®
    await this.themeService.loadThemePreference();
    this.currentTheme = await this.themeService.getCurrentTheme();

    const params = router.getParams() as FocusTimerRouterParams;
    if (params) {
      this.timerDuration = params.time || 25 * 60;
      this.remainingTime = params.time || 25 * 60;
      this.currentTask = params.taskTitle || params.title || 'ä¸“æ³¨ä»»åŠ¡';
      this.isSequence = params.isSequence || false;
      this.collectionId = String(params.collectionId || '');
      this.subTaskId = String(params.subTaskId || '');
      this.currentSubTaskIndex = params.currentSubTaskIndex || 0;
      this.totalSubTasksInCollection = params.totalSubTasksInCollection || 0;
    }
  }

  aboutToDisappear() {
    this.themeService.removeThemeChangeListener(this.themeChangeListener);
    this.stopTimer();
    this.audioPlayer.stopBackgroundSound();
  }

  startTimer() {
    if (!this.isRunning && !this.isPaused) {
      this.isRunning = true;
      this.intervalId = setInterval(() => {
        if (this.remainingTime > 0) {
          this.remainingTime--;
        } else {
          this.completeTimer();
        }
      }, 1000);
    } else if (this.isPaused) {
      this.isPaused = false;
      this.isRunning = true;
      this.intervalId = setInterval(() => {
        if (this.remainingTime > 0) {
          this.remainingTime--;
        } else {
          this.completeTimer();
        }
      }, 1000);
    }
  }

  pauseTimer() {
    this.isPaused = true;
    this.isRunning = false;
    clearInterval(this.intervalId);
  }

  stopTimer() {
    this.isRunning = false;
    this.isPaused = false;
    clearInterval(this.intervalId);
    this.remainingTime = this.timerDuration;
  }

  // æå‰å®ŒæˆåŠŸèƒ½
  showEarlyCompleteConfirm() {
    this.showEarlyCompleteDialog = true;
  }

  async earlyComplete() {
    this.showEarlyCompleteDialog = false;
    await this.completeTimer(true);
  }

  async completeTimer(isEarlyComplete: boolean = false) {
    this.stopTimer();

    // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
    try {
      this.audioPlayer.playCompletionSound();
    } catch (error) {
      console.error('æ’­æ”¾å®ŒæˆéŸ³æ•ˆå¤±è´¥:', error);
    }

    // è®°å½•ä¸“æ³¨ä¼šè¯
    try {
      const actualDuration = isEarlyComplete ?
      Math.floor((this.timerDuration - this.remainingTime) / 60) :
      Math.floor(this.timerDuration / 60);

      await this.apiService.createFocusSession({
        durationMinutes: actualDuration,
        startTime: new Date(Date.now() - (this.timerDuration - this.remainingTime) * 1000).toISOString(),
        endTime: new Date().toISOString(),
        taskDescription: this.currentTask
      });

      // å¦‚æœæ˜¯åˆé›†ä¸­çš„ä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€
      if (this.isSequence && this.collectionId && this.subTaskId) {
        const collectionIdNum = parseInt(this.collectionId);
        const subTaskIdNum = parseInt(this.subTaskId);
        await this.apiService.toggleCollectionItemStatus(collectionIdNum, subTaskIdNum);

        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªä»»åŠ¡
        if (this.currentSubTaskIndex < this.totalSubTasksInCollection - 1) {
          this.showNextTaskDialog = true;
          return;
        }
      }
    } catch (error) {
      console.error('å®Œæˆè®¡æ—¶å™¨æ—¶å‡ºé”™:', error);
    }

    const message = isEarlyComplete ? 'æå‰å®Œæˆä¸“æ³¨ï¼ğŸ‰' : 'ä¸“æ³¨å®Œæˆï¼';
    promptAction.showToast({ message: message });
    setTimeout(() => {
      router.back();
    }, 2000);
  }

  formatTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) {
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString()
        .padStart(2, '0')}`;
    } else {
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
  }

  getProgress(): number {
    return ((this.timerDuration - this.remainingTime) / this.timerDuration) * 100;
  }

  // éŸ³æ•ˆé€‰é¡¹æ•°æ®
  private getSoundOptions(): SoundOption[] {
    return [
      { name: 'æ£®æ—', file: 'forest', icon: 'ğŸŒ²' },
      { name: 'é›¨å£°', file: 'rain', icon: 'ğŸŒ§ï¸' },
      { name: 'æµ·æµª', file: 'waves', icon: 'ğŸŒŠ' },
      { name: 'å†¥æƒ³', file: 'meditation', icon: 'ğŸ§˜' },
      { name: 'é’¢ç´', file: 'piano', icon: 'ğŸ¹' },
      { name: 'ç™½å™ªéŸ³', file: 'whitenoise', icon: 'ğŸ”Š' }
    ];
  }

  async selectSound(soundFile: string) {
    this.selectedSound = soundFile;
    this.showSoundSelector = false;

    const soundName = this.getSoundOptions().find(s => s.file === soundFile)?.name || 'æœªçŸ¥éŸ³æ•ˆ';

    try {
      // ç«‹å³æ’­æ”¾é€‰ä¸­çš„éŸ³æ•ˆ - ä½¿ç”¨é¸¿è’™éŸ³é¢‘æ’­æ”¾
      console.info(`ç”¨æˆ·é€‰æ‹©éŸ³æ•ˆ: ${soundName} (${soundFile})`);

      // å¼‚æ­¥æ’­æ”¾ï¼Œä¸é˜»å¡UI
      this.audioPlayer.playBackgroundSound(soundFile).then(() => {
        console.info(`éŸ³æ•ˆæ’­æ”¾æˆåŠŸ: ${soundName}`);
      }).catch((error: Error) => {
        console.warn(`éŸ³æ•ˆæ’­æ”¾å¤±è´¥: ${soundName}`, error);
      });

      // ç«‹å³æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸçš„æç¤º
      promptAction.showToast({ message: `å·²åˆ‡æ¢åˆ°${soundName}éŸ³æ•ˆ` });
      console.info(`éŸ³æ•ˆåˆ‡æ¢å®Œæˆ: ${soundName} (${soundFile})`);
    } catch (error) {
      console.error('åˆ‡æ¢éŸ³æ•ˆå¤±è´¥:', error);
      promptAction.showToast({ message: `å·²é€‰æ‹©${soundName}éŸ³æ•ˆ` });
    }
  }

  // å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡
  startNextTask() {
    console.info('å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡');
    // é‡ç½®è®¡æ—¶å™¨çŠ¶æ€ï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡
    this.currentSubTaskIndex++;
    this.remainingTime = this.timerDuration;
    
    // æ¨¡æ‹Ÿä»APIè·å–ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
    router.back({
      url: 'pages/TodoDetail',
      params: {
        action: 'taskCompleted',
        collectionId: this.collectionId,
        subTaskId: this.subTaskId,
        currentSubTaskIndex: this.currentSubTaskIndex
      }
    });
  }

  // å–æ¶ˆåºåˆ—
  cancelSequence() {
    console.info('å–æ¶ˆåºåˆ—');
    router.back({
      url: 'pages/TodoDetail',
      params: {
        action: 'sequenceAborted',
        collectionId: this.collectionId,
        subTaskId: this.subTaskId
      }
    });
  }

  // è‹¹æœé£æ ¼çš„éŸ³æ•ˆé€‰æ‹©å™¨
  @Builder
  SoundSelector() {
    Column() {
      Text('é€‰æ‹©ä¸“æ³¨éŸ³æ•ˆ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.textColor)
        .margin({ bottom: 24 })

      Grid() {
        ForEach(this.getSoundOptions(), (sound: SoundOption) => {
          GridItem() {
            Column() {
              Text(sound.icon)
                .fontSize(32)
                .margin({ bottom: 8 })
              Text(sound.name)
                .fontSize(14)
                .fontColor(this.selectedSound === sound.file ? '#FFFFFF' : this.currentTheme.textColor)
                .fontWeight(this.selectedSound === sound.file ? FontWeight.Bold : FontWeight.Medium)
                .textShadow(this.selectedSound === sound.file ? {
                  radius: 4,
                  color: '#00000040',
                  offsetX: 0,
                  offsetY: 1
                } : undefined)
            }
            .width('100%')
            .height(80)
            .linearGradient(this.selectedSound === sound.file ? {
              angle: 135,
              colors: [
                [this.currentTheme.glassmorphism.accentPrimary, 0.0],
                [this.currentTheme.glassmorphism.accentSecondary, 0.5],
                [this.currentTheme.glassmorphism.accentTertiary, 1.0]
              ]
            } : {
              angle: 135,
              colors: [
                [this.currentTheme.glassmorphism.surfaceLight, 0.0],
                [this.currentTheme.glassmorphism.surfaceMedium, 1.0]
              ]
            })
            .borderRadius(16)
            .border({
              width: this.selectedSound === sound.file ? 2 : 1,
              color: this.selectedSound === sound.file ?
              this.currentTheme.glassmorphism.accentPrimary :
              this.currentTheme.glassmorphism.borderLight
            })
            .shadow({
              radius: this.selectedSound === sound.file ? 12 : 6,
              color: this.selectedSound === sound.file ?
                this.currentTheme.glassmorphism.accentPrimary + '40' :
              this.currentTheme.glassmorphism.shadowSoft,
              offsetX: 0,
              offsetY: this.selectedSound === sound.file ? 4 : 2
            })
            .blur(this.selectedSound === sound.file ? 0.4 : 0.2) // å“‘å…‰æ•ˆæœ
            .justifyContent(FlexAlign.Center)
            .onClick(async () => {
              // æ·»åŠ è§¦è§‰åé¦ˆ
              try {
                await this.selectSound(sound.file);
              } catch (error) {
                console.error('é€‰æ‹©éŸ³æ•ˆå¤±è´¥:', error);
              }
            })
          }
        }, (sound: SoundOption) => sound.file)
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsGap(12)
      .columnsGap(12)
      .height(200)

      Button('å–æ¶ˆ')
        .width('100%')
        .height(44)
        .fontSize(16)
        .fontColor(this.currentTheme.textColor)
        .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
        .borderRadius(22)
        .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
        .margin({ top: 24 })
        .onClick(() => {
          this.showSoundSelector = false;
        })
    }
    .width(320)
    .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
    .borderRadius(20)
    .padding(24)
    .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
    .shadow({
      radius: 24,
      color: this.currentTheme.glassmorphism.shadowStrong,
      offsetX: 0,
      offsetY: 12
    })
  }



  // æå‰å®Œæˆç¡®è®¤å¯¹è¯æ¡†
  @Builder
  EarlyCompleteDialog() {
    Column() {
      Text('ğŸ†')
        .fontSize(48)
        .margin({ bottom: 20 })

      Text('æå‰å®Œæˆä¸“æ³¨ï¼Ÿ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.textColor)
        .margin({ bottom: 8 })

      Text(`å·²ä¸“æ³¨ ${this.formatTime(this.timerDuration - this.remainingTime)}`)
        .fontSize(16)
        .fontColor(this.currentTheme.glassmorphism.accentPrimary)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 8 })

      Text('ç¡®è®¤è¦ç»“æŸå½“å‰ä¸“æ³¨å—ï¼Ÿ')
        .fontSize(14)
        .fontColor(this.currentTheme.textColor)
        .opacity(0.6)
        .textAlign(TextAlign.Center)
        .margin({ bottom: 32 })

      Row({ space: 12 }) {
        Button('ç»§ç»­ä¸“æ³¨')
          .layoutWeight(1)
          .height(44)
          .fontSize(16)
          .fontColor(this.currentTheme.textColor)
          .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
          .borderRadius(22)
          .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
          .onClick(() => {
            this.showEarlyCompleteDialog = false;
          })

        Button('å®Œæˆ')
          .layoutWeight(1)
          .height(44)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .backgroundColor(this.currentTheme.glassmorphism.accentPrimary)
          .borderRadius(22)
          .onClick(() => {
            this.earlyComplete();
          })
      }
      .width('100%')
    }
    .width('300vp')
    .backgroundColor(this.currentTheme.glassmorphism.surfaceLight)
    .borderRadius(20)
    .padding(24)
    .border({ width: 1, color: this.currentTheme.glassmorphism.borderLight })
    .shadow({
      radius: 24,
      color: this.currentTheme.glassmorphism.shadowStrong,
      offsetX: 0,
      offsetY: 12
    })
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Button() {
            Text('â†')
              .fontSize(24)
              .fontColor(this.currentTheme.textColor)
          }
          .width(44)
          .height(44)
          .backgroundColor('transparent')
          .onClick(() => {
            if (this.isRunning) {
              // å¦‚æœæ­£åœ¨è¿è¡Œï¼Œæ˜¾ç¤ºæå‰å®Œæˆå¯¹è¯æ¡†
              this.showEarlyCompleteConfirm();
            } else {
              router.back();
            }
          })

          Text('ä¸“æ³¨è®¡æ—¶')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.textColor)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Button() {
            Text('ğŸ”Š')
              .fontSize(20)
          }
          .width(44)
          .height(44)
          .backgroundColor('transparent')
          .onClick(() => {
            this.showSoundSelector = true;
          })
        }
        .width('100%')
        .height(60)
        .padding({ left: 20, right: 20 })

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Column() {
          // ä»»åŠ¡åç§°
          Text(this.currentTask)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.textColor)
            .textAlign(TextAlign.Center)
            .margin({ bottom: 40 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // åœ†å½¢è¿›åº¦ç¯
          Stack() {
            // èƒŒæ™¯åœ†ç¯
            Circle({ width: 280, height: 280 })
              .fill('transparent')
              .stroke(this.currentTheme.glassmorphism.borderLight)
              .strokeWidth(8)

            // è¿›åº¦åœ†ç¯
            Circle({ width: 280, height: 280 })
              .fill('transparent')
              .stroke(this.currentTheme.glassmorphism.accentPrimary)
              .strokeWidth(8)
              .strokeDashArray([this.getProgress() * 8.8, 880])
              .rotate({ angle: -90 })

            // ä¸­å¿ƒæ—¶é—´æ˜¾ç¤º
            Column() {
              Text(this.formatTime(this.remainingTime))
                .fontSize(48)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.currentTheme.textColor)
                .margin({ bottom: 8 })

              Text(this.isRunning ? 'ä¸“æ³¨ä¸­...' : (this.isPaused ? 'å·²æš‚åœ' : 'å‡†å¤‡å¼€å§‹'))
                .fontSize(16)
                .fontColor(this.currentTheme.textColor)
                .opacity(0.6)
            }
            .justifyContent(FlexAlign.Center)
          }
          .margin({ bottom: 60 })
          .onClick(() => {
            // ç‚¹å‡»åœ†å½¢åŒºåŸŸä¹Ÿå¯ä»¥æ˜¾ç¤ºæå‰å®Œæˆ
            if (this.isRunning) {
              this.showEarlyCompleteConfirm();
            }
          })

          // æ§åˆ¶æŒ‰é’®
          Row({ space: 20 }) {
            if (!this.isRunning && !this.isPaused) {
              // å¼€å§‹æŒ‰é’®
              Button() {
                Row() {
                  Text('â–¶ï¸')
                    .fontSize(20)
                    .margin({ right: 8 })
                  Text('å¼€å§‹ä¸“æ³¨')
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                }
              }
              .width(160)
              .height(56)
              .backgroundColor(this.currentTheme.glassmorphism.accentPrimary)
              .borderRadius(28)
              .fontColor('#FFFFFF')
              .shadow({
                radius: 12,
                color: this.currentTheme.glassmorphism.accentPrimary + '40',
                offsetX: 0,
                offsetY: 6
              })
              .onClick(() => {
                this.startTimer();
                this.audioPlayer.playBackgroundSound(this.selectedSound);
              })
            } else {
              // æš‚åœ/ç»§ç»­æŒ‰é’®
              Button() {
                Row() {
                  Text(this.isRunning ? 'â¸ï¸' : 'â–¶ï¸')
                    .fontSize(20)
                    .margin({ right: 8 })
                  Text(this.isRunning ? 'æš‚åœ' : 'ç»§ç»­')
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                }
              }
              .width(120)
              .height(56)
              .backgroundColor(this.currentTheme.glassmorphism.accentSecondary)
              .borderRadius(28)
              .fontColor('#FFFFFF')
              .onClick(() => {
                if (this.isRunning) {
                  this.pauseTimer();
                  this.audioPlayer.stopBackgroundSound();
                } else {
                  this.startTimer();
                  this.audioPlayer.playBackgroundSound(this.selectedSound);
                }
              })

              // æå‰å®ŒæˆæŒ‰é’®
              Button() {
                Row() {
                  Text('ğŸ†')
                    .fontSize(20)
                    .margin({ right: 8 })
                  Text('å®Œæˆ')
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                }
              }
              .width(120)
              .height(56)
              .backgroundColor(this.currentTheme.glassmorphism.accentTertiary)
              .borderRadius(28)
              .fontColor('#FFFFFF')
              .onClick(() => {
                this.showEarlyCompleteConfirm();
              })
            }
          }
          .justifyContent(FlexAlign.Center)

          // å½“å‰éŸ³æ•ˆæ˜¾ç¤º
          Row() {
            Text('ğŸµ')
              .fontSize(16)
              .margin({ right: 8 })
            Text(`å½“å‰éŸ³æ•ˆ: ${this.getSoundOptions().find(s => s.file === this.selectedSound)?.name || 'æ£®æ—'}`)
              .fontSize(14)
              .fontColor(this.currentTheme.textColor)
              .opacity(0.6)
          }
          .margin({ top: 40 })
          .onClick(() => {
            this.showSoundSelector = true;
          })
        }
        .layoutWeight(1)
        .padding({ left: 20, right: 20 })
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.currentTheme.backgroundColor)

      // éŸ³æ•ˆé€‰æ‹©å™¨å¯¹è¯æ¡†
      if (this.showSoundSelector) {
        Column() {
          this.SoundSelector()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showSoundSelector = false;
        })
      }

      // ä¸‹ä¸€ä¸ªä»»åŠ¡å¯¹è¯æ¡†
      if (this.showNextTaskDialog) {
        NextTaskDialog({
          nextItem: this.nextTaskItem,
          nextIndex: this.currentSubTaskIndex + 1,
          actualTotalTasks: this.totalSubTasksInCollection,
          onStart: () => {
            this.showNextTaskDialog = false;
            this.startNextTask();
          },
          onCancel: () => {
            this.showNextTaskDialog = false;
            this.cancelSequence();
          }
        })
      }

      // æå‰å®Œæˆç¡®è®¤å¯¹è¯æ¡†
      if (this.showEarlyCompleteDialog) {
        Column() {
          this.EarlyCompleteDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showEarlyCompleteDialog = false;
        })
      }
    }
  }
}

